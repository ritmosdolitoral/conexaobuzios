<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Oportunidades - Conexão Búzios</title>
    <meta name="description" content="Dashboard inteligente para análise de leads qualificados em Búzios">
    <meta name="theme-color" content="#0f172a">
    
    <!-- Preloads para performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://unpkg.com">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- Scripts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'inter': ['Inter', 'system-ui', 'sans-serif'],
                        'mono': ['JetBrains Mono', 'ui-monospace', 'monospace']
                    },
                    colors: {
                        'slate': {
                            850: '#1e293b',
                            950: '#020617'
                        }
                    },
                    animation: {
                        'fade-in': 'fade-in 0.5s ease-out forwards',
                        'slide-up': 'slide-up 0.6s ease-out forwards',
                        'scale-in': 'scale-in 0.4s ease-out forwards',
                        'shimmer': 'shimmer 2s infinite',
                        'pulse-soft': 'pulse-soft 2s infinite',
                        'bounce-gentle': 'bounce-gentle 1s ease-in-out infinite'
                    },
                    backdropBlur: {
                        'xs': '2px'
                    }
                }
            }
        }
    </script>
    
    <style>
        :root {
            --bg-primary: #020617;
            --bg-secondary: #0f172a;
            --bg-tertiary: #1e293b;
            --glass-bg: rgba(30, 41, 59, 0.6);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #64748b;
            --accent-blue: #3b82f6;
            --accent-emerald: #10b981;
            --accent-amber: #f59e0b;
            --shadow-glow: 0 0 40px rgba(59, 130, 246, 0.12);
        }

        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 40%, var(--bg-primary) 100%);
            background-attachment: fixed;
            color: var(--text-primary);
            scroll-behavior: smooth;
            overflow-x: hidden;
        }

        /* === GLASS MORPHISM === */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.12),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.02);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.06);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .glass-card:hover {
            background: rgba(255, 255, 255, 0.04);
            border-color: var(--accent-blue);
            transform: translateY(-4px);
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.15),
                0 0 20px rgba(59, 130, 246, 0.1);
        }

        /* === ANIMATIONS === */
        @keyframes fade-in {
            from { 
                opacity: 0; 
                transform: translateY(20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        @keyframes slide-up {
            from { 
                opacity: 0; 
                transform: translateY(30px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        @keyframes scale-in {
            from { 
                opacity: 0; 
                transform: scale(0.95); 
            }
            to { 
                opacity: 1; 
                transform: scale(1); 
            }
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        @keyframes pulse-soft {
            0%, 100% { 
                opacity: 1; 
                transform: scale(1); 
            }
            50% { 
                opacity: 0.8; 
                transform: scale(1.05); 
            }
        }

        @keyframes bounce-gentle {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }

        /* === COMPONENTS === */
        .stat-card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(59, 130, 246, 0.05) 100%);
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .lead-card {
            position: relative;
            overflow: hidden;
            will-change: transform;
        }

        .lead-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.03), transparent);
            transition: left 0.6s ease;
            z-index: 1;
        }

        .lead-card:hover::before {
            left: 100%;
        }

        .avatar-ring {
            background: linear-gradient(135deg, var(--accent-blue) 0%, #60a5fa 100%);
            box-shadow: 
                0 0 20px rgba(59, 130, 246, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .status-badge {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            position: relative;
            overflow: hidden;
        }

        .status-novo {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(59, 130, 246, 0.1) 100%);
            color: #93c5fd;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .status-contato {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, rgba(245, 158, 11, 0.1) 100%);
            color: #fcd34d;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .status-proposta {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(16, 185, 129, 0.1) 100%);
            color: #6ee7b7;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .status-negociacao {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.15) 0%, rgba(139, 92, 246, 0.1) 100%);
            color: #c4b5fd;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .filter-button {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            color: var(--text-muted);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .filter-button.active {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(59, 130, 246, 0.1) 100%);
            border-color: rgba(59, 130, 246, 0.3);
            color: var(--text-primary);
        }

        .filter-button:hover:not(.active) {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(255, 255, 255, 0.12);
            color: var(--text-secondary);
        }

        .action-button {
            background: linear-gradient(135deg, var(--accent-blue) 0%, #60a5fa 100%);
            border: 1px solid rgba(59, 130, 246, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .action-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .action-button:hover::before {
            left: 100%;
        }

        .action-button:hover {
            background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
            transform: translateY(-2px);
            box-shadow: 
                0 8px 25px rgba(59, 130, 246, 0.25),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .whatsapp-button {
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .whatsapp-button:hover {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.25);
        }

        .modal-overlay {
            background: rgba(2, 6, 23, 0.8);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            transform: scale(0.95) translateY(20px);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .modal-overlay.active .modal-content {
            transform: scale(1) translateY(0);
        }

        .loading-spinner {
            border: 3px solid var(--bg-tertiary);
            border-top-color: var(--accent-blue);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* === SCROLLBARS === */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #475569 0%, #64748b 100%);
            border-radius: 4px;
            transition: background 0.2s ease;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #64748b 0%, #94a3b8 100%);
        }

        /* === UTILITIES === */
        .animate-fade-in {
            animation: fade-in 0.5s ease-out forwards;
        }

        .animate-slide-up {
            animation: slide-up 0.6s ease-out forwards;
        }

        .animate-scale-in {
            animation: scale-in 0.4s ease-out forwards;
        }

        .disabled-state {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .text-gradient {
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--text-secondary) 100%);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* === RESPONSIVE === */
        @media (max-width: 768px) {
            .glass-panel {
                border-radius: 16px;
                margin: 8px;
            }
            
            .lead-card {
                border-radius: 12px;
            }
            
            .modal-content {
                margin: 16px;
                border-radius: 16px;
            }
        }

        /* === FOCUS STYLES === */
        *:focus-visible {
            outline: 2px solid var(--accent-blue);
            outline-offset: 2px;
        }

        button:focus-visible {
            outline: 2px solid var(--accent-blue);
            outline-offset: 2px;
        }

        /* === PERFORMANCE === */
        .lead-card,
        .filter-button,
        .action-button {
            will-change: transform;
        }
    </style>
</head>

<body class="min-h-screen">
    <!-- Main Container -->
    <div class="container mx-auto max-w-screen-2xl p-4 sm:p-6 lg:p-8">
        <!-- Header Section -->
        <header class="text-center mb-8 space-y-4">
            <div class="animate-fade-in">
                <h1 class="text-4xl sm:text-5xl lg:text-6xl font-black text-gradient mb-4">
                    Vitrine de Oportunidades
                </h1>
                <p class="text-lg sm:text-xl text-blue-400 font-medium">
                    Leads Qualificados em Tempo Real • Conexão Búzios
                </p>
            </div>
        </header>

        <!-- Info Panel -->
        <section class="mb-8 animate-slide-up" style="animation-delay: 0.1s">
            <div class="glass-panel rounded-2xl p-6 lg:p-8">
                <div class="flex items-start gap-4">
                    <div class="p-3 rounded-xl bg-amber-500/10 border border-amber-500/20">
                        <i data-lucide="lightbulb" class="w-6 h-6 text-amber-400"></i>
                    </div>
                    <div class="flex-1">
                        <h2 class="text-xl font-bold text-white mb-4 flex items-center gap-3">
                            O que é este painel?
                        </h2>
                        <div class="space-y-4 text-slate-300 leading-relaxed max-w-6xl">
                            <p class="text-base">
                                Este é um painel inteligente que apresenta 
                                <strong class="font-semibold text-blue-400">leads reais e qualificados</strong>, 
                                capturados pelo projeto Conexão Búzios. Ele serve para identificar e aproveitar 
                                oportunidades comerciais de forma visual, organizada e prática.
                            </p>
                            <p class="text-base">
                                É ideal para <strong class="font-semibold text-blue-400">profissionais de vendas, 
                                turismo, serviços, divulgadores e investidores</strong> interessados no ecossistema de Búzios. 
                                Aqui você encontra perfis de leads, seus interesses, histórico de respostas, 
                                propostas personalizadas por IA e contato direto via WhatsApp.
                            </p>
                            <p class="text-base">
                                O valor está na eficiência: ele economiza seu tempo, organiza os contatos e conecta você 
                                apenas com quem tem <strong class="font-semibold text-blue-400">intenção real</strong>. 
                                É o seu funil de vendas inteligente, funcionando 24 horas por dia.
                            </p>
                            <div class="border-t border-slate-700/50 pt-4 mt-6">
                                <p class="text-sm text-slate-400 italic">
                                    💡 Se você entendeu, viu valor e sentiu que precisa disso, a próxima pergunta 
                                    lógica é: como faço para entrar agora?
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Control Panel -->
        <div class="glass-panel rounded-2xl p-4 lg:p-6 mb-8 animate-slide-up sticky top-4 z-30" style="animation-delay: 0.2s">
            <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6">
                <!-- Filters -->
                <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4 w-full lg:w-auto">
                    <!-- Profile Filters -->
                    <div class="flex flex-wrap gap-2" id="filters-profile">
                        <button data-filter="all" class="filter-button active px-4 py-2.5 rounded-full text-sm font-medium transition-all">
                            Todos
                        </button>
                        <button data-filter="Turista" class="filter-button px-4 py-2.5 rounded-full text-sm font-medium flex items-center gap-2 transition-all">
                            <i data-lucide="sun-moon" class="w-4 h-4"></i>
                            Turistas
                        </button>
                        <button data-filter="Morador" class="filter-button px-4 py-2.5 rounded-full text-sm font-medium flex items-center gap-2 transition-all">
                            <i data-lucide="home" class="w-4 h-4"></i>
                            Moradores
                        </button>
                        <button data-filter="Divulgador" class="filter-button px-4 py-2.5 rounded-full text-sm font-medium flex items-center gap-2 transition-all">
                            <i data-lucide="megaphone" class="w-4 h-4"></i>
                            Parceiros
                        </button>
                    </div>

                    <!-- Separator -->
                    <div class="hidden sm:block w-px h-8 bg-slate-700"></div>

                    <!-- Status Filters -->
                    <div class="flex flex-wrap gap-2" id="filters-status">
                        <button data-status-filter="all" class="filter-button active px-4 py-2.5 rounded-full text-sm font-medium transition-all">
                            Todos os Status
                        </button>
                        <button data-status-filter="Novo" class="filter-button px-4 py-2.5 rounded-full text-sm font-medium transition-all">
                            Novos
                        </button>
                        <button data-status-filter="Em Contato" class="filter-button px-4 py-2.5 rounded-full text-sm font-medium transition-all">
                            Em Contato
                        </button>
                        <button data-status-filter="Proposta" class="filter-button px-4 py-2.5 rounded-full text-sm font-medium transition-all">
                            Proposta
                        </button>
                        <button data-status-filter="Negociação" class="filter-button px-4 py-2.5 rounded-full text-sm font-medium transition-all">
                            Negociação
                        </button>
                    </div>
                </div>

                <!-- Stats and Actions -->
                <div class="flex items-center gap-4">
                    <span id="dossier-count" class="text-sm font-semibold text-blue-400" aria-live="polite">
                        0 Oportunidades
                    </span>
                    <button id="refresh-btn" class="p-3 rounded-xl glass-card hover:bg-white/10 transition-all" aria-label="Atualizar dossiês">
                        <i data-lucide="refresh-cw" class="w-5 h-5 text-slate-300"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Leads Grid -->
        <main id="dossier-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-6 min-h-96"></main>
        
        <!-- Loading/Error/Empty States -->
        <div id="status-container" aria-live="assertive">
            <!-- Loading State -->
            <div id="loading-state" class="text-center py-20 hidden">
                <div class="loading-spinner w-12 h-12 rounded-full mx-auto mb-6"></div>
                <p class="text-lg font-semibold text-slate-300">Buscando oportunidades...</p>
                <p class="text-sm text-slate-500 mt-2">Analisando leads qualificados</p>
            </div>

            <!-- Error State -->
            <div id="error-state" class="text-center py-20 glass-panel rounded-2xl hidden">
                <div class="p-4 rounded-xl bg-red-500/10 border border-red-500/20 inline-block mb-6">
                    <i data-lucide="wifi-off" class="w-8 h-8 text-red-400"></i>
                </div>
                <p class="text-red-400 text-xl font-bold mb-2">⚠️ Falha na Conexão</p>
                <p class="text-slate-400">Não foi possível carregar os leads. Verifique sua conexão e tente novamente.</p>
                <button onclick="loadDossiers()" class="action-button text-white font-semibold px-6 py-3 rounded-xl mt-6">
                    Tentar Novamente
                </button>
            </div>

            <!-- Empty State -->
            <div id="empty-state" class="text-center py-20 glass-panel rounded-2xl hidden">
                <div class="p-4 rounded-xl bg-slate-500/10 border border-slate-500/20 inline-block mb-6">
                    <i data-lucide="search-x" class="w-8 h-8 text-slate-400"></i>
                </div>
                <p class="text-xl font-bold text-white mb-2">Nenhuma oportunidade encontrada</p>
                <p class="text-slate-400">Ajuste os filtros ou aguarde novos leads entrarem.</p>
            </div>
        </div>
    </div>

    <!-- Modal de Detalhes -->
    <div id="modal-overlay" class="modal-overlay fixed inset-0 flex items-center justify-center p-4 z-50" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <div id="modal-content" class="modal-content w-full max-w-7xl rounded-2xl shadow-2xl flex flex-col max-h-[95vh]">
            <!-- Modal Header -->
            <header id="modal-header" class="p-6 border-b border-slate-700/50 flex-shrink-0">
                <!-- Content will be populated by JavaScript -->
            </header>
            
            <!-- Modal Body -->
            <div id="modal-body" class="p-6 overflow-y-auto custom-scrollbar flex-1" tabindex="-1">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // === CONFIGURAÇÃO ===
        const CONFIG = {
            API_URL: "https://script.google.com/macros/s/AKfycbwHC3bAoL_c5rscJV2xbwVi9KMedM3QHbWCZ3bo64w0DbiMGOtnahL9BynJ5ADao63I/exec",
            MAX_RESULTS: 50,
            ANIMATION_STAGGER: 50,
            REFRESH_INTERVAL: 30000, // 30 segundos
            RETRY_ATTEMPTS: 3,
            RETRY_DELAY: 2000
        };

        // === ELEMENTOS DA DOM ===
        const ELEMENTS = {
            grid: document.getElementById('dossier-grid'),
            loadingState: document.getElementById('loading-state'),
            errorState: document.getElementById('error-state'),
            emptyState: document.getElementById('empty-state'),
            dossierCount: document.getElementById('dossier-count'),
            modalOverlay: document.getElementById('modal-overlay'),
            modalHeader: document.getElementById('modal-header'),
            modalBody: document.getElementById('modal-body'),
            refreshBtn: document.getElementById('refresh-btn'),
            profileFilters: document.getElementById('filters-profile'),
            statusFilters: document.getElementById('filters-status')
        };

        // === ESTADO DA APLICAÇÃO ===
        const STATE = {
            allDossiers: [],
            currentProfileFilter: 'all',
            currentStatusFilter: 'all',
            lastFocusedElement: null,
            isLoading: false,
            retryCount: 0
        };

        // === CONFIGURAÇÕES DE DADOS ===
        const LEAD_STATUSES = ['Novo', 'Em Contato', 'Proposta', 'Negociação'];
        
        const LEAD_POTENTIALS = {
            'Alto': { icon: 'zap', color: 'text-emerald-400', text: 'Alto Potencial' },
            'Médio': { icon: 'trending-up', color: 'text-amber-400', text: 'Médio Potencial' },
            'Baixo': { icon: 'minus', color: 'text-slate-500', text: 'Baixo Potencial' }
        };

        const STATUS_STYLES = {
            'Novo': { class: 'status-novo', icon: 'sparkles' },
            'Em Contato': { class: 'status-contato', icon: 'phone' },
            'Proposta': { class: 'status-proposta', icon: 'file-check' },
            'Negociação': { class: 'status-negociacao', icon: 'handshake' }
        };

        const PROFILE_ICONS = {
            'Turista': 'sun-moon',
            'Morador': 'home',
            'Divulgador': 'megaphone',
            'N/A': 'help-circle'
        };

        // === FUNÇÕES UTILITÁRIAS ===
        const Utils = {
            sanitizeHTML: (str) => {
                const temp = document.createElement('div');
                temp.textContent = str || '';
                return temp.innerHTML;
            },

            formatRelativeTime: (isoString) => {
                try {
                    const date = new Date(isoString);
                    const formatter = new Intl.RelativeTimeFormat('pt-BR', { numeric: 'auto' });
                    const diffSeconds = (date.getTime() - Date.now()) / 1000;
                    
                    const diffDays = Math.round(diffSeconds / 86400);
                    if (Math.abs(diffDays) > 1) return formatter.format(diffDays, 'day');
                    
                    const diffHours = Math.round(diffSeconds / 3600);
                    if (Math.abs(diffHours) > 1) return formatter.format(diffHours, 'hour');
                    
                    const diffMinutes = Math.round(diffSeconds / 60);
                    return formatter.format(diffMinutes, 'minute');
                } catch (e) {
                    return isoString || 'Data indisponível';
                }
            },

            getInitials: (name) => {
                if (!name || typeof name !== 'string' || name.trim().length === 0) return '?';
                const parts = name.trim().split(' ').filter(Boolean);
                if (parts.length > 1) {
                    return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
                }
                if (parts.length === 1 && parts[0].length > 1) {
                    return parts[0].substring(0, 2).toUpperCase();
                }
                return name[0].toUpperCase();
            },

            delay: (ms) => new Promise(resolve => setTimeout(resolve, ms)),

            debounce: (func, wait) => {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
        };

        // === API E DADOS ===
        const API = {
            async fetchWithRetry(payload, attempt = 1) {
                try {
                    const response = await fetch(CONFIG.API_URL, {
                        method: 'POST',
                        body: JSON.stringify(payload),
                        redirect: 'follow',
                        signal: AbortSignal.timeout(30000) // 30 second timeout
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    if (result.success === false) {
                        throw new Error(`API Error: ${result.error}`);
                    }

                    STATE.retryCount = 0; // Reset retry count on success
                    return result.data;
                } catch (error) {
                    console.error(`Fetch attempt ${attempt} failed:`, error);
                    
                    if (attempt < CONFIG.RETRY_ATTEMPTS) {
                        await Utils.delay(CONFIG.RETRY_DELAY * attempt);
                        return this.fetchWithRetry(payload, attempt + 1);
                    }
                    
                    throw error;
                }
            },

            async loadDossiers() {
                return this.fetchWithRetry({ action: 'listDossies' });
            },

            async getDossierDetails(id) {
                return this.fetchWithRetry({ action: 'getDossierContent', id });
            }
        };

        // === MANIPULAÇÃO DE DADOS ===
        const DataProcessor = {
            enrichDossier(dossier) {
                return {
                    ...dossier,
                    status: LEAD_STATUSES[Math.floor(Math.random() * LEAD_STATUSES.length)],
                    potential: Object.keys(LEAD_POTENTIALS)[Math.floor(Math.random() * Object.keys(LEAD_POTENTIALS).length)]
                };
            },

            parseDossierContent(content, baseDossier) {
                const getMatch = (regex, flags = 'm') => (content.match(new RegExp(regex, flags)) || [])[1]?.trim() || '';
                
                const getList = (regex) => {
                    const section = getMatch(regex);
                    return section ? section.split('\n')
                        .map(item => item.replace(/^[•\s*-]+/, '').trim())
                        .filter(Boolean) : [];
                };

                const getTable = (regex) => {
                    const tableContent = getMatch(regex);
                    if (!tableContent) return [];
                    
                    return tableContent.split('\n').map(line => {
                        const parts = line.split('\t');
                        if (parts.length < 2) return null;
                        return {
                            question: parts[0]?.replace('❓', '').trim() || '',
                            answer: parts[1]?.trim() || ''
                        };
                    }).filter(row => row && row.question && row.answer);
                };

                return {
                    ...baseDossier,
                    resumo: getMatch(/^Resumo do Perfil\n([\s\S]*?)(?=\n\n|$)/),
                    respostas: getTable(/HISTÓRICO DE INTERAÇÕES \(FUNIL COMPLETO\)\s*\n([\s\S]*?)(?=\n\s*💡 PROPOSTA PERSONALIZADA \(IA\)|$)/),
                    necessidades: getList(/Necessidades Reveladas\s*\n([\s\S]*?)(?=\n\n💡|$)/),
                    proposta: getMatch(/💡 PROPOSTA PERSONALIZADA \(IA\)\s*\n([\s\S]*?)(?=\n\nStatus do Lead:|$)/),
                    objecoes: [
                        "Pode ser sensível a preço devido ao orçamento informado.",
                        "Busca por experiências autênticas, pode rejeitar opções muito turísticas."
                    ]
                };
            }
        };

        // === RENDERIZAÇÃO ===
        const Renderer = {
            showLoading(show) {
                ELEMENTS.loadingState.classList.toggle('hidden', !show);
                ELEMENTS.errorState.classList.add('hidden');
                ELEMENTS.emptyState.classList.add('hidden');
                if (show) ELEMENTS.grid.innerHTML = '';
            },

            showError(show) {
                ELEMENTS.errorState.classList.toggle('hidden', !show);
                ELEMENTS.loadingState.classList.add('hidden');
                ELEMENTS.emptyState.classList.add('hidden');
                if (show) ELEMENTS.grid.innerHTML = '';
            },

            showEmpty(show) {
                ELEMENTS.emptyState.classList.toggle('hidden', !show);
                ELEMENTS.loadingState.classList.add('hidden');
                ELEMENTS.errorState.classList.add('hidden');
            },

            updateCount(count) {
                ELEMENTS.dossierCount.textContent = `${count} Oportunidade${count !== 1 ? 's' : ''}`;
            },

            renderLeadCard(dossier, index) {
                const initials = Utils.getInitials(dossier.name);
                const statusInfo = STATUS_STYLES[dossier.status] || {};
                const potentialInfo = LEAD_POTENTIALS[dossier.potential] || {};
                const profileIcon = PROFILE_ICONS[dossier.profile] || 'help-circle';

                const card = document.createElement('button');
                card.className = 'lead-card glass-card rounded-2xl p-6 text-left flex flex-col gap-4 h-full animate-fade-in';
                card.style.animationDelay = `${index * CONFIG.ANIMATION_STAGGER}ms`;
                card.dataset.id = dossier.id;

                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="avatar-ring w-14 h-14 rounded-full flex items-center justify-center text-white font-bold text-lg relative">
                            ${initials}
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="p-2 rounded-lg bg-slate-500/10 border border-slate-500/20">
                                <i data-lucide="${profileIcon}" class="w-4 h-4 text-slate-400"></i>
                            </div>
                            <span class="status-badge ${statusInfo.class}">
                                <i data-lucide="${statusInfo.icon}" class="w-3 h-3"></i>
                                ${dossier.status}
                            </span>
                        </div>
                    </div>
                    <div class="flex-grow space-y-3">
                        <div>
                            <h3 class="text-lg font-semibold text-white truncate mb-1">
                                ${Utils.sanitizeHTML(dossier.name || 'Lead Anônimo')}
                            </h3>
                            <p class="text-sm text-slate-400 line-clamp-2 min-h-[40px]">
                                ${Utils.sanitizeHTML(dossier.interest || 'Nenhum interesse principal informado')}
                            </p>
                        </div>
                    </div>
                    <div class="border-t border-slate-700/50 pt-4 flex justify-between items-center text-xs">
                        <span class="text-slate-500 font-medium">
                            ${Utils.formatRelativeTime(dossier.timestamp)}
                        </span>
                        <span class="flex items-center gap-2 font-semibold ${potentialInfo.color}">
                            <i data-lucide="${potentialInfo.icon}" class="w-4 h-4"></i>
                            ${dossier.potential}
                        </span>
                    </div>
                `;

                card.addEventListener('click', () => Modal.open(dossier));
                return card;
            },

            renderDossiers() {
                ELEMENTS.grid.innerHTML = '';
                this.showEmpty(false);

                // Filter dossiers
                const profileFiltered = STATE.currentProfileFilter === 'all' 
                    ? STATE.allDossiers 
                    : STATE.allDossiers.filter(d => d && d.profile === STATE.currentProfileFilter);

                const filteredDossiers = STATE.currentStatusFilter === 'all' 
                    ? profileFiltered 
                    : profileFiltered.filter(d => d && d.status === STATE.currentStatusFilter);

                this.updateCount(filteredDossiers.length);

                if (filteredDossiers.length === 0) {
                    this.showEmpty(true);
                    return;
                }

                // Render cards
                filteredDossiers.forEach((dossier, index) => {
                    const card = this.renderLeadCard(dossier, index);
                    ELEMENTS.grid.appendChild(card);
                });

                // Initialize Lucide icons
                lucide.createIcons();
            }
        };

        // === MODAL ===
        const Modal = {
            async open(dossier) {
                STATE.lastFocusedElement = document.activeElement;
                ELEMENTS.modalOverlay.classList.add('active');
                
                // Show loading state
                ELEMENTS.modalHeader.innerHTML = this.getLoadingHeader();
                ELEMENTS.modalBody.innerHTML = this.getLoadingBody();

                try {
                    const data = await API.getDossierDetails(dossier.id);
                    const leadDetails = DataProcessor.parseDossierContent(data.content, dossier);
                    this.renderContent(leadDetails);
                } catch (error) {
                    console.error('Failed to load dossier details:', error);
                    ELEMENTS.modalBody.innerHTML = this.getErrorBody();
                }
            },

            close() {
                ELEMENTS.modalOverlay.classList.remove('active');
                if (STATE.lastFocusedElement) {
                    STATE.lastFocusedElement.focus();
                }
            },

            getLoadingHeader() {
                return `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-full bg-slate-700 animate-pulse"></div>
                            <div class="space-y-2">
                                <div class="w-32 h-4 bg-slate-700 rounded animate-pulse"></div>
                                <div class="w-24 h-3 bg-slate-700 rounded animate-pulse"></div>
                            </div>
                        </div>
                        <button onclick="Modal.close()" class="p-2 rounded-full hover:bg-white/10 transition-colors">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                `;
            },

            getLoadingBody() {
                return `
                    <div class="flex justify-center items-center h-64">
                        <div class="text-center">
                            <div class="loading-spinner w-8 h-8 rounded-full mx-auto mb-4"></div>
                            <p class="text-slate-300">Analisando dossiê completo...</p>
                        </div>
                    </div>
                `;
            },

            getErrorBody() {
                return `
                    <div class="text-center py-12">
                        <div class="p-4 rounded-xl bg-red-500/10 border border-red-500/20 inline-block mb-4">
                            <i data-lucide="alert-circle" class="w-8 h-8 text-red-400"></i>
                        </div>
                        <p class="text-red-400 font-semibold">Não foi possível carregar os detalhes deste lead.</p>
                        <button onclick="Modal.close()" class="action-button text-white font-semibold px-6 py-3 rounded-xl mt-4">
                            Fechar
                        </button>
                    </div>
                `;
            },

            renderContent(details) {
                const telefone = (details.respostas.find(r => r.question.toLowerCase().includes('whatsapp')) || {}).answer;
                const statusInfo = STATUS_STYLES[details.status] || {};
                const potentialInfo = LEAD_POTENTIALS[details.potential] || {};

                const hasPhone = telefone && telefone.replace(/\D/g, '').length > 8;
                
                // Header
                ELEMENTS.modalHeader.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="avatar-ring w-14 h-14 rounded-full flex items-center justify-center text-white font-bold text-xl">
                                ${Utils.getInitials(details.name)}
                            </div>
                            <div>
                                <h2 id="modal-title" class="text-xl font-bold text-white mb-2">
                                    ${Utils.sanitizeHTML(details.name)}
                                </h2>
                                <div class="flex items-center gap-3 flex-wrap">
                                    <span class="status-badge ${statusInfo.class}">
                                        <i data-lucide="${statusInfo.icon}" class="w-3 h-3"></i>
                                        ${details.status}
                                    </span>
                                    <span class="status-badge bg-slate-500/10 text-slate-300 border-slate-500/20">
                                        <i data-lucide="${potentialInfo.icon}" class="w-3 h-3"></i>
                                        ${details.potential}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            ${this.getActionButtons(hasPhone, telefone, details)}
                            <button onclick="Modal.close()" class="p-2 rounded-full hover:bg-white/10 transition-colors" aria-label="Fechar modal">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                    </div>
                `;

                // Body
                ELEMENTS.modalBody.innerHTML = this.getModalBody(details);
                
                // Initialize Lucide icons
                lucide.createIcons();
            },

            getActionButtons(hasPhone, telefone, details) {
                const whatsappBtn = hasPhone
                    ? `<a href="https://wa.me/55${telefone.replace(/\D/g, '')}" target="_blank" class="whatsapp-button text-white font-semibold py-2 px-4 rounded-xl transition-all flex items-center gap-2">
                         <i data-lucide="message-circle" class="w-4 h-4"></i>
                         Conversar
                       </a>`
                    : `<button disabled class="disabled-state font-semibold py-2 px-4 rounded-xl flex items-center gap-2 bg-slate-600 text-slate-400">
                         <i data-lucide="phone-off" class="w-4 h-4"></i>
                         Sem WhatsApp
                       </button>`;

                return `
                    ${whatsappBtn}
                    <button id="copy-proposal-btn" class="action-button text-white font-semibold py-2 px-4 rounded-xl flex items-center gap-2">
                        <i data-lucide="copy" class="w-4 h-4"></i>
                        Copiar Proposta
                    </button>
                    <select onchange="Modal.updateStatus('${details.id}', this.value)" class="bg-slate-700 text-white hover:bg-slate-600 font-semibold py-2 pl-4 pr-8 rounded-xl appearance-none cursor-pointer border border-slate-600">
                        ${LEAD_STATUSES.map(s => `<option value="${s}" ${s === details.status ? 'selected' : ''}>${s}</option>`).join('')}
                    </select>
                `;
            },

            getModalBody(details) {
                const necessidadesHTML = details.necessidades.length > 0 
                    ? details.necessidades.map(need => `
                        <li class="flex items-start gap-3 py-2">
                            <i data-lucide="check-circle" class="w-5 h-5 text-emerald-400 mt-1 flex-shrink-0"></i>
                            <span class="text-slate-200">${Utils.sanitizeHTML(need)}</span>
                        </li>
                    `).join('')
                    : '<li class="text-slate-400 py-2">Nenhuma necessidade específica foi revelada pela IA.</li>';

                const objecoesHTML = details.objecoes.length > 0 
                    ? details.objecoes.map(obj => `
                        <li class="flex items-start gap-3 py-2">
                            <i data-lucide="alert-triangle" class="w-5 h-5 text-amber-400 mt-1 flex-shrink-0"></i>
                            <span class="text-slate-200">${Utils.sanitizeHTML(obj)}</span>
                        </li>
                    `).join('')
                    : '<li class="text-slate-400 py-2">Nenhuma objeção provável identificada.</li>';

                const respostasHTML = details.respostas.length > 0 
                    ? details.respostas.map(resp => `
                        <div class="py-3 border-b border-slate-700/30 last:border-b-0">
                            <dt class="text-xs text-slate-400 font-medium mb-1 uppercase tracking-wide">
                                ${Utils.sanitizeHTML(resp.question)}
                            </dt>
                            <dd class="text-slate-200 font-medium">
                                ${Utils.sanitizeHTML(resp.answer)}
                            </dd>
                        </div>
                    `).join('')
                    : '<p class="text-slate-400 py-4">Sem respostas registradas.</p>';

                const telefone = (details.respostas.find(r => r.question.toLowerCase().includes('whatsapp')) || {}).answer;

                return `
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <!-- Main Content -->
                        <div class="lg:col-span-2 space-y-6">
                            <!-- Resumo -->
                            <div class="glass-card p-6 rounded-xl">
                                <h3 class="flex items-center gap-3 text-lg font-semibold text-white mb-4">
                                    <i data-lucide="user-check" class="w-5 h-5 text-blue-400"></i>
                                    Resumo do Perfil (IA)
                                </h3>
                                <p class="text-slate-300 leading-relaxed">
                                    ${Utils.sanitizeHTML(details.resumo) || '<span class="text-slate-400">Resumo não disponível.</span>'}
                                </p>
                            </div>

                            <!-- Necessidades -->
                            <div class="glass-card p-6 rounded-xl">
                                <h3 class="flex items-center gap-3 text-lg font-semibold text-white mb-4">
                                    <i data-lucide="target" class="w-5 h-5 text-emerald-400"></i>
                                    Necessidades Reveladas (IA)
                                </h3>
                                <ul class="space-y-1">
                                    ${necessidadesHTML}
                                </ul>
                            </div>

                            <!-- Objeções -->
                            <div class="glass-card p-6 rounded-xl">
                                <h3 class="flex items-center gap-3 text-lg font-semibold text-white mb-4">
                                    <i data-lucide="shield-alert" class="w-5 h-5 text-amber-400"></i>
                                    Objeções Prováveis (IA)
                                </h3>
                                <ul class="space-y-1">
                                    ${objecoesHTML}
                                </ul>
                            </div>

                            <!-- Proposta -->
                            <div class="glass-card p-6 rounded-xl border border-blue-500/20 bg-gradient-to-br from-blue-500/5 to-transparent">
                                <h3 class="flex items-center gap-3 text-lg font-semibold text-white mb-4">
                                    <i data-lucide="sparkles" class="w-5 h-5 text-blue-400"></i>
                                    Proposta Inteligente Personalizada (IA)
                                </h3>
                                <div class="text-slate-300 leading-relaxed whitespace-pre-line">
                                    ${Utils.sanitizeHTML(details.proposta) || '<span class="text-slate-400">Proposta não disponível.</span>'}
                                </div>
                            </div>
                        </div>

                        <!-- Sidebar -->
                        <div class="space-y-6">
                            <!-- Histórico -->
                            <div class="glass-card p-6 rounded-xl">
                                <h3 class="flex items-center gap-3 text-lg font-semibold text-white mb-4">
                                    <i data-lucide="message-square-text" class="w-5 h-5 text-slate-400"></i>
                                    Histórico de Interações
                                </h3>
                                <dl class="space-y-1">
                                    ${respostasHTML}
                                </dl>
                            </div>

                            <!-- Metadados -->
                            <div class="glass-card p-6 rounded-xl">
                                <h3 class="flex items-center gap-3 text-lg font-semibold text-white mb-4">
                                    <i data-lucide="database" class="w-5 h-5 text-slate-400"></i>
                                    Dados do Lead
                                </h3>
                                <dl class="space-y-3 text-sm">
                                    <div class="flex justify-between items-center py-2 border-b border-slate-700/30">
                                        <dt class="text-slate-400">WhatsApp</dt>
                                        <dd class="font-mono text-slate-200">
                                            ${telefone ? Utils.sanitizeHTML(telefone) : 'Não informado'}
                                        </dd>
                                    </div>
                                    <div class="flex justify-between items-center py-2 border-b border-slate-700/30">
                                        <dt class="text-slate-400">Gerado em</dt>
                                        <dd class="text-slate-200">
                                            ${new Date(details.timestamp).toLocaleString('pt-BR')}
                                        </dd>
                                    </div>
                                    <div class="flex justify-between items-center py-2">
                                        <dt class="text-slate-400">Dossiê Original</dt>
                                        <dd>
                                            <a href="${details.url}" 
                                               target="_blank" 
                                               class="text-blue-400 hover:text-blue-300 transition-colors underline decoration-blue-400/30 hover:decoration-blue-300/60">
                                                Abrir
                                            </a>
                                        </dd>
                                    </div>
                                </dl>
                            </div>
                        </div>
                    </div>
                `;
            },

            updateStatus(leadId, newStatus) {
                console.log(`Lead ${leadId} status alterado para: ${newStatus}`);
                const lead = STATE.allDossiers.find(d => d.id === leadId);
                if (lead) {
                    lead.status = newStatus;
                    Renderer.renderDossiers();
                }
            }
        };

        // === UTILITÁRIOS DE INTERAÇÃO ===
        const Interactions = {
            copyToClipboard: Utils.debounce(async (text, buttonElement) => {
                if (!text || text === 'undefined') return;

                try {
                    await navigator.clipboard.writeText(text);
                    this.showCopySuccess(buttonElement);
                } catch (err) {
                    console.error('Failed to copy:', err);
                    this.fallbackCopy(text, buttonElement);
                }
            }, 300),

            fallbackCopy(text, buttonElement) {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed";
                textArea.style.top = "-9999px";
                textArea.style.left = "-9999px";
                
                document.body.appendChild(textArea);
                textArea.select();
                textArea.setSelectionRange(0, 99999);

                try {
                    const successful = document.execCommand('copy');
                    if (successful) {
                        this.showCopySuccess(buttonElement);
                    }
                } catch (err) {
                    console.error('Fallback copy failed:', err);
                }

                document.body.removeChild(textArea);
            },

            showCopySuccess(buttonElement) {
                const originalContent = buttonElement.innerHTML;
                buttonElement.innerHTML = `<i data-lucide="check" class="w-4 h-4"></i> Copiado!`;
                buttonElement.disabled = true;
                buttonElement.classList.add('disabled-state');
                
                lucide.createIcons();
                
                setTimeout(() => {
                    buttonElement.innerHTML = originalContent;
                    buttonElement.disabled = false;
                    buttonElement.classList.remove('disabled-state');
                    lucide.createIcons();
                }, 2000);
            }
        };

        // === FILTROS ===
        const Filters = {
            init() {
                // Profile filters
                ELEMENTS.profileFilters.addEventListener('click', (e) => {
                    const button = e.target.closest('button');
                    if (!button) return;

                    // Update active state
                    ELEMENTS.profileFilters.querySelectorAll('button').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    button.classList.add('active');

                    // Update filter
                    STATE.currentProfileFilter = button.dataset.filter;
                    Renderer.renderDossiers();
                });

                // Status filters
                ELEMENTS.statusFilters.addEventListener('click', (e) => {
                    const button = e.target.closest('button');
                    if (!button) return;

                    // Update active state
                    ELEMENTS.statusFilters.querySelectorAll('button').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    button.classList.add('active');

                    // Update filter
                    STATE.currentStatusFilter = button.dataset.statusFilter;
                    Renderer.renderDossiers();
                });
            }
        };

        // === MAIN APP ===
        const App = {
            async loadDossiers() {
                if (STATE.isLoading) return;
                
                STATE.isLoading = true;
                Renderer.showLoading(true);

                try {
                    const dossiersFromApi = await API.loadDossiers();
                    STATE.allDossiers = dossiersFromApi.map(DataProcessor.enrichDossier);
                    Renderer.renderDossiers();
                } catch (error) {
                    console.error('Failed to load dossiers:', error);
                    Renderer.showError(true);
                } finally {
                    STATE.isLoading = false;
                    Renderer.showLoading(false);
                }
            },

            init() {
                // Initialize Lucide icons
                lucide.createIcons();

                // Initialize filters
                Filters.init();

                // Event listeners
                ELEMENTS.refreshBtn.addEventListener('click', () => this.loadDossiers());
                
                // Modal events
                ELEMENTS.modalOverlay.addEventListener('click', (e) => {
                    if (e.target === ELEMENTS.modalOverlay) Modal.close();
                });

                // Keyboard events
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && ELEMENTS.modalOverlay.classList.contains('active')) {
                        Modal.close();
                    }
                });

                // Copy button event (delegated)
                document.addEventListener('click', (e) => {
                    if (e.target.id === 'copy-proposal-btn' || e.target.closest('#copy-proposal-btn')) {
                        const button = e.target.id === 'copy-proposal-btn' ? e.target : e.target.closest('#copy-proposal-btn');
                        const modalBody = ELEMENTS.modalBody;
                        const proposalText = modalBody.querySelector('.whitespace-pre-line')?.textContent || '';
                        Interactions.copyToClipboard(proposalText, button);
                    }
                });

                // Load initial data
                this.loadDossiers();

                // Set up auto-refresh
                setInterval(() => {
                    if (!STATE.isLoading && !ELEMENTS.modalOverlay.classList.contains('active')) {
                        this.loadDossiers();
                    }
                }, CONFIG.REFRESH_INTERVAL);
            }
        };

        // === GLOBAL FUNCTIONS (for HTML onclick handlers) ===
        window.Modal = Modal;
        window.loadDossiers = () => App.loadDossiers();

        // === INITIALIZATION ===
        document.addEventListener('DOMContentLoaded', () => {
            App.init();
        });

        // Performance monitoring
        if ('PerformanceObserver' in window) {
            const observer = new PerformanceObserver((list) => {
                list.getEntries().forEach((entry) => {
                    if (entry.entryType === 'navigation') {
                        console.log(`Page load time: ${entry.loadEventEnd - entry.loadEventStart}ms`);
                    }
                });
            });
            observer.observe({ entryTypes: ['navigation'] });
        }
    </script>
</body>
</html>
