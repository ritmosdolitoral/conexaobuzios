<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Oportunidades - Conexão Búzios</title>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://unpkg.com https://script.google.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://script.google.com; img-src 'self' data: https:;">
    <meta name="description" content="Painel de Oportunidades - Conexão Búzios. Gerencie leads qualificados e oportunidades de negócio em tempo real">
    <meta name="keywords" content="leads, oportunidades, negócios, Búzios, dashboard, gestão, vendas">
    <meta name="author" content="Conexão Búzios">
    <meta name="robots" content="index, follow">
    <meta property="og:title" content="Painel de Oportunidades - Conexão Búzios">
    <meta property="og:description" content="Gerencie leads qualificados e oportunidades de negócio em Búzios">
    <meta property="og:type" content="website">
    <link rel="dns-prefetch" href="https://fonts.googleapis.com">
    <link rel="dns-prefetch" href="https://fonts.gstatic.com">
    <link rel="dns-prefetch" href="https://unpkg.com">
    <link rel="dns-prefetch" href="https://script.google.com">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%); color: #f8fafc; }
        .hero-grid { background: radial-gradient(ellipse at center, rgba(59, 130, 246, 0.1) 0%, transparent 70%); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 1rem; backdrop-filter: blur(10px); transition: all 0.3s; }
        .hero-grid:hover { background: radial-gradient(ellipse at center, rgba(59, 130, 246, 0.15) 0%, transparent 70%); border-color: rgba(59, 130, 246, 0.4); transform: translateY(-2px); }
        .stat-card { background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 0.75rem; backdrop-filter: blur(10px); transition: all 0.3s; }
        .stat-card:hover { background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.1) 100%); border-color: rgba(255, 255, 255, 0.2); transform: translateY(-2px); }
        .filter-chip { background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 9999px; padding: 0.5rem 1rem; font-size: 0.875rem; font-weight: 500; color: #93c5fd; cursor: pointer; transition: all 0.3s; }
        .filter-chip:hover, .filter-chip.active { background: rgba(59, 130, 246, 0.2); border-color: rgba(59, 130, 246, 0.5); color: #dbeafe; }
        .dossier-card { background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 1rem; backdrop-filter: blur(10px); transition: all 0.3s; }
        .dossier-card:hover { background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.1) 100%); border-color: rgba(255, 255, 255, 0.2); transform: translateY(-2px); }
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
        .status-novo { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .status-contato { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
        .status-proposta { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        .status-fechado { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .priority-alta { border-left: 4px solid #ef4444; }
        .priority-media { border-left: 4px solid #f59e0b; }
        .priority-baixa { border-left: 4px solid #10b981; }
        .skip-link { position: absolute; top: -40px; left: 6px; background: #17a2b8; color: white; padding: 8px; text-decoration: none; border-radius: 4px; z-index: 1000; }
        .skip-link:focus { top: 6px; }
        @media (max-width: 768px) {
            .hero-grid { grid-template-columns: 1fr; }
            .stat-card { padding: 1rem; }
            .dossier-card { padding: 1rem; }
        }
    </style>
</head>
<body class="min-h-screen">
    <a href="#hero-section" class="skip-link">Pular para conteúdo principal</a>
    <a href="#filters-section" class="skip-link">Pular para filtros</a>
    <a href="#dossier-grid" class="skip-link">Pular para lista de oportunidades</a>
    
    <div class="container">
        <header class="relative py-8 text-center" id="hero-section">
            <h1 class="text-4xl font-bold text-white mb-2">Painel de Oportunidades</h1>
            <p class="text-xl text-blue-200">Conexão Búzios - Dashboard de Leads</p>
            <div class="absolute top-4 right-4">
                <div class="flex items-center space-x-2 bg-black/20 px-3 py-1 rounded-full">
                    <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                    <span class="text-sm text-green-400">Online</span>
                </div>
            </div>
        </header>

        <section class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8">
            <div class="stat-card p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-400">Total de Leads</p>
                        <p class="text-2xl font-bold text-white" id="total-leads">0</p>
                    </div>
                    <div class="p-3 bg-blue-500/20 rounded-lg">
                        <i data-lucide="users" class="w-6 h-6 text-blue-400"></i>
                    </div>
                </div>
            </div>
            <div class="stat-card p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-400">Novos Hoje</p>
                        <p class="text-2xl font-bold text-white" id="novos-hoje">0</p>
                    </div>
                    <div class="p-3 bg-green-500/20 rounded-lg">
                        <i data-lucide="trending-up" class="w-6 h-6 text-green-400"></i>
                    </div>
                </div>
            </div>
            <div class="stat-card p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-400">Em Andamento</p>
                        <p class="text-2xl font-bold text-white" id="em-andamento">0</p>
                    </div>
                    <div class="p-3 bg-yellow-500/20 rounded-lg">
                        <i data-lucide="clock" class="w-6 h-6 text-yellow-400"></i>
                    </div>
                </div>
            </div>
            <div class="stat-card p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-400">Convertidos</p>
                        <p class="text-2xl font-bold text-white" id="convertidos">0</p>
                    </div>
                    <div class="p-3 bg-purple-500/20 rounded-lg">
                        <i data-lucide="check-circle" class="w-6 h-6 text-purple-400"></i>
                    </div>
                </div>
            </div>
        </section>

        <section class="mb-8" id="filters-section">
            <div class="hero-grid p-6">
                <h2 class="text-xl font-semibold text-white mb-4">Filtros e Busca</h2>
                <div class="flex flex-wrap gap-4 mb-6">
                    <input type="text" id="search-input" placeholder="Buscar por nome, telefone ou interesse..." class="flex-1 min-w-64 px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <button onclick="clearFilters()" class="px-6 py-3 bg-gray-600/50 text-white rounded-lg hover:bg-gray-600/70 transition-colors">
                        <i data-lucide="x" class="w-4 h-4 mr-2 inline"></i>Limpar
                    </button>
                    <button onclick="refreshData()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        <i data-lucide="refresh-cw" class="w-4 h-4 mr-2 inline"></i>Atualizar
                    </button>
                </div>
                <div class="flex flex-wrap gap-3">
                    <div class="filter-chip active" data-filter="todos">Todos</div>
                    <div class="filter-chip" data-filter="turista">Turistas</div>
                    <div class="filter-chip" data-filter="morador">Moradores</div>
                    <div class="filter-chip" data-filter="divulgador">Divulgadores</div>
                    <div class="filter-chip" data-filter="hoje">Hoje</div>
                    <div class="filter-chip" data-filter="semana">Esta Semana</div>
                    <div class="filter-chip" data-filter="alta-prioridade">Alta Prioridade</div>
                </div>
            </div>
        </section>

        <section class="mb-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-white">Oportunidades</h2>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-400">Ordenar por:</span>
                    <select id="sort-select" class="bg-white/10 border border-white/20 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="data">Data (Mais Recente)</option>
                        <option value="nome">Nome (A-Z)</option>
                        <option value="perfil">Perfil</option>
                        <option value="prioridade">Prioridade</option>
                    </select>
                </div>
            </div>
            <div id="dossier-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            <div id="loading" class="text-center py-8 hidden">
                <div class="inline-flex items-center space-x-2">
                    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-400"></div>
                    <span class="text-gray-400">Carregando oportunidades...</span>
                </div>
            </div>
            <div id="no-results" class="text-center py-8 hidden">
                <i data-lucide="search" class="w-12 h-12 text-gray-500 mx-auto mb-4"></i>
                <p class="text-gray-400">Nenhuma oportunidade encontrada</p>
            </div>
        </section>
    </div>

    <script>
        let allDossiers = [];
        let filteredDossiers = [];
        let currentFilters = { profile: 'todos', timeRange: '', search: '', priority: '' };
        
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwHC3bAoL_c5rscJV2xbwVi9KMedM3QHbWCZ3bo64w0DbiMGOtnahL9BynJ5ADao63I/exec";

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        }

        function getProfileIcon(perfil) {
            const icons = { 'turista': '🏖️', 'morador': '🏠', 'divulgador': '📢' };
            return icons[perfil?.toLowerCase()] || '👤';
        }

        function getStatusBadge(status) {
            const statusMap = {
                'novo': { class: 'status-novo', text: 'Novo' },
                'contato': { class: 'status-contato', text: 'Contato' },
                'proposta': { class: 'status-proposta', text: 'Proposta' },
                'fechado': { class: 'status-fechado', text: 'Fechado' }
            };
            const statusInfo = statusMap[status] || { class: 'status-novo', text: 'Novo' };
            return `<span class="status-badge ${statusInfo.class}">${statusInfo.text}</span>`;
        }

        function getPriorityClass(perfil, historico) {
            const urgentKeywords = ['urgente', 'rápido', 'hoje', 'agora'];
            const hasUrgency = historico?.some(item => urgentKeywords.some(keyword => item.resposta?.toLowerCase().includes(keyword)));
            
            if (hasUrgency || perfil === 'divulgador') return 'priority-alta';
            if (perfil === 'turista') return 'priority-media';
            return 'priority-baixa';
        }

        function renderDossier(dossier) {
            const priorityClass = getPriorityClass(dossier.perfil, dossier.historico);
            const profileIcon = getProfileIcon(dossier.perfil);
            const statusBadge = getStatusBadge(dossier.status || 'novo');
            
            const interests = dossier.historico?.map(item => item.resposta).join(', ').substring(0, 100) || 'Não informado';
            const phone = dossier.telefone || 'Não informado';
            const whatsappLink = phone !== 'Não informado' ? `https://wa.me/55${phone.replace(/\D/g, '')}` : '#';
            
            return `
                <div class="dossier-card p-6 ${priorityClass}">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center space-x-3">
                            <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-xl">
                                ${profileIcon}
                            </div>
                            <div>
                                <h3 class="font-semibold text-white text-lg">${dossier.nome || 'Nome não informado'}</h3>
                                <p class="text-sm text-gray-400 capitalize">${dossier.perfil || 'Perfil não informado'}</p>
                            </div>
                        </div>
                        ${statusBadge}
                    </div>
                    
                    <div class="space-y-3">
                        <div class="flex items-center space-x-2 text-sm">
                            <i data-lucide="phone" class="w-4 h-4 text-gray-400"></i>
                            <span class="text-gray-300">${phone}</span>
                        </div>
                        <div class="flex items-start space-x-2 text-sm">
                            <i data-lucide="message-square" class="w-4 h-4 text-gray-400 mt-0.5"></i>
                            <span class="text-gray-300 line-clamp-2">${interests}</span>
                        </div>
                        <div class="flex items-center space-x-2 text-sm">
                            <i data-lucide="calendar" class="w-4 h-4 text-gray-400"></i>
                            <span class="text-gray-400">${formatDate(dossier.timestamp || new Date())}</span>
                        </div>
                    </div>
                    
                    <div class="flex space-x-2 mt-6">
                        ${phone !== 'Não informado' ? 
                            `<a href="${whatsappLink}" target="_blank" class="flex-1 bg-green-600 hover:bg-green-700 text-white text-center py-2 px-4 rounded-lg transition-colors text-sm font-medium">
                                <i data-lucide="message-circle" class="w-4 h-4 mr-2 inline"></i>WhatsApp
                            </a>` : ''
                        }
                        <button onclick="viewDossier('${dossier.id}')" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg transition-colors text-sm font-medium">
                            <i data-lucide="eye" class="w-4 h-4 mr-2 inline"></i>Detalhes
                        </button>
                    </div>
                </div>
            `;
        }

        function updateStats() {
            const total = allDossiers.length;
            const hoje = allDossiers.filter(d => {
                const today = new Date().toDateString();
                const dossierDate = new Date(d.timestamp || new Date()).toDateString();
                return today === dossierDate;
            }).length;
            const emAndamento = allDossiers.filter(d => ['contato', 'proposta'].includes(d.status)).length;
            const convertidos = allDossiers.filter(d => d.status === 'fechado').length;

            document.getElementById('total-leads').textContent = total;
            document.getElementById('novos-hoje').textContent = hoje;
            document.getElementById('em-andamento').textContent = emAndamento;
            document.getElementById('convertidos').textContent = convertidos;
        }

        function applyFilters() {
            filteredDossiers = allDossiers.filter(dossier => {
                const matchesProfile = currentFilters.profile === 'todos' || dossier.perfil === currentFilters.profile;
                const matchesSearch = !currentFilters.search || 
                    dossier.nome?.toLowerCase().includes(currentFilters.search.toLowerCase()) ||
                    dossier.telefone?.includes(currentFilters.search) ||
                    dossier.historico?.some(item => item.resposta?.toLowerCase().includes(currentFilters.search.toLowerCase()));
                
                let matchesTime = true;
                if (currentFilters.timeRange === 'hoje') {
                    const today = new Date().toDateString();
                    const dossierDate = new Date(dossier.timestamp || new Date()).toDateString();
                    matchesTime = today === dossierDate;
                } else if (currentFilters.timeRange === 'semana') {
                    const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                    const dossierDate = new Date(dossier.timestamp || new Date());
                    matchesTime = dossierDate >= weekAgo;
                }
                
                const matchesPriority = !currentFilters.priority || 
                    (currentFilters.priority === 'alta-prioridade' && getPriorityClass(dossier.perfil, dossier.historico) === 'priority-alta');
                
                return matchesProfile && matchesSearch && matchesTime && matchesPriority;
            });

            const sortBy = document.getElementById('sort-select').value;
            filteredDossiers.sort((a, b) => {
                switch (sortBy) {
                    case 'nome': return (a.nome || '').localeCompare(b.nome || '');
                    case 'perfil': return (a.perfil || '').localeCompare(b.perfil || '');
                    case 'prioridade':
                        const priorityOrder = { 'priority-alta': 3, 'priority-media': 2, 'priority-baixa': 1 };
                        return priorityOrder[getPriorityClass(b.perfil, b.historico)] - priorityOrder[getPriorityClass(a.perfil, a.historico)];
                    default: return new Date(b.timestamp || 0) - new Date(a.timestamp || 0);
                }
            });

            renderDossiers();
        }

        function renderDossiers() {
            const container = document.getElementById('dossier-grid');
            const loading = document.getElementById('loading');
            const noResults = document.getElementById('no-results');

            if (filteredDossiers.length === 0) {
                container.innerHTML = '';
                loading.classList.add('hidden');
                noResults.classList.remove('hidden');
                return;
            }

            noResults.classList.add('hidden');
            loading.classList.add('hidden');
            container.innerHTML = filteredDossiers.map(renderDossier).join('');
            
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            }
        }

        async function loadDossiers() {
            const loading = document.getElementById('loading');
            const container = document.getElementById('dossier-grid');
            
            loading.classList.remove('hidden');
            container.innerHTML = '';

            try {
                const response = await fetch(GOOGLE_SCRIPT_URL + '?action=getDossiers');
                const data = await response.json();
                
                if (data.success) {
                    allDossiers = data.dossiers || [];
                    updateStats();
                    applyFilters();
                } else {
                    throw new Error(data.error || 'Erro ao carregar dados');
                }
            } catch (error) {
                console.error('Erro ao carregar dossiers:', error);
                loading.classList.add('hidden');
                container.innerHTML = `
                    <div class="col-span-full text-center py-8">
                        <i data-lucide="wifi-off" class="w-12 h-12 text-red-500 mx-auto mb-4"></i>
                        <p class="text-red-400 mb-4">Erro ao carregar dados</p>
                        <button onclick="loadDossiers()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg">
                            Tentar Novamente
                        </button>
                    </div>
                `;
            }
        }

        function setupEventListeners() {
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    const filter = chip.dataset.filter;
                    
                    if (['todos', 'turista', 'morador', 'divulgador'].includes(filter)) {
                        document.querySelectorAll('.filter-chip[data-filter="todos"], .filter-chip[data-filter="turista"], .filter-chip[data-filter="morador"], .filter-chip[data-filter="divulgador"]')
                            .forEach(c => c.classList.remove('active'));
                        currentFilters.profile = filter;
                    } else if (['hoje', 'semana'].includes(filter)) {
                        document.querySelectorAll('.filter-chip[data-filter="hoje"], .filter-chip[data-filter="semana"]')
                            .forEach(c => c.classList.remove('active'));
                        currentFilters.timeRange = currentFilters.timeRange === filter ? '' : filter;
                    } else if (filter === 'alta-prioridade') {
                        currentFilters.priority = currentFilters.priority === filter ? '' : filter;
                    }
                    
                    chip.classList.toggle('active');
                    applyFilters();
                });
            });

            document.getElementById('search-input').addEventListener('input', (e) => {
                currentFilters.search = e.target.value;
                applyFilters();
            });

            document.getElementById('sort-select').addEventListener('change', applyFilters);
        }

        function clearFilters() {
            currentFilters = { profile: 'todos', timeRange: '', search: '', priority: '' };
            document.getElementById('search-input').value = '';
            document.querySelectorAll('.filter-chip').forEach(chip => chip.classList.remove('active'));
            document.querySelector('.filter-chip[data-filter="todos"]').classList.add('active');
            applyFilters();
        }

        function refreshData() {
            loadDossiers();
        }

        function viewDossier(id) {
            const dossier = allDossiers.find(d => d.id === id);
            if (!dossier) return;

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-gray-800 rounded-lg max-w-2xl w-full max-h-90vh overflow-y-auto">
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-6">
                            <h2 class="text-2xl font-bold text-white">Detalhes do Lead</h2>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-sm text-gray-400">Nome</label>
                                    <p class="text-white font-medium">${dossier.nome || 'Não informado'}</p>
                                </div>
                                <div>
                                    <label class="text-sm text-gray-400">Perfil</label>
                                    <p class="text-white font-medium capitalize">${dossier.perfil || 'Não informado'}</p>
                                </div>
                                <div>
                                    <label class="text-sm text-gray-400">Telefone</label>
                                    <p class="text-white font-medium">${dossier.telefone || 'Não informado'}</p>
                                </div>
                                <div>
                                    <label class="text-sm text-gray-400">Data</label>
                                    <p class="text-white font-medium">${formatDate(dossier.timestamp || new Date())}</p>
                                </div>
                            </div>
                            
                            ${dossier.historico && dossier.historico.length > 0 ? `
                                <div>
                                    <label class="text-sm text-gray-400 mb-2 block">Histórico da Conversa</label>
                                    <div class="space-y-2 max-h-40 overflow-y-auto">
                                        ${dossier.historico.map(item => `
                                            <div class="bg-gray-700 p-3 rounded">
                                                <p class="text-sm text-gray-300 mb-1">${item.pergunta}</p>
                                                <p class="text-white font-medium">${item.resposta}</p>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${dossier.proposta_personalizada ? `
                                <div>
                                    <label class="text-sm text-gray-400 mb-2 block">Proposta Personalizada</label>
                                    <div class="bg-blue-900/30 p-4 rounded border border-blue-500/30">
                                        <p class="text-blue-100">${dossier.proposta_personalizada}</p>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            loadDossiers();
            
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            }
            
            setInterval(loadDossiers, 300000);
        });

        window.clearFilters = clearFilters;
        window.refreshData = refreshData;
        window.viewDossier = viewDossier;
    </script>
</body>
</html>
