<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Oportunidades - Conex√£o B√∫zios</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            /* Paleta Conex√£o B√∫zios - Tema Litor√¢neo */
            --color-ocean-deep: #0d4f73;
            --color-ocean-medium: #1e6b96;
            --color-ocean-light: #2980b9;
            --color-sand-warm: #f4e6d3;
            --color-sand-medium: #e8d5b7;
            --color-green-leaf: #27ae60;
            --color-white-warm: #fdfcfa;
            --color-gray-ocean: #34495e;
            --color-gray-light: #95a5a6;
            
            /* Background e Surface */
            --color-bg: linear-gradient(135deg, #0d4f73 0%, #1a252f 100%);
            --color-surface: rgba(29, 107, 150, 0.15);
            --color-glass: rgba(29, 107, 150, 0.25);
            --color-border: rgba(244, 230, 211, 0.2);
            --color-border-hover: rgba(244, 230, 211, 0.4);
            
            /* Textos */
            --color-text-primary: #fdfcfa;
            --color-text-secondary: #f4e6d3;
            --color-text-muted: #bdc3c7;
            --color-text-accent: #2980b9;
            
            /* Estados */
            --color-success: #27ae60;
            --color-warning: #f39c12;
            --color-danger: #e74c3c;
            --color-info: #2980b9;
            
            /* Sombras */
            --shadow-card: 0 8px 32px rgba(13, 79, 115, 0.3);
            --shadow-card-hover: 0 12px 48px rgba(13, 79, 115, 0.4);
            --shadow-button: 0 4px 16px rgba(41, 128, 185, 0.3);
        }

        * {
            box-sizing: border-box;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--color-bg);
            color: var(--color-text-primary); 
            margin: 0;
            padding: 0;
            line-height: 1.6;
        }

        /* Layout Principal */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
        }

        /* Cabe√ßalho */
        header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 2rem 0;
        }

        header h1 {
            color: var(--color-white-warm);
            font-size: clamp(2.5rem, 5vw, 4rem);
            font-weight: 800;
            margin: 0 0 1rem 0;
            text-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }

        header p {
            color: var(--color-sand-warm);
            font-size: clamp(1rem, 2.5vw, 1.25rem);
            font-weight: 500;
            margin: 0;
        }

        /* Glass Effect Melhorado */
        .glass-effect { 
            background: var(--color-glass); 
            backdrop-filter: blur(20px); 
            -webkit-backdrop-filter: blur(20px); 
            border: 1px solid var(--color-border);
            border-radius: 16px;
            box-shadow: var(--shadow-card);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .glass-effect:hover {
            border-color: var(--color-border-hover);
            box-shadow: var(--shadow-card-hover);
            transform: translateY(-2px);
        }

        /* Se√ß√£o de Apresenta√ß√£o */
        .presentation-section {
            margin-bottom: 3rem;
            padding: 2rem;
            background: var(--color-glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--color-border);
            border-radius: 20px;
            box-shadow: var(--shadow-card);
        }

        .presentation-section h2 {
            color: var(--color-white-warm);
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .presentation-section p {
            color: var(--color-sand-warm);
            font-size: 1rem;
            font-weight: 500;
            line-height: 1.7;
            margin-bottom: 1rem;
        }

        .presentation-section strong {
            color: var(--color-ocean-light);
            font-weight: 600;
        }

        .presentation-section hr {
            border: none;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--color-border), transparent);
            margin: 1.5rem 0;
        }

        /* Controles e Filtros */
        .controls-section {
            background: var(--color-glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--color-border);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            position: sticky;
            top: 1rem;
            z-index: 100;
            box-shadow: var(--shadow-card);
        }

        .filters-container {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
            justify-content: center;
        }

        .filter-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
        }

        .filter-divider {
            width: 1px;
            height: 2rem;
            background: var(--color-border);
            margin: 0 0.5rem;
        }

        /* Bot√µes de Filtro */
        .filter-btn {
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            border: 2px solid var(--color-border);
            background: rgba(13, 79, 115, 0.3);
            color: var(--color-text-secondary);
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            min-height: 44px;
            white-space: nowrap;
        }

        .filter-btn:hover {
            border-color: var(--color-ocean-light);
            background: rgba(41, 128, 185, 0.2);
            color: var(--color-white-warm);
            transform: translateY(-2px);
            box-shadow: var(--shadow-button);
        }

        .filter-btn.active {
            background: linear-gradient(135deg, var(--color-ocean-light), var(--color-ocean-medium));
            border-color: var(--color-ocean-light);
            color: var(--color-white-warm);
            box-shadow: var(--shadow-button);
        }

        .filter-btn.active:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(41, 128, 185, 0.4);
        }

        /* Contador e Refresh */
        .controls-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 1rem;
            justify-content: center;
        }

        .dossier-count {
            color: var(--color-ocean-light);
            font-weight: 600;
            font-size: 1rem;
        }

        .refresh-btn {
            padding: 0.75rem;
            border-radius: 12px;
            border: 1px solid var(--color-border);
            background: rgba(13, 79, 115, 0.3);
            color: var(--color-sand-warm);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            background: var(--color-ocean-light);
            color: var(--color-white-warm);
            transform: rotate(180deg);
        }

        /* Grid de Cards */
        .dossier-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        /* Cards de Lead */
        .dossier-card {
            background: var(--color-glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--color-border);
            border-radius: 20px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex;
            flex-direction: column;
            gap: 1rem;
            min-height: 200px;
            box-shadow: var(--shadow-card);
            animation: fadeInUp 0.6s ease-out;
        }

        .dossier-card:hover {
            border-color: var(--color-ocean-light);
            transform: translateY(-4px);
            box-shadow: var(--shadow-card-hover);
            background: rgba(29, 107, 150, 0.35);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
        }

        .card-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--color-ocean-light), var(--color-ocean-deep));
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-white-warm);
            font-weight: 800;
            font-size: 1.5rem;
            box-shadow: 0 4px 16px rgba(41, 128, 185, 0.4);
            flex-shrink: 0;
        }

        .card-badges {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            align-items: flex-end;
        }

        .profile-icon {
            color: var(--color-sand-warm);
            opacity: 0.8;
        }

        /* Status Tags */
        .status-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.375rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border: 1px solid;
        }

        .status-novo {
            background: rgba(52, 152, 219, 0.2);
            border-color: #3498db;
            color: #3498db;
        }

        .status-contato {
            background: rgba(243, 156, 18, 0.2);
            border-color: #f39c12;
            color: #f39c12;
        }

        .status-proposta {
            background: rgba(39, 174, 96, 0.2);
            border-color: #27ae60;
            color: #27ae60;
        }

        .status-negociacao {
            background: rgba(155, 89, 182, 0.2);
            border-color: #9b59b6;
            color: #9b59b6;
        }

        /* Conte√∫do do Card */
        .card-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .card-title {
            color: var(--color-white-warm);
            font-size: 1.125rem;
            font-weight: 700;
            margin: 0;
            line-height: 1.3;
        }

        .card-description {
            color: var(--color-sand-warm);
            font-size: 0.875rem;
            line-height: 1.5;
            opacity: 0.9;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Footer do Card */
        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 1rem;
            border-top: 1px solid var(--color-border);
            font-size: 0.75rem;
        }

        .card-time {
            color: var(--color-text-muted);
            font-weight: 500;
        }

        .card-potential {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            font-weight: 700;
        }

        .potential-alto {
            color: #1abc9c;
        }

        .potential-medio {
            color: #f39c12;
        }

        .potential-baixo {
            color: #95a5a6;
        }

        /* Estados da UI */
        .ui-state {
            text-align: center;
            padding: 3rem 1rem;
            background: var(--color-glass);
            border: 1px solid var(--color-border);
            border-radius: 20px;
            box-shadow: var(--shadow-card);
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--color-border);
            border-top-color: var(--color-ocean-light);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        .ui-state h3 {
            color: var(--color-white-warm);
            font-size: 1.25rem;
            font-weight: 700;
            margin: 0 0 0.5rem 0;
        }

        .ui-state p {
            color: var(--color-sand-warm);
            margin: 0;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(13, 79, 115, 0.8);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--color-glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--color-border);
            border-radius: 24px;
            width: 100%;
            max-width: 1200px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transform: scale(0.9) translateY(20px);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal-content {
            transform: scale(1) translateY(0);
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--color-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex-grow: 1;
        }

        /* Bot√µes de A√ß√£o */
        .action-btn {
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--color-ocean-light), var(--color-ocean-medium));
            color: var(--color-white-warm);
            box-shadow: var(--shadow-button);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(41, 128, 185, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--color-success), #229954);
            color: var(--color-white-warm);
            box-shadow: 0 4px 16px rgba(39, 174, 96, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4);
        }

        .btn-secondary {
            background: rgba(13, 79, 115, 0.3);
            border: 1px solid var(--color-border);
            color: var(--color-sand-warm);
        }

        .btn-secondary:hover {
            background: var(--color-ocean-light);
            color: var(--color-white-warm);
        }

        .btn-close {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid #e74c3c;
            color: #e74c3c;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-close:hover {
            background: #e74c3c;
            color: white;
            transform: scale(1.1);
        }

        /* Bot√£o Voltar ao Topo */
        .back-to-top {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--color-ocean-light), var(--color-ocean-medium));
            border: none;
            color: var(--color-white-warm);
            cursor: pointer;
            box-shadow: var(--shadow-button);
            transition: all 0.3s ease;
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transform: translateY(20px);
        }

        .back-to-top.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .back-to-top:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(41, 128, 185, 0.4);
        }

        /* Anima√ß√µes */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .container {
                padding: 0.5rem;
            }

            .presentation-section,
            .controls-section {
                padding: 1rem;
                margin-bottom: 1.5rem;
            }

            .filters-container {
                flex-direction: column;
                gap: 1rem;
            }

            .filter-group {
                justify-content: center;
                width: 100%;
            }

            .filter-divider {
                display: none;
            }

            .dossier-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .modal-content {
                margin: 0.5rem;
                max-height: 95vh;
            }

            .modal-header {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }

            .back-to-top {
                bottom: 1rem;
                right: 1rem;
                width: 48px;
                height: 48px;
            }
        }

        @media (max-width: 480px) {
            .filter-btn {
                padding: 0.625rem 1rem;
                font-size: 0.8rem;
            }

            .card-avatar {
                width: 50px;
                height: 50px;
                font-size: 1.25rem;
            }

            .dossier-card {
                padding: 1rem;
            }
        }

        /* Scrollbar customizada */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(13, 79, 115, 0.1);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--color-ocean-light);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--color-ocean-medium);
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="container">
        <!-- CABE√áALHO -->
        <header>
            <h1>Vitrine de Oportunidades</h1>
            <p>Leads Qualificados em Tempo Real | Conex√£o B√∫zios</p>
        </header>

        <!-- Bloco de Apresenta√ß√£o e Orienta√ß√£o -->
        <section class="presentation-section">
            <h2>
                <i data-lucide="lightbulb" class="w-6 h-6 text-amber-400"></i>
                O que √© este painel?
            </h2>
            <div class="space-y-3 leading-relaxed max-w-5xl mx-auto text-base">
                <p>Este √© um painel inteligente que apresenta <strong>leads reais e qualificados</strong>, capturados pelo projeto Conex√£o B√∫zios. Ele serve para identificar e aproveitar oportunidades comerciais de forma visual, organizada e pr√°tica.</p>
                <p>√â ideal para <strong>profissionais de vendas, turismo, servi√ßos, divulgadores e investidores</strong> interessados no ecossistema de B√∫zios. Aqui voc√™ encontra perfis de leads, seus interesses, hist√≥rico de respostas, propostas personalizadas por IA e contato direto via WhatsApp.</p>
                <p>O valor est√° na efici√™ncia: ele economiza seu tempo, organiza os contatos e conecta voc√™ apenas com quem tem <strong>inten√ß√£o real</strong>. √â o seu funil de vendas inteligente, funcionando 24 horas por dia.</p>
                <hr>
                <p class="text-sm italic">Se voc√™ entendeu, viu valor e sentiu que precisa disso, a pr√≥xima pergunta l√≥gica √©: como fa√ßo para entrar agora?</p>
            </div>
        </section>

        <!-- FILTROS E CONTROLES -->
        <div class="controls-section">
            <div class="filters-container">
                <div class="filter-group" id="filters-profile">
                    <button data-filter="all" class="filter-btn active">Todos</button>
                    <button data-filter="Turista" class="filter-btn"><i data-lucide="sun-moon"></i> Turistas</button>
                    <button data-filter="Morador" class="filter-btn"><i data-lucide="home"></i> Moradores</button>
                    <button data-filter="Divulgador" class="filter-btn"><i data-lucide="megaphone"></i> Parceiros</button>
                </div>
                <div class="filter-divider"></div>
                <div class="filter-group" id="filters-status">
                    <button data-status-filter="all" class="filter-btn active">Todos os Status</button>
                    <button data-status-filter="Novo" class="filter-btn">Novos</button>
                    <button data-status-filter="Em Contato" class="filter-btn">Em Contato</button>
                    <button data-status-filter="Proposta" class="filter-btn">Proposta</button>
                    <button data-status-filter="Negocia√ß√£o" class="filter-btn">Negocia√ß√£o</button>
                </div>
            </div>
            <div class="controls-info">
                <span id="dossier-count" class="dossier-count" aria-live="polite"></span>
                <button id="refresh-btn" class="refresh-btn" aria-label="Atualizar dossi√™s">
                    <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                </button>
            </div>
        </div>

        <!-- GRID DE LEADS -->
        <main id="dossier-grid" class="dossier-grid"></main>
        
        <!-- ESTADOS DA UI -->
        <div id="status-container" aria-live="assertive">
            <div id="loading-state" class="ui-state hidden">
                <div class="loading-spinner"></div>
                <h3>Buscando oportunidades...</h3>
                <p>Carregando leads qualificados em tempo real</p>
            </div>
            <div id="error-state" class="ui-state hidden">
                <h3>‚ö†Ô∏è Falha na Conex√£o</h3>
                <p>N√£o foi poss√≠vel carregar os leads. Verifique sua conex√£o e tente novamente.</p>
            </div>
            <div id="empty-state" class="ui-state hidden">
                <h3>Nenhuma oportunidade encontrada</h3>
                <p>Ajuste os filtros ou aguarde novos leads entrarem.</p>
            </div>
        </div>

        <!-- BOT√ÉO VOLTAR AO TOPO -->
        <button id="back-to-top" class="back-to-top" aria-label="Voltar ao topo">
            <i data-lucide="arrow-up" class="w-6 h-6"></i>
        </button>
    </div>

    <!-- MODAL DE DETALHES DO LEAD -->
    <div id="modal-overlay" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <div id="modal-content" class="modal-content">
            <!-- PAINEL 1: Cabe√ßalho e A√ß√µes Imediatas (Fixo) -->
            <header id="modal-header" class="modal-header"></header>
            
            <!-- Corpo do Modal (Rol√°vel) -->
            <div id="modal-body" class="modal-body" tabindex="-1"></div>
        </div>
    </div>

    <script>
        const GOOGLE_APP_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwHC3bAoL_c5rscJV2xbwVi9KMedM3QHbWCZ3bo64w0DbiMGOtnahL9BynJ5ADao63I/exec";
        
        // Elementos da DOM
        const grid = document.getElementById('dossier-grid');
        const loadingState = document.getElementById('loading-state');
        const errorState = document.getElementById('error-state');
        const emptyState = document.getElementById('empty-state');
        const dossierCountEl = document.getElementById('dossier-count');
        const modalOverlay = document.getElementById('modal-overlay');
        const modalHeader = document.getElementById('modal-header');
        const modalBody = document.getElementById('modal-body');
        
        // Estado da Aplica√ß√£o
        let allDossiers = [];
        let currentProfileFilter = 'all';
        let currentStatusFilter = 'all';
        let lastFocusedElement = null;

        // --- DADOS MOCKADOS E CONFIGURA√á√ïES (para demonstra√ß√£o) ---
        const leadStatuses = ['Novo', 'Em Contato', 'Proposta', 'Negocia√ß√£o'];
        const leadPotentials = {
            'Alto': { icon: 'gem', color: 'text-cyan-400', text: 'Potencial Alto' },
            'M√©dio': { icon: 'trending-up', color: 'text-amber-400', text: 'Potencial M√©dio' },
            'Baixo': { icon: 'trending-down', color: 'text-slate-500', text: 'Potencial Baixo' }
        };
        const statusStyling = {
            'Novo': { class: 'status-novo', icon: 'sparkles' },
            'Em Contato': { class: 'status-contato', icon: 'phone-forwarded' },
            'Proposta': { class: 'status-proposta', icon: 'file-check-2' },
            'Negocia√ß√£o': { class: 'status-negociacao', icon: 'handshake' }
        };
        const profileIcons = { 'Turista': 'sun-moon', 'Morador': 'home', 'Divulgador': 'megaphone', 'N/A': 'help-circle' };
        
        // --- FUN√á√ïES UTILIT√ÅRIAS ---
        const sanitizeHTML = (str) => { const temp = document.createElement('div'); temp.textContent = str || ''; return temp.innerHTML; };
        const formatRelativeTime = (isoString) => {
            try {
                const date = new Date(isoString);
                const formatter = new Intl.RelativeTimeFormat('pt-BR', { numeric: 'auto' });
                const diffSeconds = (date.getTime() - Date.now()) / 1000;
                const diffDays = Math.round(diffSeconds / 86400);
                if (Math.abs(diffDays) > 1) return formatter.format(diffDays, 'day');
                const diffHours = Math.round(diffSeconds / 3600);
                if (Math.abs(diffHours) > 1) return formatter.format(diffHours, 'hour');
                const diffMinutes = Math.round(diffSeconds / 60);
                return formatter.format(diffMinutes, 'minute');
            } catch (e) { return isoString || 'Data indispon√≠vel'; }
        };
        const getInitials = (name) => {
            if (!name || typeof name !== 'string' || name.trim().length === 0) return '?';
            const parts = name.trim().split(' ').filter(Boolean);
            if (parts.length > 1) return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
            if (parts.length === 1 && parts[0].length > 1) return parts[0].substring(0, 2).toUpperCase();
            return name[0].toUpperCase();
        };

        // --- L√ìGICA PRINCIPAL DA APLICA√á√ÉO ---
        const renderDossiers = () => {
            grid.innerHTML = '';
            emptyState.classList.add('hidden');
            
            const profileFiltered = currentProfileFilter === 'all' ? allDossiers : allDossiers.filter(d => d && d.profile === currentProfileFilter);
            const filteredDossiers = currentStatusFilter === 'all' ? profileFiltered : profileFiltered.filter(d => d && d.status === currentStatusFilter);
            
            dossierCountEl.textContent = `${filteredDossiers.length} Oportunidades`;
            if (filteredDossiers.length === 0) { emptyState.classList.remove('hidden'); return; }

            filteredDossiers.forEach((dossier, index) => {
                const card = document.createElement('button');
                card.className = 'dossier-card';
                card.style.animationDelay = `${index * 100}ms`;
                card.dataset.id = dossier.id;
                
                const initials = getInitials(dossier.name);
                const statusInfo = statusStyling[dossier.status] || {};
                const potentialInfo = leadPotentials[dossier.potential] || {};
                const profileIcon = profileIcons[dossier.profile] || 'help-circle';

                // Mapear status para classes CSS
                let statusClass = 'status-novo';
                if (dossier.status === 'Em Contato') statusClass = 'status-contato';
                else if (dossier.status === 'Proposta') statusClass = 'status-proposta';
                else if (dossier.status === 'Negocia√ß√£o') statusClass = 'status-negociacao';

                // Mapear potencial para classes CSS
                let potentialClass = 'potential-baixo';
                if (dossier.potential === 'Alto') potentialClass = 'potential-alto';
                else if (dossier.potential === 'M√©dio') potentialClass = 'potential-medio';

                card.innerHTML = `
                    <div class="card-header">
                        <div class="card-avatar">${initials}</div>
                        <div class="card-badges">
                            <i data-lucide="${profileIcon}" class="w-5 h-5 profile-icon"></i>
                            <span class="status-tag ${statusClass}">
                                <i data-lucide="${statusInfo.icon || 'circle'}" class="w-3 h-3"></i>
                                ${dossier.status}
                            </span>
                        </div>
                    </div>
                    <div class="card-content">
                        <h3 class="card-title">${sanitizeHTML(dossier.name || 'Lead An√¥nimo')}</h3>
                        <p class="card-description">${sanitizeHTML(dossier.interest || 'Nenhum interesse principal informado')}</p>
                    </div>
                    <div class="card-footer">
                        <span class="card-time">${formatRelativeTime(dossier.timestamp)}</span>
                        <span class="card-potential ${potentialClass}">
                            <i data-lucide="${potentialInfo.icon || 'trending-up'}" class="w-3.5 h-3.5"></i>
                            ${dossier.potential}
                        </span>
                    </div>`;
                card.addEventListener('click', () => openModal(dossier));
                grid.appendChild(card);
            });
            lucide.createIcons();
        };
        
        async function fetchFromAPI(payload) {
            try {
                const response = await fetch(GOOGLE_APP_SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload), redirect: 'follow' });
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const result = await response.json();
                if (result.success === false) throw new Error(`API Error: ${result.error}`);
                return result.data;
            } catch (error) { console.error('Fetch API Error:', error); throw error; }
        }

        const loadDossiers = async () => {
            loadingState.classList.remove('hidden');
            errorState.classList.add('hidden');
            grid.innerHTML = '';
            try {
                const dossiersFromApi = await fetchFromAPI({ action: 'listDossies' });
                // Simula status e potencial, pois n√£o v√™m do backend
                allDossiers = dossiersFromApi.map(d => ({
                    ...d,
                    status: leadStatuses[Math.floor(Math.random() * leadStatuses.length)],
                    potential: Object.keys(leadPotentials)[Math.floor(Math.random() * Object.keys(leadPotentials).length)]
                }));
                renderDossiers();
            } catch (error) { errorState.classList.remove('hidden'); }
            finally { loadingState.classList.add('hidden'); }
        };

        const openModal = async (dossier) => {
            lastFocusedElement = document.activeElement;
            modalOverlay.classList.add('active');
            modalHeader.innerHTML = ''; 
            modalBody.innerHTML = '<div class="flex justify-center items-center h-full"><div class="spinner h-8 w-8 rounded-full border-4 border-slate-700"></div><p class="ml-4">Analisando dossi√™ completo...</p></div>';
            
            try {
                const data = await fetchFromAPI({ action: 'getDossierContent', id: dossier.id });
                const leadDetails = parseDossierContent(data.content, dossier);
                renderModalContent(leadDetails);
            } catch (error) { modalBody.innerHTML = '<p class="text-red-400 text-center">N√£o foi poss√≠vel carregar os detalhes deste lead.</p>'; }
        };
        
        function parseDossierContent(content, baseDossier) {
            const getMatch = (regex, flags = 'm') => (content.match(new RegExp(regex, flags)) || [])[1]?.trim() || '';
            const getList = (regex) => {
                const section = getMatch(regex);
                return section ? section.split('\n').map(item => item.replace(/^[‚Ä¢\s*-]+/, '').trim()).filter(Boolean) : [];
            };

            const getTable = (regex) => {
                const tableContent = getMatch(regex);
                if (!tableContent) return [];
                return tableContent.split('\n').map(line => {
                    const parts = line.split('\t'); 
                    if (parts.length < 2) return null;
                    return { 
                        question: parts[0]?.replace('‚ùì','').trim() || '', 
                        answer: parts[1]?.trim() || ''
                    };
                }).filter(row => row && row.question && row.answer);
            };

            return { 
                ...baseDossier, 
                resumo: getMatch(/^Resumo do Perfil\n([\s\S]*?)(?=\n\n|$)/), 
                respostas: getTable(/HIST√ìRICO DE INTERA√á√ïES \(FUNIL COMPLETO\)\s*\n([\s\S]*?)(?=\n\s*üí° PROPOSTA PERSONALIZADA \(IA\)|$)/), 
                necessidades: getList(/Necessidades Reveladas\s*\n([\s\S]*?)(?=\n\nüí°|$)/), 
                proposta: getMatch(/üí° PROPOSTA PERSONALIZADA \(IA\)\s*\n([\s\S]*?)(?=\n\nStatus do Lead:|$)/),
                objecoes: ["Pode ser sens√≠vel a pre√ßo devido ao or√ßamento informado.", "Busca por experi√™ncias aut√™nticas, pode rejeitar op√ß√µes muito tur√≠sticas."]
            };
        }

        function renderModalContent(details) {
            const telefone = (details.respostas.find(r => r.question.toLowerCase().includes('whatsapp')) || {}).answer;
            const statusInfo = statusStyling[details.status] || {};
            const potentialInfo = leadPotentials[details.potential] || {};

            const hasPhone = telefone && telefone.replace(/\D/g, '').length > 8;
            const whatsappBtnHTML = hasPhone
                ? `<a href="https://wa.me/55${telefone.replace(/\D/g, '')}" target="_blank" class="action-btn btn-success">
                     <i data-lucide="send" class="w-4 h-4"></i>Iniciar Conversa
                   </a>`
                : `<button disabled class="action-btn btn-secondary opacity-50 cursor-not-allowed">
                     <i data-lucide="phone-off" class="w-4 h-4"></i>WhatsApp n√£o informado
                   </button>`;

            // Mapear status para classes CSS
            let statusClass = 'status-novo';
            if (details.status === 'Em Contato') statusClass = 'status-contato';
            else if (details.status === 'Proposta') statusClass = 'status-proposta';
            else if (details.status === 'Negocia√ß√£o') statusClass = 'status-negociacao';

            // Mapear potencial para classes CSS
            let potentialClass = 'potential-baixo';
            if (details.potential === 'Alto') potentialClass = 'potential-alto';
            else if (details.potential === 'M√©dio') potentialClass = 'potential-medio';

            // --- PAINEL 1: Cabe√ßalho e A√ß√µes Imediatas ---
            modalHeader.innerHTML = `
                <div class="flex items-center gap-4">
                    <div class="card-avatar">${getInitials(details.name)}</div>
                    <div>
                        <h2 id="modal-title" class="text-xl font-bold" style="color: var(--color-white-warm);">${sanitizeHTML(details.name)}</h2>
                        <div class="flex items-center gap-2 mt-1 flex-wrap">
                            <span class="status-tag ${statusClass}">
                                <i data-lucide="${statusInfo.icon || 'circle'}" class="w-3 h-3"></i>
                                ${details.status}
                            </span>
                            <span class="status-tag ${potentialClass}" style="background: rgba(29, 107, 150, 0.2); border-color: var(--color-ocean-light);">
                                <i data-lucide="${potentialInfo.icon || 'trending-up'}" class="w-3 h-3"></i>
                                ${details.potential}
                            </span>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-2 flex-wrap">
                    ${whatsappBtnHTML}
                    <a href="https://instagram.com/conexaobuzios" target="_blank" class="action-btn btn-primary">
                        <i data-lucide="instagram" class="w-4 h-4"></i>Falar com Concierge
                    </a>
                    <div class="relative">
                        <select onchange="updateLeadStatus('${details.id}', this.value)" class="action-btn btn-secondary" style="appearance: none; padding-right: 2rem;">
                            ${leadStatuses.map(s => `<option value="${s}" ${s === details.status ? 'selected' : ''}>${s}</option>`).join('')}
                        </select>
                        <i data-lucide="chevron-down" class="w-4 h-4 absolute right-2 top-1/2 transform -translate-y-1/2 pointer-events-none" style="color: var(--color-sand-warm);"></i>
                    </div>
                    <button id="close-modal-btn" class="btn-close" aria-label="Fechar modal">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>`;
            
            // --- PAINEL 2, 3, 4 e 5: Corpo do Modal ---
            const necessidadesHTML = details.necessidades.length > 0 ? details.necessidades.map(need => `<li class="flex items-start gap-3"><i data-lucide="check" class="w-5 h-5 text-green-leaf mt-1 flex-shrink-0" style="color: var(--color-green-leaf);"></i><span style="color: var(--color-sand-warm); font-weight: 500;">${sanitizeHTML(need)}</span></li>`).join('') : '<li style="color: var(--color-sand-warm);">Nenhuma necessidade espec√≠fica foi revelada pela IA.</li>';
            const objecoesHTML = details.objecoes.length > 0 ? details.objecoes.map(obj => `<li class="flex items-start gap-3"><i data-lucide="shield-alert" class="w-5 h-5 mt-1 flex-shrink-0" style="color: var(--color-warning);"></i><span style="color: var(--color-sand-warm); font-weight: 500;">${sanitizeHTML(obj)}</span></li>`).join('') : '<li style="color: var(--color-sand-warm);">Nenhuma obje√ß√£o prov√°vel identificada.</li>';
            const respostasHTML = details.respostas.length > 0 ? details.respostas.map((resp) => `<div class="py-3" style="border-bottom: 1px solid var(--color-border);"><dt class="text-xs font-medium" style="color: var(--color-text-muted);">${sanitizeHTML(resp.question)}</dt><dd class="text-base font-semibold mt-1" style="color: var(--color-white-warm);">‚Äî ${sanitizeHTML(resp.answer)}</dd></div>`).join('') : '<p style="color: var(--color-sand-warm);">Sem respostas registradas.</p>';

            modalBody.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                    <!-- Coluna Principal (3/5) -->
                    <div class="lg:col-span-3 space-y-6">
                        <!-- PAINEL 2: An√°lise Comercial -->
                        <div class="glass-effect p-6 rounded-xl">
                            <h3 class="flex items-center gap-3 text-lg font-bold mb-4" style="color: var(--color-white-warm);">
                                <i data-lucide="user-check" class="w-6 h-6" style="color: var(--color-ocean-light);"></i>
                                Resumo do Perfil (IA)
                            </h3>
                            <p class="leading-relaxed font-medium" style="color: var(--color-sand-warm);">${sanitizeHTML(details.resumo) || '<span style="color: var(--color-text-muted);">Resumo n√£o dispon√≠vel.</span>'}</p>
                        </div>
                        <div class="glass-effect p-6 rounded-xl">
                            <h3 class="flex items-center gap-3 text-lg font-bold mb-4" style="color: var(--color-white-warm);">
                                <i data-lucide="search-check" class="w-6 h-6" style="color: var(--color-green-leaf);"></i>
                                Necessidades Reveladas (IA)
                            </h3>
                            <ul class="space-y-3">${necessidadesHTML}</ul>
                        </div>
                        <div class="glass-effect p-6 rounded-xl">
                            <h3 class="flex items-center gap-3 text-lg font-bold mb-4" style="color: var(--color-white-warm);">
                                <i data-lucide="shield-alert" class="w-6 h-6" style="color: var(--color-warning);"></i>
                                Obje√ß√µes Prov√°veis (IA)
                            </h3>
                            <ul class="space-y-3">${objecoesHTML}</ul>
                        </div>
                        <!-- PAINEL 3: Proposta -->
                        <div class="glass-effect p-6 rounded-xl" style="background: linear-gradient(135deg, var(--color-ocean-deep), var(--color-ocean-medium));">
                            <h3 class="flex items-center gap-3 text-lg font-bold mb-4" style="color: var(--color-white-warm);">
                                <i data-lucide="sparkles" class="w-6 h-6" style="color: var(--color-sand-warm);"></i>
                                Proposta Inteligente Personalizada (IA)
                            </h3>
                            <div class="leading-relaxed font-medium whitespace-pre-line" style="color: var(--color-sand-warm);">${sanitizeHTML(details.proposta)}</div>
                            <button id="collapse-modal-btn" class="action-btn btn-secondary mt-4">
                                <i data-lucide="chevron-up" class="w-4 h-4"></i>
                                Recolher Se√ß√£o
                            </button>
                        </div>
                    </div>
                    <!-- Coluna Direita (2/5) -->
                    <div class="lg:col-span-2 space-y-6">
                        <!-- PAINEL 4: Hist√≥rico -->
                        <div class="glass-effect p-6 rounded-xl">
                            <h3 class="flex items-center gap-3 text-lg font-bold mb-4" style="color: var(--color-white-warm);">
                                <i data-lucide="message-square-text" class="w-6 h-6" style="color: var(--color-ocean-light);"></i>
                                Hist√≥rico de Intera√ß√µes
                            </h3>
                            <dl class="space-y-3">${respostasHTML}</dl>
                        </div>
                        <!-- PAINEL 5: Metadados -->
                        <div class="glass-effect p-6 rounded-xl">
                            <h3 class="flex items-center gap-3 text-lg font-bold mb-4" style="color: var(--color-white-warm);">
                                <i data-lucide="database" class="w-6 h-6" style="color: var(--color-green-leaf);"></i>
                                Dados do Lead
                            </h3>
                            <dl class="text-sm space-y-2">
                                <div class="flex justify-between py-2" style="border-bottom: 1px solid var(--color-border);">
                                    <dt class="font-semibold" style="color: var(--color-text-muted);">WhatsApp</dt>
                                    <dd class="font-mono font-bold" style="color: var(--color-white-warm);">${telefone ? sanitizeHTML(telefone) : 'N√£o informado'}</dd>
                                </div>
                                <div class="flex justify-between py-2" style="border-bottom: 1px solid var(--color-border);">
                                    <dt class="font-semibold" style="color: var(--color-text-muted);">Gerado em</dt>
                                    <dd class="font-semibold" style="color: var(--color-white-warm);">${new Date(details.timestamp).toLocaleString('pt-BR')}</dd>
                                </div>
                                <div class="flex justify-between py-2">
                                    <dt class="font-semibold" style="color: var(--color-text-muted);">Dossi√™ Original</dt>
                                    <dd><a href="${details.url}" target="_blank" class="action-btn btn-primary text-xs">Abrir</a></dd>
                                </div>
                            </dl>
                        </div>
                    </div>
                </div>`;

            // Anexar event listeners
            const collapseBtn = document.getElementById('collapse-modal-btn');
            if (collapseBtn) {
                collapseBtn.addEventListener('click', () => {
                    const modalBody = document.getElementById('modal-body');
                    const proposalSection = collapseBtn.closest('.glass-effect');
                    const icon = collapseBtn.querySelector('i');
                    
                    if (proposalSection.style.display === 'none') {
                        proposalSection.style.display = 'block';
                        collapseBtn.innerHTML = '<i data-lucide="chevron-up" class="w-4 h-4"></i>Recolher Se√ß√£o';
                    } else {
                        proposalSection.style.display = 'none';
                        // Criar um bot√£o para reabrir a se√ß√£o
                        const reopenBtn = document.createElement('button');
                        reopenBtn.className = 'action-btn btn-primary mb-4';
                        reopenBtn.innerHTML = '<i data-lucide="chevron-down" class="w-4 h-4"></i>Mostrar Proposta';
                        reopenBtn.addEventListener('click', () => {
                            proposalSection.style.display = 'block';
                            reopenBtn.remove();
                            lucide.createIcons();
                        });
                        modalBody.querySelector('.lg\\:col-span-3').insertBefore(reopenBtn, proposalSection);
                    }
                    lucide.createIcons();
                });
            }
            
            document.getElementById('close-modal-btn').addEventListener('click', closeModal);
            lucide.createIcons();
        }
        
        // Fun√ß√£o para controlar o bot√£o "voltar ao topo"
        function toggleBackToTop() {
            const backToTopBtn = document.getElementById('back-to-top');
            if (window.pageYOffset > 300) {
                backToTopBtn.classList.add('visible');
            } else {
                backToTopBtn.classList.remove('visible');
            }
        }

        function updateLeadStatus(leadId, newStatus) {
            // A√ß√£o de exemplo. O ideal √© chamar o backend para persistir a mudan√ßa.
            console.log(`Lead ${leadId} status alterado para: ${newStatus}`);
            const lead = allDossiers.find(d => d.id === leadId);
            if (lead) {
                lead.status = newStatus;
                renderDossiers(); // Re-renderiza para refletir a mudan√ßa no card
            }
        }

        const closeModal = () => { modalOverlay.classList.remove('active'); if (lastFocusedElement) lastFocusedElement.focus(); };

        // --- INICIALIZA√á√ÉO E EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            // Event listeners para filtros de perfil
            document.getElementById('filters-profile').addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (button) {
                    // Remove active de todos os bot√µes do grupo
                    document.querySelectorAll('#filters-profile .filter-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    // Adiciona active ao bot√£o clicado
                    button.classList.add('active');
                    currentProfileFilter = button.dataset.filter;
                    renderDossiers();
                }
            });

            // Event listeners para filtros de status
            document.getElementById('filters-status').addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (button) {
                    // Remove active de todos os bot√µes do grupo
                    document.querySelectorAll('#filters-status .filter-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    // Adiciona active ao bot√£o clicado
                    button.classList.add('active');
                    currentStatusFilter = button.dataset.statusFilter;
                    renderDossiers();
                }
            });

            // Event listener para o bot√£o refresh
            document.getElementById('refresh-btn').addEventListener('click', loadDossiers);
            
            // Event listener para o bot√£o voltar ao topo
            const backToTopBtn = document.getElementById('back-to-top');
            backToTopBtn.addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
            
            // Event listener para scroll - controla bot√£o voltar ao topo
            window.addEventListener('scroll', toggleBackToTop);
            
            // Event listeners do modal
            modalOverlay.addEventListener('click', (e) => { 
                if (e.target === modalOverlay) closeModal(); 
            });
            document.addEventListener('keydown', (e) => { 
                if (e.key === "Escape" && modalOverlay.classList.contains('active')) closeModal(); 
            });
            
            // Inicializar
            loadDossiers();
            lucide.createIcons();
        });
    </script>
</body>
</html>
