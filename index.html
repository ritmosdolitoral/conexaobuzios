<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conexão Búzios - Seu Concierge Virtual</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        // Configuração do Tailwind
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'poppins': ['Poppins', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style>
        /* Reset e Base */
        * {
            box-sizing: border-box;
        }
        
        body { 
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            background: linear-gradient(135deg, #020617 0%, #1e293b 100%);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            min-height: 100vh;
        }
        
        /* Prevenção de FOUC */
        .app-loading {
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        
        .app-ready {
            opacity: 1;
        }
        
        /* Animações Principais */
        .typing-cursor { 
            animation: blink 1s step-end infinite; 
        }
        
        @keyframes blink { 
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .immersive-phrase {
            font-size: clamp(1.5rem, 4vw, 2.5rem);
            line-height: 1.3;
            background: linear-gradient(135deg, #ffffff 0%, #e2e8f0 50%, #94a3b8 100%);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradient-shift 3s ease-in-out infinite alternate;
        }
        
        @keyframes gradient-shift {
            0% { background-position: 0% 50%; }
            100% { background-position: 100% 50%; }
        }
        
        .text-shadow-glow {
            text-shadow: 0 0 8px rgba(59, 130, 246, 0.4), 0 0 20px rgba(59, 130, 246, 0.2);
        }
        
        .text-shadow-soft {
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        /* Sistema de Botões Robusto */
        .btn-base {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 120px;
            min-height: 44px;
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-weight: 500;
            font-size: 14px;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .btn-base:focus {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }
        
        .btn-base:active {
            transform: scale(0.98);
        }
        
        .btn-base:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }
        
        .btn-portal {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
        
        .btn-portal:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }
        
        .btn-chat {
            background: #ffffff;
            color: #374151;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .btn-chat:hover:not(:disabled) {
            background: #f9fafb;
            border-color: #3b82f6;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #0077B6 0%, #005a8a 100%);
            color: white;
            border: none;
            box-shadow: 0 2px 8px rgba(0, 119, 182, 0.3);
        }
        
        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, #005a8a 0%, #004d73 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 119, 182, 0.4);
        }
        
        /* Sistema de Chat Robusto */
        .chat-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .chat-bubble {
            max-width: 85%;
            padding: 16px 20px;
            border-radius: 18px;
            margin-bottom: 12px;
            line-height: 1.5;
            word-wrap: break-word;
            opacity: 0;
            transform: translateY(20px);
            animation: message-appear 0.4s ease-out forwards;
        }
        
        .chat-bubble.ai {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            color: #374151;
            border-bottom-left-radius: 6px;
            align-self: flex-start;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            border: 1px solid rgba(59, 130, 246, 0.1);
        }
        
        .chat-bubble.user {
            background: linear-gradient(135deg, #0077B6 0%, #005a8a 100%);
            color: white;
            border-bottom-right-radius: 6px;
            align-self: flex-end;
            box-shadow: 0 2px 12px rgba(0, 119, 182, 0.3);
        }
        
        @keyframes message-appear {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Indicador de Digitação */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 16px 20px;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            background-color: #9ca3af;
            border-radius: 50%;
            animation: typing-bounce 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        .typing-dot:nth-child(3) { animation-delay: 0s; }
        
        @keyframes typing-bounce {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1.2); opacity: 1; }
        }
        
        /* Partículas com Performance Otimizada */
        .particle {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            pointer-events: none;
            will-change: transform;
            animation: float-particle 20s infinite linear;
        }
        
        @keyframes float-particle {
            0% { 
                transform: translateY(100vh) translateX(-5vw) scale(0); 
                opacity: 0; 
            }
            10% { 
                opacity: 0.3; 
                transform: translateY(90vh) translateX(0vw) scale(1); 
            }
            90% { 
                opacity: 0.3; 
                transform: translateY(10vh) translateX(5vw) scale(1); 
            }
            100% { 
                transform: translateY(-10vh) translateX(10vw) scale(0); 
                opacity: 0; 
            }
        }
        
        /* Ondas do Oceano */
        .ocean-wave {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 80px;
            background: linear-gradient(180deg, transparent 0%, rgba(59, 130, 246, 0.08) 100%);
            animation: wave-motion 6s ease-in-out infinite;
        }
        
        @keyframes wave-motion {
            0%, 100% { transform: translateX(0%) scaleY(1); }
            50% { transform: translateX(1%) scaleY(1.1); }
        }
        
        /* Sistema de Loading */
        .loading-spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #ffffff;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Barra de Progresso */
        .progress-container {
            width: 100%;
            max-width: 300px;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #06b6d4);
            border-radius: 2px;
            transition: width 0.3s ease;
            transform-origin: left;
        }
        
        /* Sistema de Assinatura */
        .signature-container {
            opacity: 0;
            transition: opacity 0.6s ease-in;
        }
        
        .signature-container.visible {
            opacity: 1;
        }
        
        .signature-part {
            display: inline-block;
            opacity: 0;
            transform: translateY(10px);
        }
        
        .signature-container.visible .signature-part {
            animation: signature-reveal 0.6s ease-out forwards;
        }
        
        .signature-container.visible .signature-part:nth-child(2) {
            animation-delay: 0.3s;
        }
        
        @keyframes signature-reveal {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Input System */
        .input-container {
            position: relative;
        }
        
        .input-field {
            width: 100%;
            padding: 16px 20px 16px 50px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.2s ease;
            background: white;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .input-field.error {
            border-color: #ef4444;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
            animation: shake 0.5s ease-in-out;
        }
        
        .input-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
            pointer-events: none;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-4px); }
            75% { transform: translateX(4px); }
        }
        
        /* Responsividade Robusta */
        @media (max-width: 640px) {
            .btn-group-mobile {
                flex-direction: column;
                gap: 12px;
            }
            
            .btn-group-mobile .btn-base {
                width: 100%;
                min-height: 48px;
            }
            
            .immersive-phrase {
                font-size: clamp(1.25rem, 6vw, 2rem);
            }
            
            .chat-bubble {
                max-width: 90%;
                padding: 12px 16px;
            }
        }
        
        @media (max-width: 320px) {
            .btn-base {
                min-width: 100px;
                min-height: 44px;
                font-size: 13px;
                padding: 10px 16px;
            }
        }
        
        /* Estados e Utilitários */
        .hidden { 
            display: none !important; 
        }
        
        .flex { 
            display: flex !important; 
        }
        
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* Prevenção de Bugs */
        .no-select {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        .safe-area {
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }
    </style>
</head>
<body class="app-loading font-poppins text-slate-100">

    <!-- Portal de Introdução -->
    <div id="ai-intro-portal" class="min-h-screen w-full flex flex-col justify-center items-center text-center px-6 py-12 relative overflow-hidden">
        <!-- Partículas flutuantes -->
        <div id="particle-container" class="absolute inset-0 pointer-events-none" aria-hidden="true"></div>
        
        <!-- Onda do oceano -->
        <div class="ocean-wave" aria-hidden="true"></div>
        
        <!-- Conteúdo principal -->
        <div class="z-10 w-full max-w-4xl mx-auto safe-area">
            <!-- Frase imersiva -->
            <h1 class="immersive-phrase text-shadow-glow mb-6" id="main-title">
                <span id="intro-typing-text" aria-live="polite">Conectando com Búzios...</span>
                <span class="typing-cursor" aria-hidden="true">|</span>
            </h1>
            
            <!-- Subtítulo -->
            <p class="text-lg md:text-xl text-slate-200 max-w-3xl mx-auto mb-8 text-shadow-soft">
                Você está falando com a <strong class="font-semibold text-white">IA do Conexão Búzios</strong>. 
                Suas respostas me guiam até a proposta perfeita para você.
            </p>
            
            <!-- Indicador de progresso inicial -->
            <div class="progress-container mx-auto mb-8">
                <div id="progress-bar" class="progress-bar" style="width: 0%" role="progressbar" aria-label="Progresso da conversa"></div>
            </div>
        </div>
        
        <!-- Área de ações do portal -->
        <div id="portal-actions" class="z-10 w-full max-w-2xl px-4 safe-area">
            <!-- Carregará dinamicamente -->
        </div>
        
        <!-- Assinatura animada -->
        <div id="animated-signature" class="signature-container absolute bottom-8 w-full text-center text-sm text-slate-300 font-light safe-area">
            <div class="signature-part">
                Um projeto 
                <a href="https://www.instagram.com/conexao.buzios/" 
                   target="_blank" 
                   rel="noopener noreferrer" 
                   class="font-medium text-slate-200 hover:text-white transition-colors duration-300 underline decoration-dotted">
                    Conexão Búzios
                </a>
            </div>
            <div class="signature-part mt-1">
                • Potencializado pela IA Gemini
            </div>
        </div>
    </div>
    
    <!-- Container do Chat -->
    <div id="app-container" class="min-h-screen w-full flex flex-col items-center justify-center p-4 bg-gradient-to-br from-slate-900 to-slate-800 hidden">
        <div class="w-full max-w-2xl h-full max-h-[90vh] flex flex-col chat-container rounded-3xl shadow-2xl overflow-hidden">
            
            <!-- Cabeçalho do chat -->
            <header class="flex items-center justify-between p-6 border-b border-white/10 bg-white/90 backdrop-blur-sm">
                <div class="flex items-center space-x-4">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-600 to-blue-700 flex items-center justify-center shadow-lg">
                        <svg class="w-7 h-7 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                        <span class="sr-only">Avatar do Conexão Búzios</span>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold text-slate-800">Conexão Búzios</h1>
                        <p class="text-sm text-slate-600 flex items-center">
                            <span class="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse" aria-hidden="true"></span>
                            <span id="step-indicator">Iniciando conversa...</span>
                        </p>
                    </div>
                </div>
            </header>
            
            <!-- Janela do chat -->
            <main id="chat-window" 
                  class="flex-1 p-6 flex flex-col space-y-4 overflow-y-auto bg-gradient-to-br from-slate-50 to-white"
                  role="log" 
                  aria-live="polite" 
                  aria-label="Conversa com a IA">
                <!-- Mensagens serão inseridas aqui -->
            </main>
            
            <!-- Área de input -->
            <footer id="input-area" class="p-6 bg-white/90 border-t border-white/10 backdrop-blur-sm">
                <!-- Será preenchido dinamicamente -->
            </footer>
            
            <!-- Controles da sessão -->
            <div id="session-controls" class="p-4 text-center bg-white/90 border-t border-white/10 backdrop-blur-sm">
                <p class="text-xs text-slate-500 mb-3 flex items-center justify-center gap-2">
                    <svg class="w-3 h-3 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Conversa segura e privada com IA Gemini
                </p>
                <div class="flex justify-center items-center space-x-6">
                    <button onclick="App.goBack()" 
                            id="back-btn" 
                            class="btn-base text-xs text-slate-600 font-medium gap-2 px-3 py-2 rounded-lg hover:text-blue-600 hover:bg-slate-100 transition-all duration-200"
                            aria-label="Voltar para a pergunta anterior">
                        <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                        </svg>
                        Voltar
                    </button>
                    <button onclick="App.restart()" 
                            class="btn-base text-xs text-slate-600 font-medium gap-2 px-3 py-2 rounded-lg hover:text-red-500 hover:bg-red-50 transition-all duration-200"
                            aria-label="Reiniciar conversa do início">
                        <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                        Reiniciar
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        'use strict';
        
        // ============= SISTEMA PRINCIPAL =============
        const App = (() => {
            // Configurações
            const CONFIG = {
                BACKEND_URL: "https://script.google.com/macros/s/AKfycbwHC3bAoL_c5rscJV2xbwVi9KMedM3QHbWCZ3bo64w0DbiMGOtnahL9BynJ5ADao63I/exec",
                SESSION_KEY: 'conexaoBuziosSession',
                MAX_RETRIES: 3,
                TYPING_SPEED: 80,
                PARTICLE_COUNT: 25,
                DEBUG: true
            };
            
            // Estado da aplicação
            let state = {
                history: [],
                chatLog: [],
                currentStepId: 'start',
                isWaitingForResponse: false,
                userData: {},
                userHistory: {},
                currentStep: 1,
                totalSteps: 8,
                isInitialized: false
            };
            
            // Cache de elementos DOM
            const elements = {};
            
            // Frases para o portal
            const phrases = [
                "Imagine encontrar o paraíso...",
                "E ele começar a conversar com você.",
                "Búzios espera por sua chegada.",
                "Sua jornada perfeita começa aqui."
            ];
            
            // Fluxo de conversa
            const conversationFlow = {
                'start': { 
                    message: "✨ Que bom te ver por aqui! Sou seu amigo pessoal em Búzios, pronto para revelar todos os segredos da cidade. Para começar nossa jornada, me conta: qual dessas opções combina mais com seu coração?", 
                    type: 'buttons', 
                    variable: 'perfil', 
                    options: [ 
                        { text: '🏖️ Sou Turista Sonhador', value: 'turista', nextStep: 'turista_1' }, 
                        { text: '🏠 Sou Morador Local', value: 'morador', nextStep: 'morador_1' }, 
                        { text: '📢 Quero Divulgar', value: 'divulgador', nextStep: 'divulgador_1' } 
                    ],
                    step: 1
                },
                
                'turista_1': { 
                    message: "🌊 Maravilha! Búzios tem uma energia mágica que transforma qualquer pessoa. Me conta, como está sua aventura neste momento?", 
                    type: 'buttons', 
                    variable: 'momento_viagem', 
                    options: [ 
                        { text: '☀️ Já estou aqui curtindo', value: 'presente', nextStep: 'turista_2' }, 
                        { text: '🧳 Chego nos próximos dias', value: 'breve', nextStep: 'turista_2' }, 
                        { text: '🗓️ Estou planejando para breve', value: 'planejando', nextStep: 'turista_2' }, 
                        { text: '🗺️ Só explorando ideias', value: 'explorando', nextStep: 'turista_2' } 
                    ],
                    step: 2
                },
                
                'turista_2': { 
                    message: "💫 Perfeito! E quem são as pessoas especiais que vão compartilhar essa experiência única com você?", 
                    type: 'buttons', 
                    variable: 'companhia', 
                    options: [ 
                        { text: '👤 Sozinho(a), na minha própria vibe', value: 'solo', nextStep: 'ask_name' }, 
                        { text: '❤️ Com meu grande amor', value: 'casal', nextStep: 'ask_name' }, 
                        { text: '🍻 Com a galera toda', value: 'amigos', nextStep: 'ask_name' }, 
                        { text: '👨‍👩‍👧‍👦 Com minha família querida', value: 'familia', nextStep: 'ask_name' } 
                    ],
                    step: 3
                },
                
                'morador_1': { 
                    message: "🤝 E aí, vizinho querido! Que alegria te encontrar. Há quanto tempo este paraíso é a sua casa?", 
                    type: 'buttons', 
                    variable: 'tempo_moradia', 
                    options: [ 
                        { text: '🌱 Cheguei há pouco (menos de 1 ano)', value: 'novo', nextStep: 'ask_name' }, 
                        { text: '🌿 Já me adaptei (1 a 3 anos)', value: 'adaptado', nextStep: 'ask_name' }, 
                        { text: '🌳 Sou raiz! (mais de 3 anos)', value: 'veterano', nextStep: 'ask_name' }, 
                        { text: '✈️ Vivo na ponte-aérea', value: 'pendular', nextStep: 'ask_name' } 
                    ],
                    step: 2
                },
                
                'divulgador_1': { 
                    message: "🚀 Vamos fazer sua ideia brilhar como as estrelas de Búzios! O que você quer que todo mundo nesta cidade maravilhosa conheça?", 
                    type: 'buttons', 
                    variable: 'tipo_divulgacao', 
                    options: [ 
                        { text: '🛠️ Um serviço que presto', value: 'servico', nextStep: 'ask_name' }, 
                        { text: '🛍️ Um produto incrível', value: 'produto', nextStep: 'ask_name' }, 
                        { text: '🏠 Um imóvel dos sonhos', value: 'imovel', nextStep: 'ask_name' }, 
                        { text: '🎉 Um evento ou experiência', value: 'evento', nextStep: 'ask_name' } 
                    ],
                    step: 2
                },
                
                'ask_name': { 
                    message: "🌟 Como posso chamar você? Me conta seu nome para tornar nossa conversa ainda mais especial!", 
                    type: 'text', 
                    variable: 'nome', 
                    placeholder: 'Digite seu nome aqui...', 
                    nextStep: 'ask_phone', 
                    validation: 'text',
                    step: 6
                },
                
                'ask_phone': { 
                    message: "📲 E se eu encontrar aquela oportunidade única e perfeita para você, qual o melhor WhatsApp para te enviar um alô especial?", 
                    type: 'tel', 
                    variable: 'telefone', 
                    placeholder: '(11) 99999-9999', 
                    nextStep: 'generate_proposal', 
                    validation: 'phone',
                    step: 7
                },
                
                'generate_proposal': { 
                    message: "🔮 Conectando todos os pontos mágicos... Estou criando algo verdadeiramente especial e único para você. A magia está acontecendo!", 
                    type: 'loading', 
                    action: 'callBackend',
                    step: 8
                },
                
                'final_message': { 
                    type: 'final',
                    step: 8
                }
            };
            
            // ============= UTILITÁRIOS =============
            const Utils = {
                log: function(message, data = null) {
                    if (CONFIG.DEBUG) {
                        console.log(`[Conexão Búzios] ${message}`, data || '');
                    }
                },
                
                error: function(message, error = null) {
                    console.error(`[Conexão Búzios ERROR] ${message}`, error || '');
                },
                
                sanitizeHtml: function(str) {
                    const div = document.createElement('div');
                    div.textContent = str;
                    return div.innerHTML;
                },
                
                validateInput: function(value, type) {
                    switch (type) {
                        case 'text':
                            if (!value || value.trim().length < 2) {
                                return { isValid: false, message: 'Por favor, insira um nome válido (mínimo 2 caracteres).' };
                            }
                            return { isValid: true };
                        case 'phone':
                            const phoneDigits = value.replace(/\D/g, '');
                            if (phoneDigits.length < 10 || phoneDigits.length > 11) {
                                return { isValid: false, message: 'Por favor, insira um telefone válido com DDD.' };
                            }
                            return { isValid: true };
                        default:
                            return { isValid: true };
                    }
                },
                
                debounce: function(func, wait) {
                    let timeout;
                    return function executedFunction(...args) {
                        const later = () => {
                            clearTimeout(timeout);
                            func(...args);
                        };
                        clearTimeout(timeout);
                        timeout = setTimeout(later, wait);
                    };
                },
                
                formatPhoneNumber: function(value) {
                    const numbers = value.replace(/\D/g, '');
                    if (numbers.length === 11) {
                        return numbers.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
                    } else if (numbers.length === 10) {
                        return numbers.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
                    }
                    return value;
                }
            };
            
            // ============= GERENCIAMENTO DE ESTADO =============
            const StateManager = {
                save: function() {
                    try {
                        localStorage.setItem(CONFIG.SESSION_KEY, JSON.stringify(state));
                        Utils.log('Estado salvo com sucesso');
                    } catch (e) {
                        Utils.error('Erro ao salvar estado', e);
                    }
                },
                
                load: function() {
                    try {
                        const savedState = localStorage.getItem(CONFIG.SESSION_KEY);
                        if (savedState) {
                            const parsed = JSON.parse(savedState);
                            // Validar estrutura do estado
                            if (parsed && typeof parsed === 'object') {
                                state = { ...state, ...parsed };
                                Utils.log('Estado restaurado com sucesso');
                                return true;
                            }
                        }
                        return false;
                    } catch (e) {
                        Utils.error('Erro ao carregar estado', e);
                        localStorage.removeItem(CONFIG.SESSION_KEY);
                        return false;
                    }
                },
                
                update: function(newState) {
                    state = { ...state, ...newState };
                    this.save();
                    UI.updateProgress();
                },
                
                pushHistory: function() {
                    const snapshot = JSON.parse(JSON.stringify(state));
                    const newHistory = [...(state.history || []), snapshot];
                    this.update({ history: newHistory });
                },
                
                clear: function() {
                    localStorage.removeItem(CONFIG.SESSION_KEY);
                    state = {
                        history: [],
                        chatLog: [],
                        currentStepId: 'start',
                        isWaitingForResponse: false,
                        userData: {},
                        userHistory: {},
                        currentStep: 1,
                        totalSteps: 8,
                        isInitialized: false
                    };
                    Utils.log('Estado limpo');
                }
            };
            
            // ============= GERENCIAMENTO DE DOM =============
            const DOMManager = {
                cache: function() {
                    const selectors = {
                        introPortal: '#ai-intro-portal',
                        appContainer: '#app-container',
                        portalActions: '#portal-actions',
                        typingText: '#intro-typing-text',
                        chatWindow: '#chat-window',
                        inputArea: '#input-area',
                        backBtn: '#back-btn',
                        signature: '#animated-signature',
                        stepIndicator: '#step-indicator',
                        progressBar: '#progress-bar',
                        particleContainer: '#particle-container'
                    };
                    
                    for (const [key, selector] of Object.entries(selectors)) {
                        elements[key] = document.querySelector(selector);
                        if (!elements[key]) {
                            Utils.error(`Elemento não encontrado: ${selector}`);
                        }
                    }
                    
                    Utils.log('Elementos DOM cacheados', Object.keys(elements));
                },
                
                safely: function(element, callback) {
                    if (element && typeof callback === 'function') {
                        try {
                            return callback(element);
                        } catch (e) {
                            Utils.error('Erro ao executar callback DOM', e);
                        }
                    }
                    return null;
                }
            };
            
            // ============= INTERFACE DE USUÁRIO =============
            const UI = {
                createParticles: function() {
                    if (!elements.particleContainer) return;
                    
                    // Limpar partículas existentes
                    elements.particleContainer.innerHTML = '';
                    
                    for (let i = 0; i < CONFIG.PARTICLE_COUNT; i++) {
                        const particle = document.createElement('div');
                        particle.className = 'particle';
                        
                        const size = Math.random() * 4 + 2;
                        particle.style.width = `${size}px`;
                        particle.style.height = `${size}px`;
                        particle.style.left = `${Math.random() * 100}%`;
                        particle.style.top = `${Math.random() * 100}%`;
                        particle.style.animationDuration = `${Math.random() * 15 + 15}s`;
                        particle.style.animationDelay = `${Math.random() * 10}s`;
                        
                        elements.particleContainer.appendChild(particle);
                    }
                    
                    Utils.log('Partículas criadas');
                },
                
                typeWriter: function(text, callback) {
                    if (!elements.typingText) return;
                    
                    let i = 0;
                    elements.typingText.textContent = '';
                    
                    function type() {
                        if (i < text.length) {
                            elements.typingText.textContent += text.charAt(i);
                            i++;
                            setTimeout(type, CONFIG.TYPING_SPEED);
                        } else if (callback) {
                            callback();
                        }
                    }
                    
                    type();
                },
                
                updateProgress: function() {
                    const progress = Math.min((state.currentStep / state.totalSteps) * 100, 100);
                    
                    DOMManager.safely(elements.progressBar, (el) => {
                        el.style.width = `${progress}%`;
                        el.setAttribute('aria-valuenow', progress);
                    });
                    
                    DOMManager.safely(elements.stepIndicator, (el) => {
                        if (state.currentStep <= state.totalSteps) {
                            el.textContent = `Conversando • Etapa ${state.currentStep} de ${state.totalSteps}`;
                        } else {
                            el.textContent = 'Conversa finalizada';
                        }
                    });
                },
                
                addMessage: function(text, sender) {
                    if (!elements.chatWindow) return;
                    
                    const messageEl = document.createElement('div');
                    messageEl.className = `chat-bubble ${sender}`;
                    messageEl.innerHTML = Utils.sanitizeHtml(text).replace(/\n/g, '<br>');
                    
                    elements.chatWindow.appendChild(messageEl);
                    
                    // Scroll suave para baixo
                    setTimeout(() => {
                        elements.chatWindow.scrollTop = elements.chatWindow.scrollHeight;
                    }, 100);
                    
                    // Atualizar estado
                    const newChatLog = [...state.chatLog, { text, sender }];
                    StateManager.update({ chatLog: newChatLog });
                    
                    Utils.log(`Mensagem adicionada: ${sender}`);
                },
                
                showTypingIndicator: function(show) {
                    if (!elements.chatWindow) return;
                    
                    const existing = document.getElementById('typing-indicator');
                    if (existing) existing.remove();
                    
                    if (show) {
                        const indicator = document.createElement('div');
                        indicator.id = 'typing-indicator';
                        indicator.className = 'chat-bubble ai typing-indicator';
                        indicator.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
                        
                        elements.chatWindow.appendChild(indicator);
                        elements.chatWindow.scrollTop = elements.chatWindow.scrollHeight;
                    }
                },
                
                disableInputs: function(disabled) {
                    const inputs = document.querySelectorAll('button:not([data-system]), input');
                    inputs.forEach(input => {
                        input.disabled = disabled;
                    });
                    StateManager.update({ isWaitingForResponse: disabled });
                },
                
                showInputError: function(input, message) {
                    if (!input) return;
                    
                    const originalPlaceholder = input.placeholder;
                    input.classList.add('error');
                    input.value = '';
                    input.placeholder = message;
                    
                    setTimeout(() => {
                        input.classList.remove('error');
                        input.placeholder = originalPlaceholder;
                    }, 3000);
                },
                
                transitionToChat: function() {
                    DOMManager.safely(elements.signature, (el) => {
                        el.classList.add('visible');
                    });
                    
                    DOMManager.safely(elements.introPortal, (el) => {
                        el.style.opacity = '0';
                        setTimeout(() => {
                            el.style.display = 'none';
                            DOMManager.safely(elements.appContainer, (container) => {
                                container.classList.remove('hidden');
                                container.classList.add('flex');
                            });
                        }, 600);
                    });
                    
                    Utils.log('Transição portal -> chat');
                }
            };
            
            // ============= RENDERIZAÇÃO =============
            const Renderer = {
                renderStep: function(stepId) {
                    Utils.log(`Renderizando step: ${stepId}`);
                    
                    const step = conversationFlow[stepId];
                    if (!step) {
                        Utils.error(`Step não encontrado: ${stepId}`);
                        return;
                    }
                    
                    StateManager.update({
                        currentStepId: stepId,
                        currentStep: step.step || state.currentStep
                    });
                    
                    const isPortalStep = stepId === 'start';
                    const container = isPortalStep ? elements.portalActions : elements.inputArea;
                    
                    if (!container) {
                        Utils.error('Container não encontrado');
                        return;
                    }
                    
                    container.innerHTML = '';
                    
                    if (!isPortalStep) {
                        UI.showTypingIndicator(true);
                        setTimeout(() => {
                            UI.showTypingIndicator(false);
                            if (step.message) {
                                UI.addMessage(step.message, 'ai');
                            }
                            this.renderInputs(step, container);
                        }, 1200);
                    } else {
                        if (state.chatLog.length === 0) {
                            UI.addMessage(step.message, 'ai');
                        }
                        this.renderInputs(step, container);
                    }
                },
                
                renderInputs: function(step, container) {
                    switch (step.type) {
                        case 'buttons':
                            this.renderButtons(step, container);
                            break;
                        case 'text':
                        case 'tel':
                            this.renderTextInput(step, container);
                            break;
                        case 'loading':
                            this.renderLoading(container);
                            if (step.action === 'callBackend') {
                                setTimeout(() => Backend.call(), 2000);
                            }
                            break;
                        case 'final':
                            this.renderFinal(container);
                            break;
                    }
                },
                
                renderButtons: function(step, container) {
                    const isPortalStep = state.currentStepId === 'start';
                    
                    let html = '';
                    if (isPortalStep) {
                        html += `
                            <div class="text-slate-200 text-base mb-6 no-select">
                                <svg class="w-5 h-5 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                                </svg>
                                Para começar nossa jornada, escolha sua categoria:
                            </div>
                        `;
                    }
                    
                    const wrapperClass = isPortalStep ? 
                        'btn-group-mobile flex flex-col sm:flex-row gap-4 justify-center' : 
                        'flex flex-col gap-3';
                        
                    const buttonClass = isPortalStep ? 
                        'btn-base btn-portal font-semibold' : 
                        'btn-base btn-chat text-left justify-start';
                    
                    const buttonsHTML = step.options.map(opt => `
                        <button 
                            onclick="App.handleChoice('${opt.value}', '${Utils.sanitizeHtml(opt.text)}', '${step.variable}', '${opt.nextStep}')" 
                            class="${buttonClass}"
                            aria-label="${Utils.sanitizeHtml(opt.text)}">
                            ${opt.text}
                        </button>
                    `).join('');
                    
                    html += `<div class="${wrapperClass}">${buttonsHTML}</div>`;
                    container.innerHTML = html;
                },
                
                renderTextInput: function(step, container) {
                    const iconSvg = step.type === 'tel' ? 
                        `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />` :
                        `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />`;
                    
                    container.innerHTML = `
                        <form onsubmit="App.handleFormSubmit(event, '${step.nextStep}', '${step.variable}', '${step.validation}')" class="flex space-x-3">
                            <div class="input-container flex-1">
                                <div class="input-icon">
                                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                        ${iconSvg}
                                    </svg>
                                </div>
                                <input 
                                    type="${step.type}" 
                                    id="text-input" 
                                    required 
                                    class="input-field" 
                                    placeholder="${step.placeholder}"
                                    aria-label="${Utils.sanitizeHtml(step.message)}"
                                    autocomplete="${step.type === 'tel' ? 'tel' : 'name'}">
                            </div>
                            <button 
                                type="submit" 
                                class="btn-base btn-primary"
                                aria-label="Enviar resposta">
                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                                </svg>
                            </button>
                        </form>
                    `;
                    
                    const input = document.getElementById('text-input');
                    if (input) {
                        input.focus();
                        
                        // Formatação automática para telefone
                        if (step.type === 'tel') {
                            input.addEventListener('input', Utils.debounce((e) => {
                                e.target.value = Utils.formatPhoneNumber(e.target.value);
                            }, 100));
                        }
                    }
                },
                
                renderLoading: function(container) {
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <div class="loading-spinner mx-auto mb-4"></div>
                            <p class="text-sm text-slate-600">
                                Criando sua experiência personalizada...
                            </p>
                        </div>
                    `;
                },
                
                renderFinal: function(container) {
                    container.innerHTML = `
                        <div class="text-center space-y-6">
                            <div class="w-16 h-16 bg-gradient-to-br from-green-500 to-green-600 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg class="w-8 h-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                </svg>
                            </div>
                            <h3 class="text-xl font-bold text-slate-800 mb-2">✨ Sua proposta está pronta!</h3>
                            <p class="text-slate-600">Criamos algo especial pensando em você</p>
                            
                            <div class="bg-gradient-to-br from-white to-slate-50 p-6 rounded-xl border border-slate-200 shadow-sm">
                                <div class="text-slate-700 leading-relaxed">
                                    <strong>Baseado no seu perfil "${state.userData.perfil || 'visitante'}"</strong><br><br>
                                    Preparamos sugestões personalizadas que combinam perfeitamente com o que você busca em Búzios. 
                                    ${state.userData.telefone ? `Em breve você receberá no WhatsApp ${state.userData.telefone} todas as dicas exclusivas!` : 'Suas dicas especiais estão sendo preparadas!'}
                                </div>
                            </div>
                            
                            <button onclick="App.restart()" class="btn-base btn-primary">
                                🔁 Nova Conversa
                            </button>
                        </div>
                    `;
                }
            };
            
            // ============= BACKEND =============
            const Backend = {
                call: async function() {
                    const payload = {
                        nome: state.userData.nome || 'Usuário',
                        telefone: state.userData.telefone || '',
                        perfil: state.userData.perfil || 'visitante',
                        historico: Object.values(state.userHistory || {})
                    };
                    
                    Utils.log('Enviando para backend', payload);
                    
                    try {
                        const response = await fetch(CONFIG.BACKEND_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                action: 'processAndSaveDossier', 
                                data: payload
                            }),
                            mode: 'cors',
                        });
                        
                        const result = await response.json();
                        
                        if (result.success && result.data?.proposta_personalizada) {
                            UI.addMessage(result.data.proposta_personalizada, 'ai');
                            Utils.log('Proposta recebida do backend');
                        } else {
                            throw new Error(result.error || 'Resposta inválida do backend');
                        }
                        
                    } catch (error) {
                        Utils.error('Erro no backend', error);
                        UI.addMessage('Proposta criada! Em breve você receberá mais detalhes sobre as melhores experiências em Búzios.', 'ai');
                    }
                    
                    Renderer.renderStep('final_message');
                }
            };
            
            // ============= HANDLERS DE EVENTOS =============
            const EventHandlers = {
                handleChoice: function(value, text, variable, nextStep) {
                    if (state.isWaitingForResponse) return;
                    
                    UI.disableInputs(true);
                    StateManager.pushHistory();
                    
                    UI.addMessage(text, 'user');
                    
                    if (variable && value) {
                        const userData = { ...state.userData, [variable]: value };
                        const userHistory = { 
                            ...state.userHistory, 
                            [variable]: { 
                                question: state.chatLog[state.chatLog.length - 2]?.text || '', 
                                answer: text 
                            }
                        };
                        StateManager.update({ userData, userHistory });
                    }
                    
                    // Transição do portal para chat
                    if (state.currentStepId === 'start') {
                        setTimeout(() => {
                            UI.transitionToChat();
                            setTimeout(() => Renderer.renderStep(nextStep), 800);
                        }, 300);
                    } else {
                        setTimeout(() => Renderer.renderStep(nextStep), 500);
                    }
                },
                
                handleFormSubmit: function(event, nextStep, variable, validation) {
                    event.preventDefault();
                    
                    const input = document.getElementById('text-input');
                    if (!input) return;
                    
                    const value = input.value.trim();
                    const validationResult = Utils.validateInput(value, validation);
                    
                    if (!validationResult.isValid) {
                        UI.showInputError(input, validationResult.message);
                        return;
                    }
                    
                    UI.disableInputs(true);
                    StateManager.pushHistory();
                    
                    UI.addMessage(value, 'user');
                    
                    if (variable) {
                        const userData = { ...state.userData, [variable]: value };
                        const userHistory = { 
                            ...state.userHistory, 
                            [variable]: { 
                                question: state.chatLog[state.chatLog.length - 2]?.text || '', 
                                answer: value 
                            }
                        };
                        StateManager.update({ userData, userHistory });
                    }
                    
                    setTimeout(() => Renderer.renderStep(nextStep), 500);
                },
                
                goBack: function() {
                    if (state.history.length < 2) return;
                    
                    const previousState = state.history[state.history.length - 2];
                    state = { ...state, ...previousState };
                    state.history.pop();
                    StateManager.save();
                    
                    // Reconstruir chat
                    if (elements.chatWindow) {
                        elements.chatWindow.innerHTML = '';
                        state.chatLog.forEach(msg => {
                            const messageEl = document.createElement('div');
                            messageEl.className = `chat-bubble ${msg.sender}`;
                            messageEl.innerHTML = Utils.sanitizeHtml(msg.text).replace(/\n/g, '<br>');
                            elements.chatWindow.appendChild(messageEl);
                        });
                    }
                    
                    Renderer.renderStep(state.currentStepId);
                },
                
                restart: function() {
                    if (confirm('Tem certeza que deseja reiniciar a conversa? Todas as informações serão perdidas.')) {
                        StateManager.clear();
                        location.reload();
                    }
                }
            };
            
            // ============= INICIALIZAÇÃO =============
            const Initializer = {
                init: function() {
                    Utils.log('Iniciando aplicação...');
                    
                    try {
                        // Cache de elementos DOM
                        DOMManager.cache();
                        
                        // Criar partículas
                        UI.createParticles();
                        
                        // Iniciar animação de texto
                        let phraseIndex = 0;
                        const cyclePhrase = () => {
                            if (phraseIndex < phrases.length) {
                                UI.typeWriter(phrases[phraseIndex], () => {
                                    setTimeout(() => {
                                        phraseIndex = (phraseIndex + 1) % phrases.length;
                                        if (phraseIndex === 0 && !state.isInitialized) {
                                            // Primeira vez - iniciar conversa
                                            setTimeout(() => {
                                                StateManager.update({ isInitialized: true });
                                                Renderer.renderStep('start');
                                            }, 1000);
                                        } else {
                                            cyclePhrase();
                                        }
                                    }, 3000);
                                });
                            }
                        };
                        
                        // Mostrar aplicação
                        document.body.classList.remove('app-loading');
                        document.body.classList.add('app-ready');
                        
                        // Iniciar ciclo de frases
                        setTimeout(cyclePhrase, 500);
                        
                        Utils.log('Aplicação inicializada com sucesso');
                        
                    } catch (error) {
                        Utils.error('Erro na inicialização', error);
                        document.body.innerHTML = '<div class="min-h-screen flex items-center justify-center"><p class="text-white text-xl">Erro ao carregar a aplicação. Por favor, recarregue a página.</p></div>';
                    }
                }
            };
            
            // ============= API PÚBLICA =============
            return {
                // Métodos expostos globalmente
                handleChoice: EventHandlers.handleChoice,
                handleFormSubmit: EventHandlers.handleFormSubmit,
                goBack: EventHandlers.goBack,
                restart: EventHandlers.restart,
                
                // Para debug
                state: () => state,
                elements: () => elements,
                utils: Utils,
                
                // Inicialização
                init: Initializer.init
            };
        })();
        
        // ============= INICIALIZAÇÃO GLOBAL =============
        // Aguardar DOM completamente carregado
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', App.init);
        } else {
            // DOM já está pronto
            App.init();
        }
        
        // Expor App globalmente para debugging
        window.App = App;
        
        // Prevenir erros globais
        window.addEventListener('error', function(e) {
            console.error('[Global Error]', e.error);
            // Não recarregar automaticamente em produção
        });
        
        window.addEventListener('unhandledrejection', function(e) {
            console.error('[Unhandled Promise Rejection]', e.reason);
        });
        
    </script>
</body>
</html>
