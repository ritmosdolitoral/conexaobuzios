<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conex√£o B√∫zios - Seu Concierge Virtual</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { 
            font-family: 'Poppins', sans-serif; 
            background: linear-gradient(135deg, #020617 0%, #1e293b 100%);
            overflow-x: hidden;
        }
        
        /* Anima√ß√µes */
        .typing-cursor { 
            animation: blink 1s step-end infinite; 
        }
        
        @keyframes blink { 
            50% { opacity: 0; } 
        }
        
        .immersive-phrase {
            font-size: clamp(1.875rem, 5vw, 3rem);
            line-height: 1.2;
            background: linear-gradient(135deg, #ffffff 0%, #e2e8f0 50%, #94a3b8 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .text-shadow-glow {
            text-shadow: 0 0 8px rgba(59, 130, 246, 0.5), 0 0 20px rgba(59, 130, 246, 0.3);
        }
        
        .text-shadow-soft {
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        /* Bot√µes */
        .btn-enhanced {
            min-width: 140px;
            min-height: 48px;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .btn-enhanced:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.2);
        }
        
        .btn-enhanced:active {
            transform: scale(0.98);
        }
        
        .btn-enhanced:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .btn-portal {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
        
        .btn-chat {
            background: #ffffff;
            color: #374151;
            border: 1px solid #e5e7eb;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #0077B6 0%, #005a8a 100%);
            color: white;
            border: none;
        }
        
        /* Chat */
        .chat-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }
        
        .chat-bubble {
            max-width: 85%;
            padding: 16px 20px;
            border-radius: 20px;
            margin-bottom: 12px;
            line-height: 1.6;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.5s forwards;
        }
        
        .chat-bubble.ai {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            color: #374151;
            border-bottom-left-radius: 6px;
            align-self: flex-start;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        
        .chat-bubble.user {
            background: linear-gradient(135deg, #0077B6 0%, #005a8a 100%);
            color: white;
            border-bottom-right-radius: 6px;
            align-self: flex-end;
        }
        
        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Part√≠culas */
        .particle {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
            animation: float 25s infinite linear;
            pointer-events: none;
        }
        
        @keyframes float {
            0% { 
                transform: translateY(100vh) translateX(-10vw) scale(0); 
                opacity: 0; 
            }
            10% { 
                opacity: 0.15; 
                transform: translateY(90vh) translateX(0vw) scale(1); 
            }
            90% { 
                opacity: 0.15; 
                transform: translateY(10vh) translateX(10vw) scale(1); 
            }
            100% { 
                transform: translateY(-10vh) translateX(20vw) scale(0); 
                opacity: 0; 
            }
        }
        
        /* Ondas */
        .ocean-wave {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100px;
            background: linear-gradient(180deg, transparent 0%, rgba(59, 130, 246, 0.1) 100%);
            animation: wave-motion 8s ease-in-out infinite;
        }
        
        @keyframes wave-motion {
            0%, 100% { transform: translateX(0%) scaleY(1); }
            50% { transform: translateX(2%) scaleY(1.1); }
        }
        
        /* Loading */
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid #ffffff;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Indicador de digita√ß√£o */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 16px 20px;
        }
        
        .typing-indicator span {
            height: 8px;
            width: 8px;
            background-color: #9ca3af;
            border-radius: 50%;
            display: inline-block;
            animation: typing-bounce 1.4s infinite ease-in-out both;
        }
        
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing-bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
        
        /* Progresso */
        .progress-indicator {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 9999px;
            height: 4px;
            overflow: hidden;
        }
        
        .progress-bar {
            background: linear-gradient(90deg, #3b82f6, #06b6d4);
            height: 100%;
            border-radius: 9999px;
            transition: width 0.5s ease;
        }
        
        /* Assinatura */
        .signature-container {
            opacity: 0;
            transition: opacity 0.8s ease-in;
        }
        
        .signature-container.visible {
            opacity: 1;
        }
        
        .signature-part {
            display: inline-block;
            opacity: 0;
            transform: translateY(15px);
        }
        
        .signature-container.visible .signature-part {
            animation: signature-reveal 0.8s forwards cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        .signature-container.visible .signature-part:nth-child(2) {
            animation-delay: 0.4s;
        }
        
        @keyframes signature-reveal {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Responsividade */
        @media (max-width: 640px) {
            .btn-group-mobile {
                flex-direction: column;
                gap: 1rem;
            }
            .btn-group-mobile .btn-enhanced {
                width: 100%;
            }
        }
        
        /* Utilit√°rios */
        .hidden { display: none !important; }
        .flex { display: flex !important; }
    </style>
</head>
<body class="antialiased font-sans text-slate-100 min-h-screen">

    <!-- Portal de Introdu√ß√£o -->
    <div id="ai-intro-portal" class="min-h-screen w-full flex flex-col justify-center items-center text-center px-6 py-12 relative overflow-hidden">
        <!-- Part√≠culas flutuantes -->
        <div id="particle-container" class="absolute inset-0 pointer-events-none"></div>
        
        <!-- Onda do oceano -->
        <div class="ocean-wave"></div>
        
        <!-- Conte√∫do principal -->
        <div class="z-10 max-w-4xl mx-auto">
            <!-- Frase imersiva -->
            <h1 class="immersive-phrase text-shadow-glow mb-6">
                <span id="intro-typing-text" aria-live="polite">Imagine encontrar o para√≠so...</span>
                <span class="typing-cursor">|</span>
            </h1>
            
            <!-- Subt√≠tulo -->
            <p class="text-xl text-slate-200 max-w-3xl mx-auto mb-8 text-shadow-soft">
                Voc√™ est√° falando com a <strong class="font-semibold text-white">IA do Conex√£o B√∫zios</strong>. 
                Suas respostas me guiam at√© a proposta perfeita para voc√™.
            </p>
            
            <!-- Indicador de progresso inicial -->
            <div class="progress-indicator w-64 mx-auto mb-8">
                <div id="progress-bar" class="progress-bar w-0"></div>
            </div>
        </div>
        
        <!-- √Årea de a√ß√µes do portal -->
        <div id="portal-actions" class="z-10 w-full max-w-2xl px-4">
            <!-- Carregar√° dinamicamente -->
        </div>
        
        <!-- Assinatura animada -->
        <div id="animated-signature" class="signature-container absolute bottom-8 w-full text-center text-sm text-slate-300 font-light">
            <div class="signature-part">
                Um projeto 
                <a href="https://www.instagram.com/conexao.buzios/" 
                   target="_blank" 
                   rel="noopener noreferrer" 
                   class="font-medium text-slate-200 hover:text-white transition-colors duration-300 underline decoration-dotted">
                    Conex√£o B√∫zios
                </a>
            </div>
            <div class="signature-part mt-1">
                ‚Ä¢ Potencializado pela IA Gemini
            </div>
        </div>
    </div>
    
    <!-- Container do Chat -->
    <div id="app-container" class="min-h-screen w-full flex flex-col items-center justify-center p-4 bg-gradient-to-br from-slate-900 to-slate-800 hidden">
        <div class="w-full max-w-2xl h-full max-h-[90vh] flex flex-col chat-container rounded-3xl shadow-2xl overflow-hidden border border-white/10">
            
            <!-- Cabe√ßalho do chat -->
            <header class="flex items-center justify-between p-6 border-b border-white/10 bg-white/80">
                <div class="flex items-center space-x-4">
                    <div class="w-14 h-14 rounded-full bg-gradient-to-br from-blue-600 to-blue-700 flex items-center justify-center shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M5.52 19c.64-2.2 1.84-3 3.22-3h6.52c1.38 0 2.58.8 3.22 3"/>
                            <circle cx="12" cy="10" r="3"/>
                            <circle cx="12" cy="12" r="10"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-slate-800">Conex√£o B√∫zios</h1>
                        <p class="text-sm text-slate-600 flex items-center">
                            <span class="h-2 w-2 bg-green-500 rounded-full mr-2 animate-pulse"></span>
                            <span id="step-indicator">Conversando ‚Ä¢ Etapa 1</span>
                        </p>
                    </div>
                </div>
            </header>
            
            <!-- Janela do chat -->
            <main id="chat-window" 
                  class="flex-1 p-6 flex flex-col space-y-4 overflow-y-auto bg-gradient-to-br from-slate-50 to-white"
                  role="log" 
                  aria-live="polite" 
                  aria-label="Conversa com a IA">
                <!-- Mensagens ser√£o inseridas aqui -->
            </main>
            
            <!-- √Årea de input -->
            <footer id="input-area" class="p-6 bg-white/80 border-t border-white/10">
                <!-- Ser√° preenchido dinamicamente -->
            </footer>
            
            <!-- Controles da sess√£o -->
            <div id="session-controls" class="p-4 text-center bg-white/80 border-t border-white/10">
                <p class="text-xs text-slate-500 mb-3 flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Conversa segura e privada com IA Gemini
                </p>
                <div class="flex justify-center items-center space-x-6">
                    <button onclick="goBack()" 
                            id="back-btn" 
                            class="btn-enhanced text-xs text-slate-600 font-medium flex items-center gap-2 px-3 py-2 rounded-lg hover:text-blue-600 hover:bg-slate-100 transition-all duration-200"
                            aria-label="Voltar para a pergunta anterior">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                        </svg>
                        Voltar
                    </button>
                    <button onclick="restart()" 
                            class="btn-enhanced text-xs text-slate-600 font-medium flex items-center gap-2 px-3 py-2 rounded-lg hover:text-red-500 hover:bg-red-50 transition-all duration-200"
                            aria-label="Reiniciar conversa do in√≠cio">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                        Reiniciar
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Configura√ß√£o
        const GOOGLE_APP_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwHC3bAoL_c5rscJV2xbwVi9KMedM3QHbWCZ3bo64w0DbiMGOtnahL9BynJ5ADao63I/exec";
        const SESSION_KEY = 'conexaoBuziosSession';
        
        // Estado global
        let appState = {
            history: [],
            chatLog: [],
            currentStepId: 'start',
            isWaitingForResponse: false,
            userData: {},
            userHistory: {},
            currentStep: 1,
            totalSteps: 10
        };
        
        // Fluxo de conversa simplificado
        const conversationFlow = {
            'start': { 
                message: "‚ú® Que bom te ver por aqui! Sou seu amigo pessoal em B√∫zios, pronto para revelar todos os segredos da cidade. Para come√ßar nossa jornada, me conta: qual dessas op√ß√µes combina mais com seu cora√ß√£o?", 
                type: 'buttons', 
                variable: 'perfil', 
                options: [ 
                    { text: 'üèñÔ∏è Sou Turista Sonhador', value: 'turista', nextStep: 'turista_1' }, 
                    { text: 'üè† Sou Morador Local', value: 'morador', nextStep: 'morador_1' }, 
                    { text: 'üì¢ Quero Divulgar', value: 'divulgador', nextStep: 'divulgador_1' } 
                ],
                step: 1
            },
            
            'turista_1': { 
                message: "üåä Maravilha! B√∫zios tem uma energia m√°gica que transforma qualquer pessoa. Me conta, como est√° sua aventura neste momento?", 
                type: 'buttons', 
                variable: 'momento_viagem', 
                options: [ 
                    { text: '‚òÄÔ∏è J√° estou aqui curtindo', value: 'presente', nextStep: 'turista_2' }, 
                    { text: 'üß≥ Chego nos pr√≥ximos dias', value: 'breve', nextStep: 'turista_2' }, 
                    { text: 'üóìÔ∏è Estou planejando para breve', value: 'planejando', nextStep: 'turista_2' }, 
                    { text: 'üó∫Ô∏è S√≥ explorando ideias', value: 'explorando', nextStep: 'turista_2' } 
                ],
                step: 2
            },
            
            'turista_2': { 
                message: "üí´ Perfeito! E quem s√£o as pessoas especiais que v√£o compartilhar essa experi√™ncia √∫nica com voc√™?", 
                type: 'buttons', 
                variable: 'companhia', 
                options: [ 
                    { text: 'üë§ Sozinho(a), na minha pr√≥pria vibe', value: 'solo', nextStep: 'ask_name' }, 
                    { text: '‚ù§Ô∏è Com meu grande amor', value: 'casal', nextStep: 'ask_name' }, 
                    { text: 'üçª Com a galera toda', value: 'amigos', nextStep: 'ask_name' }, 
                    { text: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Com minha fam√≠lia querida', value: 'familia', nextStep: 'ask_name' } 
                ],
                step: 3
            },
            
            'morador_1': { 
                message: "ü§ù E a√≠, vizinho querido! Que alegria te encontrar. H√° quanto tempo este para√≠so √© a sua casa?", 
                type: 'buttons', 
                variable: 'tempo_moradia', 
                options: [ 
                    { text: 'üå± Cheguei h√° pouco (menos de 1 ano)', value: 'novo', nextStep: 'ask_name' }, 
                    { text: 'üåø J√° me adaptei (1 a 3 anos)', value: 'adaptado', nextStep: 'ask_name' }, 
                    { text: 'üå≥ Sou raiz! (mais de 3 anos)', value: 'veterano', nextStep: 'ask_name' }, 
                    { text: '‚úàÔ∏è Vivo na ponte-a√©rea', value: 'pendular', nextStep: 'ask_name' } 
                ],
                step: 2
            },
            
            'divulgador_1': { 
                message: "üöÄ Vamos fazer sua ideia brilhar como as estrelas de B√∫zios! O que voc√™ quer que todo mundo nesta cidade maravilhosa conhe√ßa?", 
                type: 'buttons', 
                variable: 'tipo_divulgacao', 
                options: [ 
                    { text: 'üõ†Ô∏è Um servi√ßo que presto', value: 'servico', nextStep: 'ask_name' }, 
                    { text: 'üõçÔ∏è Um produto incr√≠vel', value: 'produto', nextStep: 'ask_name' }, 
                    { text: 'üè† Um im√≥vel dos sonhos', value: 'imovel', nextStep: 'ask_name' }, 
                    { text: 'üéâ Um evento ou experi√™ncia', value: 'evento', nextStep: 'ask_name' } 
                ],
                step: 2
            },
            
            'ask_name': { 
                message: "üåü Como posso chamar voc√™? Me conta seu nome para tornar nossa conversa ainda mais especial!", 
                type: 'text', 
                variable: 'nome', 
                placeholder: 'Digite seu nome aqui...', 
                nextStep: 'ask_phone', 
                validation: 'text',
                step: 8
            },
            
            'ask_phone': { 
                message: "üì≤ E se eu encontrar aquela oportunidade √∫nica e perfeita para voc√™, qual o melhor WhatsApp para te enviar um al√¥ especial?", 
                type: 'tel', 
                variable: 'telefone', 
                placeholder: '(11) 99999-9999', 
                nextStep: 'generate_proposal', 
                validation: 'phone',
                step: 9
            },
            
            'generate_proposal': { 
                message: "üîÆ Conectando todos os pontos m√°gicos... Estou criando algo verdadeiramente especial e √∫nico para voc√™. A magia est√° acontecendo!", 
                type: 'loading', 
                action: 'callBackend'
            },
            
            'final_message': { 
                type: 'final' 
            }
        };
        
        // Fun√ß√µes principais
        function createParticles() {
            const container = document.getElementById('particle-container');
            if (!container) return;
            
            for (let i = 0; i < 30; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                const size = Math.random() * 6 + 2;
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                particle.style.left = `${Math.random() * 100}%`;
                particle.style.top = `${Math.random() * 100}%`;
                particle.style.animationDuration = `${Math.random() * 20 + 15}s`;
                particle.style.animationDelay = `${Math.random() * 10}s`;
                container.appendChild(particle);
            }
        }
        
        function updateProgress() {
            const progressBar = document.getElementById('progress-bar');
            const stepIndicator = document.getElementById('step-indicator');
            
            if (progressBar) {
                const progress = Math.min((appState.currentStep / appState.totalSteps) * 100, 100);
                progressBar.style.width = `${progress}%`;
            }
            
            if (stepIndicator) {
                stepIndicator.textContent = `Conversando ‚Ä¢ Etapa ${appState.currentStep} de ${appState.totalSteps}`;
            }
        }
        
        function addMessage(text, sender) {
            const chatWindow = document.getElementById('chat-window');
            if (!chatWindow) return;
            
            const messageEl = document.createElement('div');
            messageEl.className = `chat-bubble ${sender}`;
            messageEl.innerHTML = text.replace(/\n/g, '<br>');
            chatWindow.appendChild(messageEl);
            
            appState.chatLog.push({ text, sender });
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }
        
        function showTyping(show) {
            const chatWindow = document.getElementById('chat-window');
            const existing = document.getElementById('typing-indicator');
            
            if (existing) existing.remove();
            
            if (show && chatWindow) {
                const indicator = document.createElement('div');
                indicator.id = 'typing-indicator';
                indicator.className = 'chat-bubble ai typing-indicator';
                indicator.innerHTML = '<span></span><span></span><span></span>';
                chatWindow.appendChild(indicator);
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }
        }
        
        function renderStep(stepId) {
            console.log('Renderizando step:', stepId);
            const step = conversationFlow[stepId];
            if (!step) {
                console.error('Step n√£o encontrado:', stepId);
                return;
            }
            
            appState.currentStepId = stepId;
            appState.currentStep = step.step || appState.currentStep;
            updateProgress();
            
            const isPortalStep = stepId === 'start';
            const container = isPortalStep ? 
                document.getElementById('portal-actions') : 
                document.getElementById('input-area');
                
            if (!container) {
                console.error('Container n√£o encontrado');
                return;
            }
            
            container.innerHTML = '';
            
            if (!isPortalStep) {
                showTyping(true);
                setTimeout(() => {
                    showTyping(false);
                    if (step.message) addMessage(step.message, 'ai');
                    renderInputs(step, container);
                }, 1000);
            } else {
                // Para o step inicial, adicionar a mensagem imediatamente
                if (appState.chatLog.length === 0) {
                    addMessage(step.message, 'ai');
                }
                renderInputs(step, container);
            }
        }
        
        function renderInputs(step, container) {
            if (step.type === 'buttons') {
                renderButtons(step, container);
            } else if (step.type === 'text' || step.type === 'tel') {
                renderTextInput(step, container);
            } else if (step.type === 'loading') {
                renderLoading(container);
                if (step.action === 'callBackend') {
                    setTimeout(callBackend, 2000);
                }
            } else if (step.type === 'final') {
                renderFinal(container);
            }
        }
        
        function renderButtons(step, container) {
            const isPortalStep = appState.currentStepId === 'start';
            
            let html = '';
            if (isPortalStep) {
                html += `
                    <div class="text-slate-200 text-base mb-6">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                        </svg>
                        Para come√ßar nossa jornada, escolha sua categoria:
                    </div>
                `;
            }
            
            const wrapperClass = isPortalStep ? 
                'btn-group-mobile flex flex-col sm:flex-row gap-4 justify-center' : 
                'flex flex-col gap-3';
                
            const buttonClass = isPortalStep ? 
                'btn-enhanced btn-portal text-white font-semibold px-8 py-4 rounded-xl text-center' : 
                'btn-enhanced btn-chat w-full text-left p-4 rounded-xl border border-gray-200 hover:border-blue-600';
            
            const buttonsHTML = step.options.map(opt => `
                <button 
                    onclick="handleChoice('${opt.value}', '${opt.text}', '${step.variable}', '${opt.nextStep}')" 
                    class="${buttonClass}">
                    ${opt.text}
                </button>
            `).join('');
            
            html += `<div class="${wrapperClass}">${buttonsHTML}</div>`;
            container.innerHTML = html;
        }
        
        function renderTextInput(step, container) {
            const iconName = step.type === 'tel' ? 'phone' : 'user';
            const iconSvg = step.type === 'tel' ? 
                `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />` :
                `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />`;
            
            container.innerHTML = `
                <form onsubmit="handleFormSubmit(event, '${step.nextStep}', '${step.variable}', '${step.validation}')" class="flex space-x-3">
                    <div class="flex-1 relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                ${iconSvg}
                            </svg>
                        </div>
                        <input 
                            type="${step.type}" 
                            id="text-input" 
                            required 
                            class="w-full pl-12 pr-4 py-4 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                            placeholder="${step.placeholder}">
                    </div>
                    <button 
                        type="submit" 
                        class="btn-enhanced btn-primary px-6 py-4 rounded-xl font-semibold">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                        </svg>
                    </button>
                </form>
            `;
            
            document.getElementById('text-input').focus();
        }
        
        function renderLoading(container) {
            container.innerHTML = `
                <div class="text-center py-6">
                    <div class="loading-spinner mx-auto mb-4"></div>
                    <p class="text-sm text-slate-600">
                        Criando sua experi√™ncia personalizada...
                    </p>
                </div>
            `;
        }
        
        function renderFinal(container) {
            container.innerHTML = `
                <div class="text-center space-y-6">
                    <div class="w-16 h-16 bg-gradient-to-br from-green-500 to-green-600 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                    </div>
                    <h3 class="text-xl font-bold text-slate-800 mb-2">‚ú® Sua proposta est√° pronta!</h3>
                    <p class="text-slate-600">Criamos algo especial pensando em voc√™</p>
                    
                    <div class="bg-gradient-to-br from-white to-slate-50 p-6 rounded-xl border border-slate-200 shadow-sm">
                        <div class="text-slate-700 leading-relaxed">
                            <strong>Baseado no seu perfil "${appState.userData.perfil || 'turista'}"</strong><br><br>
                            Preparamos sugest√µes personalizadas que combinam perfeitamente com o que voc√™ busca em B√∫zios. 
                            Em breve voc√™ receber√° no WhatsApp ${appState.userData.telefone || ''} todas as dicas exclusivas!
                        </div>
                    </div>
                    
                    <button onclick="restart()" class="btn-enhanced btn-primary px-6 py-3 rounded-xl font-semibold">
                        üîÅ Nova Conversa
                    </button>
                </div>
            `;
        }
        
        // Handlers
        function handleChoice(value, text, variable, nextStep) {
            addMessage(text, 'user');
            
            if (variable) {
                appState.userData[variable] = value;
                appState.userHistory[variable] = {
                    question: appState.chatLog[appState.chatLog.length - 2]?.text || '',
                    answer: text
                };
            }
            
            appState.history.push(JSON.parse(JSON.stringify(appState)));
            
            // Transi√ß√£o do portal para chat
            if (appState.currentStepId === 'start') {
                const signature = document.getElementById('animated-signature');
                const portal = document.getElementById('ai-intro-portal');
                const chat = document.getElementById('app-container');
                
                if (signature) signature.classList.add('visible');
                
                setTimeout(() => {
                    if (portal) portal.style.opacity = '0';
                    setTimeout(() => {
                        if (portal) portal.style.display = 'none';
                        if (chat) {
                            chat.classList.remove('hidden');
                            chat.classList.add('flex');
                        }
                        renderStep(nextStep);
                    }, 800);
                }, 100);
            } else {
                setTimeout(() => renderStep(nextStep), 500);
            }
        }
        
        function handleFormSubmit(event, nextStep, variable, validation) {
            event.preventDefault();
            const input = document.getElementById('text-input');
            const value = input.value.trim();
            
            // Valida√ß√£o
            if (validation === 'text' && value.length < 2) {
                alert('Por favor, insira um nome v√°lido (m√≠nimo 2 caracteres).');
                return;
            }
            if (validation === 'phone' && value.replace(/\D/g, '').length < 10) {
                alert('Por favor, insira um telefone v√°lido com DDD.');
                return;
            }
            
            addMessage(value, 'user');
            
            if (variable) {
                appState.userData[variable] = value;
                appState.userHistory[variable] = {
                    question: appState.chatLog[appState.chatLog.length - 2]?.text || '',
                    answer: value
                };
            }
            
            appState.history.push(JSON.parse(JSON.stringify(appState)));
            setTimeout(() => renderStep(nextStep), 500);
        }
        
        async function callBackend() {
            try {
                const response = await fetch(GOOGLE_APP_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'processAndSaveDossier', 
                        data: {
                            nome: appState.userData.nome || 'Usu√°rio',
                            telefone: appState.userData.telefone || '',
                            perfil: appState.userData.perfil || 'turista',
                            historico: Object.values(appState.userHistory || {})
                        }
                    }),
                    mode: 'cors',
                });
                
                const result = await response.json();
                if (result.success) {
                    addMessage(result.data.proposta_personalizada || 'Proposta gerada com sucesso!', 'ai');
                }
            } catch (error) {
                console.error('Erro no backend:', error);
                addMessage('Proposta criada! Em breve voc√™ receber√° mais detalhes.', 'ai');
            }
            
            renderStep('final_message');
        }
        
        function goBack() {
            if (appState.history.length < 2) return;
            
            const previousState = appState.history[appState.history.length - 2];
            appState = JSON.parse(JSON.stringify(previousState));
            appState.history.pop();
            
            // Reconstruir chat
            const chatWindow = document.getElementById('chat-window');
            if (chatWindow) {
                chatWindow.innerHTML = '';
                appState.chatLog.forEach(msg => {
                    const messageEl = document.createElement('div');
                    messageEl.className = `chat-bubble ${msg.sender}`;
                    messageEl.innerHTML = msg.text.replace(/\n/g, '<br>');
                    chatWindow.appendChild(messageEl);
                });
            }
            
            renderStep(appState.currentStepId);
        }
        
        function restart() {
            if (confirm('Tem certeza que deseja reiniciar a conversa?')) {
                localStorage.removeItem(SESSION_KEY);
                location.reload();
            }
        }
        
        // Inicializa√ß√£o
        function init() {
            console.log('Inicializando aplica√ß√£o...');
            
            // Criar part√≠culas
            createParticles();
            
            // Come√ßar conversa
            setTimeout(() => {
                console.log('Iniciando step start...');
                renderStep('start');
            }, 1000);
            
            console.log('Aplica√ß√£o inicializada!');
        }
        
        // Aguardar carregamento completo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
        
        // Debug
        window.appState = appState;
        window.renderStep = renderStep;
    </script>
</body>
</html>
