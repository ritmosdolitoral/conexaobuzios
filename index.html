<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conex√£o B√∫zios - Seu Concierge Virtual</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'buzios-deep': '#020617',
                        'buzios-slate': '#1e293b',
                        'buzios-blue': '#0077B6',
                        'buzios-light': '#F1F5F9',
                        'buzios-white': '#FFFFFF',
                        'buzios-mint': '#10b981',
                        'buzios-amber': '#f59e0b'
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            font-family: 'Poppins', sans-serif; 
            background: linear-gradient(135deg, #020617 0%, #1e293b 100%);
            overflow-x: hidden;
        }
        
        /* ========= VISIBILIDADE E CLAREZA ========= */
        .text-shadow-glow {
            text-shadow: 0 0 8px rgba(59, 130, 246, 0.5), 0 0 20px rgba(59, 130, 246, 0.3);
        }
        
        .text-shadow-soft {
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .backdrop-enhanced {
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            background: rgba(30, 41, 59, 0.8);
        }
        
        .container-safe {
            max-width: 48rem;
            margin: 0 auto;
            text-align: center;
        }
        
        /* ========= PORTAL DE INTRODU√á√ÉO ========= */
        #ai-intro-portal {
            background: radial-gradient(ellipse at center, #1e3a8a 0%, #020617 70%);
            transition: all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            overflow: hidden;
        }
        
        /* Anima√ß√£o de part√≠culas flutuantes */
        .particle {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
            animation: float 25s infinite linear;
            pointer-events: none;
        }
        
        @keyframes float {
            0% { 
                transform: translateY(100vh) translateX(-10vw) scale(0); 
                opacity: 0; 
            }
            10% { 
                opacity: 0.15; 
                transform: translateY(90vh) translateX(0vw) scale(1); 
            }
            90% { 
                opacity: 0.15; 
                transform: translateY(10vh) translateX(10vw) scale(1); 
            }
            100% { 
                transform: translateY(-10vh) translateX(20vw) scale(0); 
                opacity: 0; 
            }
        }
        
        /* Anima√ß√£o de digita√ß√£o */
        .typing-cursor { 
            animation: blink 1s step-end infinite; 
        }
        
        @keyframes blink { 
            50% { opacity: 0; } 
        }
        
        /* Frase imersiva animada */
        .immersive-phrase {
            font-size: clamp(1.875rem, 5vw, 3rem);
            line-height: 1.2;
            background: linear-gradient(135deg, #ffffff 0%, #e2e8f0 50%, #94a3b8 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: shimmer 3s ease-in-out infinite alternate;
        }
        
        @keyframes shimmer {
            0% { background-position: 0% 50%; }
            100% { background-position: 100% 50%; }
        }
        
        /* ========= BOT√ïES E INTERA√á√ïES ========= */
        .btn-enhanced {
            min-width: 140px;
            min-height: 48px;
            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .btn-enhanced:focus-visible {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }
        
        .btn-enhanced:active {
            transform: scale(0.98);
        }
        
        .btn-enhanced:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .btn-portal {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            animation: pulse-gentle 3s infinite;
        }
        
        .btn-portal:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.2);
        }
        
        @keyframes pulse-gentle {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.1);
            }
            50% {
                box-shadow: 0 0 20px 5px rgba(255, 255, 255, 0.05);
            }
        }
        
        .btn-chat {
            background: #ffffff;
            color: #374151;
            border: 1px solid #e5e7eb;
        }
        
        .btn-chat:hover:not(:disabled) {
            background: #f9fafb;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 119, 182, 0.15);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #0077B6 0%, #005a8a 100%);
            color: white;
            border: none;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, #005a8a 0%, #004d73 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 119, 182, 0.3);
        }
        
        /* ========= CHAT E MENSAGENS ========= */
        .chat-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .chat-bubble {
            max-width: 85%;
            padding: 16px 20px;
            border-radius: 20px;
            margin-bottom: 12px;
            opacity: 0;
            transform: translateY(20px);
            animation: message-appear 0.5s forwards cubic-bezier(0.25, 0.46, 0.45, 0.94);
            line-height: 1.6;
            position: relative;
        }
        
        .chat-bubble.ai {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            color: #374151;
            border-bottom-left-radius: 6px;
            align-self: flex-start;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid rgba(0, 119, 182, 0.1);
        }
        
        .chat-bubble.user {
            background: linear-gradient(135deg, #0077B6 0%, #005a8a 100%);
            color: white;
            border-bottom-right-radius: 6px;
            align-self: flex-end;
            box-shadow: 0 4px 20px rgba(0, 119, 182, 0.3);
        }
        
        @keyframes message-appear {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Indicador de digita√ß√£o */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 16px 20px;
        }
        
        .typing-indicator span {
            height: 8px;
            width: 8px;
            background-color: #9ca3af;
            border-radius: 50%;
            display: inline-block;
            animation: typing-bounce 1.4s infinite ease-in-out both;
        }
        
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing-bounce {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1.0);
            }
        }
        
        /* ========= ASSINATURA ANIMADA ========= */
        .signature-container {
            opacity: 0;
            transition: opacity 0.8s ease-in;
        }
        
        .signature-container.visible {
            opacity: 1;
        }
        
        .signature-part {
            display: inline-block;
            opacity: 0;
            transform: translateY(15px);
        }
        
        .signature-container.visible .signature-part {
            animation: signature-reveal 0.8s forwards cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        .signature-container.visible .signature-part:nth-child(2) {
            animation-delay: 0.4s;
        }
        
        @keyframes signature-reveal {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* ========= RESPONSIVIDADE ========= */
        @media (max-width: 320px) {
            .container-safe {
                padding: 1rem;
            }
            
            .btn-enhanced {
                min-width: 120px;
                min-height: 44px;
                font-size: 0.875rem;
            }
            
            .immersive-phrase {
                font-size: 1.5rem;
            }
        }
        
        @media (max-width: 640px) {
            .btn-group-mobile {
                flex-direction: column;
                gap: 1rem;
            }
            
            .btn-group-mobile .btn-enhanced {
                width: 100%;
            }
        }
        
        /* ========= ELEMENTOS VISUAIS B√öZIOS ========= */
        .ocean-wave {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100px;
            background: linear-gradient(180deg, transparent 0%, rgba(59, 130, 246, 0.1) 100%);
            animation: wave-motion 8s ease-in-out infinite;
        }
        
        @keyframes wave-motion {
            0%, 100% { transform: translateX(0%) scaleY(1); }
            50% { transform: translateX(2%) scaleY(1.1); }
        }
        
        /* ========= LOADING E TRANSI√á√ïES ========= */
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid #ffffff;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ========= PROGRESS INDICATOR ========= */
        .progress-indicator {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 9999px;
            height: 4px;
            overflow: hidden;
        }
        
        .progress-bar {
            background: linear-gradient(90deg, #3b82f6, #06b6d4);
            height: 100%;
            border-radius: 9999px;
            transition: width 0.5s ease;
        }
        
        /* ========= SHAKE ANIMATION ========= */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        /* ========= UTILIDADES ========= */
        .hidden { display: none !important; }
        .flex { display: flex !important; }
        
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
    </style>
</head>
<body class="antialiased font-sans text-slate-100">

    <!-- ========= PORTAL DE INTRODU√á√ÉO ========= -->
    <div id="ai-intro-portal" class="min-h-screen w-full flex flex-col justify-center items-center text-center px-6 py-12 relative overflow-hidden">
        <!-- Part√≠culas flutuantes -->
        <div id="particle-container" class="absolute inset-0 pointer-events-none"></div>
        
        <!-- Onda do oceano -->
        <div class="ocean-wave"></div>
        
        <!-- Conte√∫do principal -->
        <div class="z-10 container-safe">
            <!-- Frase imersiva -->
            <h1 class="immersive-phrase text-shadow-glow mb-6">
                <span id="intro-typing-text" aria-live="polite"></span>
                <span class="typing-cursor">|</span>
            </h1>
            
            <!-- Subt√≠tulo -->
            <p class="text-xl text-slate-200 max-w-3xl mx-auto mb-8 text-shadow-soft">
                Voc√™ est√° falando com a <strong class="font-semibold text-white">IA do Conex√£o B√∫zios</strong>. 
                Suas respostas me guiam at√© a proposta perfeita para voc√™.
            </p>
            
            <!-- Indicador de progresso inicial -->
            <div class="progress-indicator w-64 mx-auto mb-8">
                <div id="progress-bar" class="progress-bar w-0"></div>
            </div>
        </div>
        
        <!-- √Årea de a√ß√µes do portal -->
        <div id="portal-actions" class="z-10 w-full max-w-2xl px-4">
            <!-- Ser√° preenchido dinamicamente -->
        </div>
        
        <!-- Assinatura animada -->
        <div id="animated-signature" class="signature-container absolute bottom-8 w-full text-center text-sm text-slate-300 font-light">
            <div class="signature-part">
                Um projeto 
                <a href="https://www.instagram.com/conexao.buzios/" 
                   target="_blank" 
                   rel="noopener noreferrer" 
                   class="font-medium text-slate-200 hover:text-white transition-colors duration-300 underline decoration-dotted">
                    Conex√£o B√∫zios
                </a>
            </div>
            <div class="signature-part mt-1">
                ‚Ä¢ Potencializado pela IA Gemini
            </div>
        </div>
    </div>
    
    <!-- ========= CONTAINER DO CHAT ========= -->
    <div id="app-container" class="min-h-screen w-full flex flex-col items-center justify-center p-4 bg-gradient-to-br from-slate-900 to-slate-800 hidden">
        <div class="w-full max-w-2xl h-full max-h-[90vh] flex flex-col chat-container rounded-3xl shadow-2xl overflow-hidden border border-white/10">
            
            <!-- Cabe√ßalho do chat -->
            <header class="flex items-center justify-between p-6 border-b border-white/10 backdrop-enhanced">
                <div class="flex items-center space-x-4">
                    <div class="w-14 h-14 rounded-full bg-gradient-to-br from-blue-600 to-blue-700 flex items-center justify-center shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M5.52 19c.64-2.2 1.84-3 3.22-3h6.52c1.38 0 2.58.8 3.22 3"/>
                            <circle cx="12" cy="10" r="3"/>
                            <circle cx="12" cy="12" r="10"/>
                        </svg>
                        <span class="sr-only">Avatar do Conex√£o B√∫zios</span>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-slate-800">Conex√£o B√∫zios</h1>
                        <p class="text-sm text-slate-600 flex items-center">
                            <span class="h-2 w-2 bg-green-500 rounded-full mr-2 animate-pulse"></span>
                            <span id="step-indicator">Conversando ‚Ä¢ Etapa 1</span>
                        </p>
                    </div>
                </div>
                
                <!-- Bot√£o de informa√ß√µes -->
                <button id="info-btn" 
                        class="btn-enhanced p-3 rounded-xl text-slate-400 hover:text-blue-600 hover:bg-slate-100 transition-colors duration-200"
                        aria-label="Informa√ß√µes sobre a conversa">
                    <i data-lucide="info" class="w-5 h-5"></i>
                </button>
            </header>
            
            <!-- Janela do chat -->
            <main id="chat-window" 
                  class="flex-1 p-6 flex flex-col space-y-4 overflow-y-auto"
                  role="log" 
                  aria-live="polite" 
                  aria-label="Conversa com a IA">
                <!-- Mensagens ser√£o inseridas aqui dinamicamente -->
            </main>
            
            <!-- √Årea de input -->
            <footer id="input-area" class="p-6 backdrop-enhanced border-t border-white/10">
                <!-- Ser√° preenchido dinamicamente -->
            </footer>
            
            <!-- Controles da sess√£o -->
            <div id="session-controls" class="p-4 text-center backdrop-enhanced border-t border-white/10">
                <p class="text-xs text-slate-500 mb-3 flex items-center justify-center gap-2">
                    <i data-lucide="shield-check" class="w-3 h-3 text-green-500"></i>
                    Conversa segura e privada com IA Gemini
                </p>
                <div class="flex justify-center items-center space-x-6">
                    <button onclick="handleGoBack()" 
                            id="back-btn" 
                            class="btn-enhanced text-xs text-slate-600 font-medium flex items-center gap-2 px-3 py-2 rounded-lg hover:text-blue-600 hover:bg-slate-100 transition-all duration-200"
                            aria-label="Voltar para a pergunta anterior">
                        <i data-lucide="arrow-left" class="w-3 h-3"></i> 
                        Voltar
                    </button>
                    <button onclick="handleRestart()" 
                            class="btn-enhanced text-xs text-slate-600 font-medium flex items-center gap-2 px-3 py-2 rounded-lg hover:text-red-500 hover:bg-red-50 transition-all duration-200"
                            aria-label="Reiniciar conversa do in√≠cio">
                        <i data-lucide="refresh-cw" class="w-3 h-3"></i> 
                        Reiniciar
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ========= MODAL DE FEEDBACK ========= -->
    <div id="feedback-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 opacity-0 pointer-events-none transition-all duration-300">
        <div class="bg-white rounded-2xl p-6 max-w-md mx-4 transform scale-95 transition-transform duration-300">
            <div id="feedback-content" class="text-center">
                <!-- Ser√° preenchido dinamicamente -->
            </div>
        </div>
    </div>
    
    <script>
        // ========= CONFIGURA√á√ÉO INICIAL =========
        const GOOGLE_APP_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwHC3bAoL_c5rscJV2xbwVi9KMedM3QHbWCZ3bo64w0DbiMGOtnahL9BynJ5ADao63I/exec";
        const SESSION_KEY = 'conexaoBuziosSession';
        
        // Elementos da DOM - Declarados globalmente
        let introPortal, appContainer, portalActions, typingTextEl, chatWindow, inputArea, backBtn, animatedSignature, stepIndicator, progressBar, feedbackModal, feedbackContent;
        
        // Estado da aplica√ß√£o
        let state = {};
        const initialState = {
            history: [],
            chatLog: [],
            currentStepId: 'start',
            isWaitingForResponse: false,
            userData: {},
            userHistory: {},
            currentStep: 1,
            totalSteps: 10
        };
        
        // Frases imersivas para o portal
        const immersivePhrases = [
            "Imagine encontrar o para√≠so...",
            "E ele come√ßar a conversar com voc√™.",
            "Cada resposta sua revela um segredo.",
            "B√∫zios espera por voc√™.",
            "Sua jornada perfeita come√ßa aqui."
        ];
        
        let phraseIndex = 0;
        let typingTimeout;
        let currentTypingText = '';
        
        // ========= FLUXO DE CONVERSA =========
        const conversationFlow = {
            'start': { 
                message: "‚ú® Que bom te ver por aqui! Sou seu amigo pessoal em B√∫zios, pronto para revelar todos os segredos da cidade. Para come√ßar nossa jornada, me conta: qual dessas op√ß√µes combina mais com seu cora√ß√£o?", 
                type: 'buttons', 
                variable: 'perfil', 
                options: [ 
                    { text: 'üèñÔ∏è Sou Turista Sonhador', value: 'turista', nextStep: 'turista_1', icon: 'map-pin' }, 
                    { text: 'üè† Sou Morador Local', value: 'morador', nextStep: 'morador_1', icon: 'home' }, 
                    { text: 'üì¢ Quero Divulgar', value: 'divulgador', nextStep: 'divulgador_1', icon: 'megaphone' } 
                ],
                step: 1
            },
            
            'turista_1': { 
                message: "üåä Maravilha! B√∫zios tem uma energia m√°gica que transforma qualquer pessoa. Me conta, como est√° sua aventura neste momento?", 
                type: 'buttons', 
                variable: 'momento_viagem', 
                options: [ 
                    { text: '‚òÄÔ∏è J√° estou aqui curtindo', value: 'presente', nextStep: 'turista_2', icon: 'sun' }, 
                    { text: 'üß≥ Chego nos pr√≥ximos dias', value: 'breve', nextStep: 'turista_2', icon: 'luggage' }, 
                    { text: 'üóìÔ∏è Estou planejando para breve', value: 'planejando', nextStep: 'turista_2', icon: 'calendar' }, 
                    { text: 'üó∫Ô∏è S√≥ explorando ideias', value: 'explorando', nextStep: 'turista_2', icon: 'search' } 
                ],
                step: 2
            },
            
            'turista_2': { 
                message: "üí´ Perfeito! E quem s√£o as pessoas especiais que v√£o compartilhar essa experi√™ncia √∫nica com voc√™?", 
                type: 'buttons', 
                variable: 'companhia', 
                options: [ 
                    { text: 'üë§ Sozinho(a), na minha pr√≥pria vibe', value: 'solo', nextStep: 'turista_3', icon: 'user' }, 
                    { text: '‚ù§Ô∏è Com meu grande amor', value: 'casal', nextStep: 'turista_3', icon: 'heart' }, 
                    { text: 'üçª Com a galera toda', value: 'amigos', nextStep: 'turista_3', icon: 'users' }, 
                    { text: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Com minha fam√≠lia querida', value: 'familia', nextStep: 'turista_3', icon: 'home' } 
                ],
                step: 3
            },
            
            'turista_3': { 
                message: "üè° Excelente! E sobre seu cantinho especial para relaxar e recarregar as energias?", 
                type: 'buttons', 
                variable: 'hospedagem', 
                options: [ 
                    { text: '‚úÖ J√° tenho meu ref√∫gio', value: 'definida', nextStep: 'turista_4', icon: 'check-circle' }, 
                    { text: 'üîç Estou procurando o lugar ideal', value: 'procurando', nextStep: 'turista_4', icon: 'search' }, 
                    { text: 'ü§ó Vou ficar com amigos/fam√≠lia', value: 'conhecidos', nextStep: 'turista_4', icon: 'users' } 
                ],
                step: 4
            },
            
            'turista_4': { 
                message: "üéØ Agora a parte mais emocionante! Feche os olhos e imagine... O que seu cora√ß√£o mais deseja sentir aqui em B√∫zios?", 
                type: 'buttons', 
                variable: 'desejo_principal', 
                options: [ 
                    { text: 'üó∫Ô∏è Descobrir lugares secretos', value: 'descobrir', nextStep: 'turista_5', icon: 'map' }, 
                    { text: 'ü¶û Saborear experi√™ncias gastron√¥micas', value: 'gastronomia', nextStep: 'turista_5', icon: 'utensils' }, 
                    { text: 'üåô Curtir a vida noturna', value: 'noite', nextStep: 'turista_5', icon: 'moon' }, 
                    { text: 'üßò Relaxar e esquecer do mundo', value: 'relaxar', nextStep: 'turista_5', icon: 'leaf' }, 
                    { text: 'ü§ù Conectar com pessoas incr√≠veis', value: 'socializar', nextStep: 'turista_5', icon: 'users' } 
                ],
                step: 5
            },
            
            'turista_5': { 
                message: "üí≠ B√∫zios tem esse poder de encantar... Muitas pessoas se apaixonam tanto que sonham em ter um pedacinho daqui. J√° passou pela sua mente ter um cantinho seu neste para√≠so?", 
                type: 'buttons', 
                variable: 'interesse_negocio', 
                options: [ 
                    { text: '‚ú® Sim, seria um sonho!', value: 'muito_interesse', nextStep: 'turista_6', icon: 'star' }, 
                    { text: 'ü§î Talvez um dia...', value: 'interesse_medio', nextStep: 'turista_6', icon: 'help-circle' }, 
                    { text: 'üèñÔ∏è N√£o, s√≥ quero curtir', value: 'sem_interesse', nextStep: 'turista_6', icon: 'umbrella' } 
                ],
                step: 6
            },
            
            'turista_6': { 
                message: "üí∞ Para eu preparar as dicas mais certeiras para voc√™: qual seu investimento di√°rio ideal para viver B√∫zios intensamente?", 
                type: 'buttons', 
                variable: 'orcamento_diario', 
                options: [ 
                    { text: 'üí∏ At√© R$100 - Econ√¥mico', value: 'baixo', nextStep: 'transicao_nome', icon: 'dollar-sign' }, 
                    { text: 'üíµ R$100 a R$300 - Equilibrado', value: 'medio', nextStep: 'transicao_nome', icon: 'dollar-sign' }, 
                    { text: 'üí∞ R$300 a R$600 - Confort√°vel', value: 'alto', nextStep: 'transicao_nome', icon: 'dollar-sign' }, 
                    { text: 'üíé Acima de R$600 - Premium', value: 'premium', nextStep: 'transicao_nome', icon: 'gem' } 
                ],
                step: 7
            },
            
            'morador_1': { 
                message: "ü§ù E a√≠, vizinho querido! Que alegria te encontrar. H√° quanto tempo este para√≠so √© a sua casa?", 
                type: 'buttons', 
                variable: 'tempo_moradia', 
                options: [ 
                    { text: 'üå± Cheguei h√° pouco (menos de 1 ano)', value: 'novo', nextStep: 'morador_2', icon: 'clock' }, 
                    { text: 'üåø J√° me adaptei (1 a 3 anos)', value: 'adaptado', nextStep: 'morador_2', icon: 'calendar' }, 
                    { text: 'üå≥ Sou raiz! (mais de 3 anos)', value: 'veterano', nextStep: 'morador_2', icon: 'tree-pine' }, 
                    { text: '‚úàÔ∏è Vivo na ponte-a√©rea', value: 'pendular', nextStep: 'morador_2', icon: 'plane' } 
                ],
                step: 2
            },
            
            'morador_2': { 
                message: "üèÑ‚Äç‚ôÇÔ∏è Fant√°stico! E no seu dia a dia paradis√≠aco, qual √© a sua vibe preferida?", 
                type: 'buttons', 
                variable: 'estilo_vida', 
                options: [ 
                    { text: 'üßò Na paz, lendo na areia', value: 'tranquilo', nextStep: 'morador_3', icon: 'book-open' }, 
                    { text: 'üçª Gosto de um barzinho', value: 'social', nextStep: 'morador_3', icon: 'coffee' }, 
                    { text: 'üëü Trilha, surf e aventura', value: 'ativo', nextStep: 'morador_3', icon: 'activity' }, 
                    { text: 'üéâ Onde tem festa, eu estou!', value: 'festeiro', nextStep: 'morador_3', icon: 'music' } 
                ],
                step: 3
            },
            
            'morador_3': { 
                message: "üîÆ Se voc√™ tivesse um superpoder para melhorar uma coisa em B√∫zios, qual seria sua escolha?", 
                type: 'buttons', 
                variable: 'melhoria_desejada', 
                options: [ 
                    { text: 'ü§ù Conectar com mais pessoas', value: 'networking', nextStep: 'morador_4', icon: 'users' }, 
                    { text: 'üóìÔ∏è Saber de todos os eventos', value: 'eventos', nextStep: 'morador_4', icon: 'calendar' }, 
                    { text: 'üì¢ Fazer meu trabalho decolar!', value: 'trabalho', nextStep: 'morador_4', icon: 'trending-up' }, 
                    { text: 'üíé Ter acesso a dicas VIP', value: 'beneficios', nextStep: 'morador_4', icon: 'star' } 
                ],
                step: 4
            },
            
            'morador_4': { 
                message: "‚ú® Muitos moradores t√™m talentos incr√≠veis escondidos. Voc√™ tem algo especial que gostaria de compartilhar com mais pessoas?", 
                type: 'buttons', 
                variable: 'talento_servico', 
                options: [ 
                    { text: 'üõ†Ô∏è Sim, ofere√ßo um servi√ßo', value: 'servico', nextStep: 'transicao_nome', icon: 'wrench' }, 
                    { text: 'üè† Sim, tenho um im√≥vel', value: 'imovel', nextStep: 'transicao_nome', icon: 'home' }, 
                    { text: 'üõçÔ∏è Sim, vendo um produto', value: 'produto', nextStep: 'transicao_nome', icon: 'shopping-bag' }, 
                    { text: 'üí° Tenho uma ideia incr√≠vel', value: 'ideia', nextStep: 'transicao_nome', icon: 'lightbulb' }, 
                    { text: 'üòå N√£o, s√≥ quero curtir', value: 'nenhum', nextStep: 'transicao_nome', icon: 'smile' } 
                ],
                step: 5
            },
            
            'divulgador_1': { 
                message: "üöÄ Vamos fazer sua ideia brilhar como as estrelas de B√∫zios! O que voc√™ quer que todo mundo nesta cidade maravilhosa conhe√ßa?", 
                type: 'buttons', 
                variable: 'tipo_divulgacao', 
                options: [ 
                    { text: 'üõ†Ô∏è Um servi√ßo que presto', value: 'servico', nextStep: 'divulgador_2', icon: 'wrench' }, 
                    { text: 'üõçÔ∏è Um produto incr√≠vel', value: 'produto', nextStep: 'divulgador_2', icon: 'shopping-bag' }, 
                    { text: 'üè† Um im√≥vel dos sonhos', value: 'imovel', nextStep: 'divulgador_2', icon: 'home' }, 
                    { text: 'üéâ Um evento ou experi√™ncia', value: 'evento', nextStep: 'divulgador_2', icon: 'calendar' } 
                ],
                step: 2
            },
            
            'divulgador_2': { 
                message: "üéØ Perfeito! E para quem vamos contar essa novidade incr√≠vel? Quem vai se apaixonar pelo que voc√™ oferece?", 
                type: 'buttons', 
                variable: 'publico_alvo', 
                options: [ 
                    { text: '‚úàÔ∏è Turistas em busca de experi√™ncias', value: 'turistas', nextStep: 'divulgador_3', icon: 'plane' }, 
                    { text: 'üè† Moradores que vivem aqui', value: 'moradores', nextStep: 'divulgador_3', icon: 'home' }, 
                    { text: 'üåç Todo mundo, sem exce√ß√£o!', value: 'todos', nextStep: 'divulgador_3', icon: 'globe' }, 
                    { text: 'ü§î Preciso de ajuda para descobrir', value: 'indefinido', nextStep: 'divulgador_3', icon: 'help-circle' } 
                ],
                step: 3
            },
            
            'divulgador_3': { 
                message: "üìà Todo sonho tem sua jornada √∫nica. Em que momento m√°gico seu projeto est√° agora?", 
                type: 'buttons', 
                variable: 'estagio_projeto', 
                options: [ 
                    { text: 'üå± Acabando de nascer', value: 'inicio', nextStep: 'divulgador_4', icon: 'seed' }, 
                    { text: 'üöÄ Dando os primeiros voos', value: 'primeiros_passos', nextStep: 'divulgador_4', icon: 'rocket' }, 
                    { text: 'üí™ J√° estou no ritmo', value: 'ativo', nextStep: 'divulgador_4', icon: 'trending-up' }, 
                    { text: 'üìà Quero conquistar o mundo!', value: 'expansao', nextStep: 'divulgador_4', icon: 'target' } 
                ],
                step: 4
            },
            
            'divulgador_4': { 
                message: "üí´ Para criarmos uma estrat√©gia que realmente funcione, quanto voc√™ pode investir mensalmente para ver seu projeto florescer?", 
                type: 'buttons', 
                variable: 'investimento_mensal', 
                options: [ 
                    { text: 'üíµ At√© R$100', value: 'baixo', nextStep: 'transicao_nome', icon: 'dollar-sign' }, 
                    { text: 'üí∞ R$100 a R$300', value: 'medio', nextStep: 'transicao_nome', icon: 'dollar-sign' }, 
                    { text: 'üíé R$300 a R$700', value: 'alto', nextStep: 'transicao_nome', icon: 'gem' }, 
                    { text: 'üåü Acima de R$700', value: 'premium', nextStep: 'transicao_nome', icon: 'star' }, 
                    { text: 'ü§ù Prefiro conversar sobre isso', value: 'conversar', nextStep: 'transicao_nome', icon: 'message-circle' } 
                ],
                step: 5
            },
            
            'transicao_nome': { 
                message: "‚ú® Perfeito! Estou organizando tudo com muito carinho para criar algo verdadeiramente especial para voc√™. Antes de revelar a magia...", 
                type: 'transition', 
                nextStep: 'ask_name',
                step: 8
            },
            
            'ask_name': { 
                message: "üåü Como posso chamar voc√™? Me conta seu nome para tornar nossa conversa ainda mais especial!", 
                type: 'text', 
                variable: 'nome', 
                placeholder: 'Digite seu nome aqui...', 
                nextStep: 'ask_phone', 
                validation: 'text',
                step: 9
            },
            
            'ask_phone': { 
                message: "üì≤ E se eu encontrar aquela oportunidade √∫nica e perfeita para voc√™, qual o melhor WhatsApp para te enviar um al√¥ especial?", 
                type: 'tel', 
                variable: 'telefone', 
                placeholder: '(11) 99999-9999', 
                nextStep: 'generate_proposal', 
                validation: 'phone',
                step: 10
            },
            
            'generate_proposal': { 
                message: "üîÆ Conectando todos os pontos m√°gicos... Estou criando algo verdadeiramente especial e √∫nico para voc√™. A magia est√° acontecendo!", 
                type: 'loading', 
                action: 'callBackendForProcessing'
            },
            
            'final_message': { 
                type: 'final' 
            },
            
            'error_state': { 
                message: "üòÖ Ops! Minha conex√£o com a criatividade teve um pequeno solu√ßo. Mas n√£o se preocupe, vamos resolver isso juntos!", 
                type: 'buttons', 
                options: [ 
                    { text: 'üîÑ Tentar novamente', action: 'retry', nextStep: 'generate_proposal', icon: 'refresh-cw' }, 
                    { text: 'üè† Come√ßar do in√≠cio', action: 'restart', icon: 'home' } 
                ]
            }
        };
        
        // ========= FUN√á√ïES DE ESTADO =========
        function saveState() {
            try {
                localStorage.setItem(SESSION_KEY, JSON.stringify(state));
            } catch (e) {
                console.warn("N√£o foi poss√≠vel salvar a sess√£o:", e);
            }
        }

        function restoreState() {
            try {
                const savedState = localStorage.getItem(SESSION_KEY);
                if (savedState) {
                    state = JSON.parse(savedState);
                    return true;
                }
                return false;
            } catch (e) {
                console.warn("N√£o foi poss√≠vel restaurar a sess√£o:", e);
                localStorage.removeItem(SESSION_KEY);
                return false;
            }
        }

        function setState(newState) {
            state = { ...state, ...newState };
            saveState();
            updateProgressIndicator();
        }

        function pushHistory() {
            const currentStateSnapshot = JSON.parse(JSON.stringify(state));
            const newHistory = [...(state.history || []), currentStateSnapshot];
            setState({ history: newHistory });
        }
        
        // ========= FUN√á√ïES DE UI E ANIMA√á√ÉO =========
        function initializeDOMElements() {
            introPortal = document.getElementById('ai-intro-portal');
            appContainer = document.getElementById('app-container');
            portalActions = document.getElementById('portal-actions');
            typingTextEl = document.getElementById('intro-typing-text');
            chatWindow = document.getElementById('chat-window');
            inputArea = document.getElementById('input-area');
            backBtn = document.getElementById('back-btn');
            animatedSignature = document.getElementById('animated-signature');
            stepIndicator = document.getElementById('step-indicator');
            progressBar = document.getElementById('progress-bar');
            feedbackModal = document.getElementById('feedback-modal');
            feedbackContent = document.getElementById('feedback-content');
        }

        function typeWriter(text, i = 0, onComplete) {
            clearTimeout(typingTimeout);
            if (i < text.length && typingTextEl) {
                currentTypingText = text.substring(0, i + 1);
                typingTextEl.innerHTML = currentTypingText;
                typingTimeout = setTimeout(() => typeWriter(text, i + 1, onComplete), 80);
            } else if (onComplete) {
                onComplete();
            }
        }

        function cyclePhrases() {
            if (phraseIndex < immersivePhrases.length) {
                typeWriter(immersivePhrases[phraseIndex], 0, () => {
                    typingTimeout = setTimeout(() => {
                        phraseIndex = (phraseIndex + 1) % immersivePhrases.length;
                        cyclePhrases();
                    }, 4500);
                });
            }
        }

        function createParticles() {
            const container = document.getElementById('particle-container');
            if (!container || container.children.length > 0) return;
            
            for (let i = 0; i < 35; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                const size = Math.random() * 6 + 2;
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                particle.style.left = `${Math.random() * 100}%`;
                particle.style.top = `${Math.random() * 100}%`;
                particle.style.animationDuration = `${Math.random() * 20 + 15}s`;
                particle.style.animationDelay = `${Math.random() * 10}s`;
                container.appendChild(particle);
            }
        }

        function updateProgressIndicator() {
            const currentStep = state.currentStep || 1;
            const totalSteps = state.totalSteps || 10;
            const progress = Math.min((currentStep / totalSteps) * 100, 100);
            
            if (progressBar) {
                progressBar.style.width = `${progress}%`;
            }
            
            if (stepIndicator) {
                const stepText = currentStep <= totalSteps ? 
                    `Conversando ‚Ä¢ Etapa ${currentStep} de ${totalSteps}` : 
                    'Conversa finalizada';
                stepIndicator.textContent = stepText;
            }
        }

        function showTypingIndicator(show) {
            const existing = document.getElementById('typing-indicator');
            if (existing) existing.remove();
            
            if (show && chatWindow) {
                const indicator = document.createElement('div');
                indicator.id = 'typing-indicator';
                indicator.className = 'chat-bubble ai typing-indicator';
                indicator.innerHTML = '<span></span><span></span><span></span>';
                chatWindow.appendChild(indicator);
                scrollToBottom();
            }
        }

        function addMessageToChat(text, sender, isRestored = false) {
            if (!chatWindow) return;
            
            const messageEl = document.createElement('div');
            messageEl.className = `chat-bubble ${sender}`;
            
            // Processar texto para permitir emojis e formata√ß√£o
            const processedText = text
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/\n/g, "<br>")
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>');
                
            messageEl.innerHTML = processedText;
            
            if (!isRestored) {
                messageEl.style.opacity = '0';
                messageEl.style.transform = 'translateY(20px)';
            }
            
            chatWindow.appendChild(messageEl);
            
            if (!isRestored) {
                // Animar entrada da mensagem
                requestAnimationFrame(() => {
                    messageEl.style.transition = 'all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                    messageEl.style.opacity = '1';
                    messageEl.style.transform = 'translateY(0)';
                });
                
                setState({ chatLog: [...state.chatLog, { text, sender }] });
            }
            
            scrollToBottom();
        }

        function scrollToBottom() {
            if (chatWindow) {
                requestAnimationFrame(() => {
                    chatWindow.scrollTop = chatWindow.scrollHeight;
                });
            }
        }

        function disableAllInputs(shouldDisable) {
            const elements = document.querySelectorAll('button:not([data-system]), input');
            elements.forEach(el => {
                el.disabled = shouldDisable;
            });
            setState({ isWaitingForResponse: shouldDisable });
        }

        function showFeedback(type, title, message, autoClose = true) {
            if (!feedbackModal || !feedbackContent) return;
            
            const iconMap = {
                success: 'check-circle',
                error: 'x-circle',
                info: 'info'
            };
            
            const colorMap = {
                success: 'text-green-500',
                error: 'text-red-500',
                info: 'text-blue-500'
            };
            
            feedbackContent.innerHTML = `
                <div class="mb-4">
                    <i data-lucide="${iconMap[type]}" class="w-12 h-12 mx-auto ${colorMap[type]} mb-3"></i>
                    <h3 class="text-lg font-semibold text-slate-800 mb-2">${title}</h3>
                    <p class="text-slate-600">${message}</p>
                </div>
            `;
            
            feedbackModal.classList.remove('opacity-0', 'pointer-events-none');
            feedbackModal.classList.add('opacity-100', 'pointer-events-auto');
            
            lucide.createIcons();
            
            if (autoClose) {
                setTimeout(() => {
                    feedbackModal.classList.add('opacity-0', 'pointer-events-none');
                    feedbackModal.classList.remove('opacity-100', 'pointer-events-auto');
                }, 3000);
            }
        }
        
        // ========= L√ìGICA DA CONVERSA =========
        function displayStep(stepId, context = {}) {
            const step = conversationFlow[stepId];
            if (!step) {
                console.error(`Passo "${stepId}" n√£o encontrado.`);
                return;
            }
            
            setState({ 
                currentStepId: stepId,
                currentStep: step.step || state.currentStep
            });
            
            const isPortalStep = stepId === 'start';
            const targetContainer = isPortalStep ? portalActions : inputArea;
            
            if (!targetContainer) {
                console.error('Container n√£o encontrado');
                return;
            }
            
            targetContainer.innerHTML = '';
            
            if (isPortalStep) {
                if (state.chatLog.length === 0) {
                    addMessageToChat(step.message, 'ai');
                }
            } else {
                showTypingIndicator(true);
            }

            const delay = isPortalStep ? 100 : 1500;
            setTimeout(() => {
                if (!isPortalStep) {
                    showTypingIndicator(false);
                    if (step.message) {
                        addMessageToChat(step.message, 'ai');
                    }
                }
                renderInputs(step, context, targetContainer);
                
                const isAutoStep = step.type === 'loading' || step.type === 'transition';
                if (isAutoStep) {
                    if (step.action === 'callBackendForProcessing') {
                        callBackendForProcessing();
                    } else if (step.nextStep) {
                        setTimeout(() => displayStep(step.nextStep), 2000);
                    }
                } else {
                    disableAllInputs(false);
                }
                updateControls();
            }, delay);
        }

        function renderInputs(step, context, container) {
            if (!container) return;
            
            const isPortalStep = state.currentStepId === 'start';
            
            switch (step.type) {
                case 'buttons':
                    renderButtons(step, container, isPortalStep);
                    break;
                case 'text':
                case 'tel':
                    renderTextInput(step, container);
                    break;
                case 'final':
                    renderFinalMessage(context, container);
                    break;
                case 'loading':
                    renderLoadingMessage(container);
                    break;
            }
            
            if (!isPortalStep) scrollToBottom();
        }

        function renderButtons(step, container, isPortalStep) {
            let html = '';
            
            if (isPortalStep) {
                html += `
                    <div class="text-slate-200 text-base mb-6">
                        <i data-lucide="sparkles" class="w-5 h-5 inline mr-2"></i>
                        Para come√ßar nossa jornada, escolha sua categoria:
                    </div>
                `;
            }
            
            const wrapperClass = isPortalStep ? 
                'btn-group-mobile flex flex-col sm:flex-row gap-4 justify-center' : 
                'flex flex-col gap-3';
                
            const buttonClass = isPortalStep ? 
                'btn-enhanced btn-portal text-white font-semibold px-8 py-4 rounded-xl text-center transition-all duration-300' : 
                'btn-enhanced btn-chat w-full text-left p-4 rounded-xl border border-gray-200 hover:border-blue-600 transition-all duration-300';
            
            const buttonsHTML = step.options.map(opt => {
                const iconHtml = opt.icon ? `<i data-lucide="${opt.icon}" class="w-5 h-5 ${isPortalStep ? 'mr-2' : 'mr-3'}"></i>` : '';
                const value = opt.value || opt.text;
                const actionAttr = opt.action ? ` data-action="${opt.action}"` : '';
                
                return `
                    <button 
                        onclick="handleUserAction('button', {text: '${opt.text.replace(/'/g, "\\'")}', value: '${value}', nextStep: '${opt.nextStep || ''}', variable: '${step.variable || ''}', action: '${opt.action || ''}'})" 
                        class="${buttonClass}"
                        aria-label="${opt.text}"${actionAttr}>
                        <span class="flex items-center ${isPortalStep ? 'justify-center' : 'justify-start'}">
                            ${iconHtml}
                            <span>${opt.text}</span>
                        </span>
                    </button>
                `;
            }).join('');
            
            html += `<div class="${wrapperClass}">${buttonsHTML}</div>`;
            container.innerHTML = html;
            
            // Inicializar √≠cones do Lucide
            lucide.createIcons();
        }

        function renderTextInput(step, container) {
            const inputType = step.type === 'tel' ? 'tel' : 'text';
            const iconName = step.type === 'tel' ? 'phone' : 'user';
            
            container.innerHTML = `
                <form onsubmit="handleUserAction('form', {event: event, nextStep: '${step.nextStep}', variable: '${step.variable}', validation: '${step.validation}'}); return false;" 
                      class="flex space-x-3">
                    <div class="flex-1 relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i data-lucide="${iconName}" class="w-5 h-5 text-gray-400"></i>
                        </div>
                        <input 
                            type="${inputType}" 
                            id="text-input" 
                            required 
                            class="w-full pl-12 pr-4 py-4 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300" 
                            placeholder="${step.placeholder}"
                            aria-label="${step.message}">
                    </div>
                    <button 
                        type="submit" 
                        class="btn-enhanced btn-primary px-6 py-4 rounded-xl font-semibold transition-all duration-300"
                        aria-label="Enviar resposta">
                        <i data-lucide="send" class="w-5 h-5"></i>
                    </button>
                </form>
            `;
            
            lucide.createIcons();
            
            const input = document.getElementById('text-input');
            if (input) {
                input.focus();
                
                // Permitir envio com Enter
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        const form = input.closest('form');
                        if (form) {
                            const submitEvent = new Event('submit', { bubbles: true, cancelable: true });
                            form.dispatchEvent(submitEvent);
                        }
                    }
                });
            }
        }

        function renderLoadingMessage(container) {
            container.innerHTML = `
                <div class="text-center py-6">
                    <div class="loading-spinner mx-auto mb-4"></div>
                    <p class="text-sm text-slate-600">
                        <i data-lucide="sparkles" class="w-4 h-4 inline mr-1"></i>
                        Criando sua experi√™ncia personalizada...
                    </p>
                </div>
            `;
            lucide.createIcons();
        }

        function renderFinalMessage(context, container) {
            const proposalCards = context.proposal ? context.proposal.split('\n\n').map((section, index) => {
                if (section.trim()) {
                    return `
                        <div class="bg-gradient-to-br from-white to-slate-50 p-6 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-shadow duration-300">
                            <div class="text-slate-700 leading-relaxed">${section.replace(/\n/g, '<br>')}</div>
                        </div>
                    `;
                }
                return '';
            }).join('') : '';

            container.innerHTML = `
                <div class="text-center space-y-6">
                    <div class="mb-6">
                        <div class="w-16 h-16 bg-gradient-to-br from-green-500 to-green-600 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i data-lucide="check" class="w-8 h-8 text-white"></i>
                        </div>
                        <h3 class="text-xl font-bold text-slate-800 mb-2">‚ú® Sua proposta est√° pronta!</h3>
                        <p class="text-slate-600">Criamos algo especial pensando em voc√™</p>
                    </div>
                    
                    ${proposalCards}
                    
                    <div class="flex flex-col sm:flex-row gap-3 justify-center pt-4">
                        <button 
                            onclick="shareProposta()" 
                            class="btn-enhanced btn-primary px-6 py-3 rounded-xl font-semibold">
                            <i data-lucide="share-2" class="w-4 h-4 mr-2"></i>
                            Compartilhar
                        </button>
                        <button 
                            onclick="handleRestart()" 
                            class="btn-enhanced btn-chat px-6 py-3 rounded-xl font-semibold">
                            <i data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i>
                            Nova Conversa
                        </button>
                    </div>
                </div>
            `;
            
            lucide.createIcons();
        }

        function handleUserAction(type, data) {
            if (state.isWaitingForResponse) return;
            
            disableAllInputs(true);
            pushHistory();

            if (state.currentStepId === 'start' && type === 'button') {
                // Mostrar assinatura e fazer transi√ß√£o
                if (animatedSignature) animatedSignature.classList.add('visible');
                
                if (introPortal) {
                    introPortal.style.opacity = '0';
                    setTimeout(() => {
                        introPortal.style.display = 'none';
                        if (appContainer) {
                            appContainer.classList.remove('hidden');
                            appContainer.classList.add('flex');
                        }
                    }, 800);
                }
            }

            let value;
            let displayText;
            
            if (type === 'button') {
                value = data.value || data.text;
                displayText = data.text;
                
                if (data.action === 'retry') {
                    displayStep(data.nextStep);
                    return;
                } else if (data.action === 'restart') {
                    handleRestart();
                    return;
                }
            } else if (type === 'form') {
                if (data.event) data.event.preventDefault();
                
                const input = document.getElementById('text-input');
                if (!input) {
                    disableAllInputs(false);
                    return;
                }
                
                const originalPlaceholder = input.placeholder;
                value = input.value.trim();
                displayText = value;
                
                const validationType = data.validation;
                const validation = validateInput(value, validationType);
                
                if (!validation.isValid) {
                    showInputError(input, validation.message, originalPlaceholder);
                    disableAllInputs(false);
                    return;
                }
            }
            
            addMessageToChat(displayText, 'user');
            
            if (data.variable && value) {
                const cleanText = value.replace(/([\u2700-\u27BF]|[\uE000-\uF8FF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF]|[\u2011-\u26FF]|\uD83E[\uDD10-\uDDFF])/g, '').trim();
                const lastQuestion = state.chatLog.filter(m => m.sender === 'ai').pop()?.text || 'N/A';
                const userData = { ...state.userData, [data.variable]: cleanText };
                const userHistory = { ...state.userHistory, [data.variable]: { question: lastQuestion, answer: cleanText } };
                setState({ userData, userHistory });
            }
            
            if (data.nextStep) {
                displayStep(data.nextStep);
            }
        }

        function validateInput(value, validationType) {
            switch (validationType) {
                case 'text':
                    if (value.length < 2) {
                        return { isValid: false, message: 'Por favor, insira um nome v√°lido (m√≠nimo 2 caracteres).' };
                    }
                    break;
                case 'phone':
                    const phoneDigits = value.replace(/\D/g, '');
                    if (phoneDigits.length < 10 || phoneDigits.length > 11) {
                        return { isValid: false, message: 'Por favor, insira um telefone v√°lido com DDD.' };
                    }
                    break;
            }
            return { isValid: true };
        }

        function showInputError(input, message, originalPlaceholder) {
            input.style.borderColor = '#ef4444';
            input.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.1)';
            input.value = '';
            input.placeholder = message;
            
            // Efeito de shake
            input.style.animation = 'shake 0.5s ease-in-out';
            
            setTimeout(() => {
                input.style.borderColor = '';
                input.style.boxShadow = '';
                input.style.animation = '';
                input.placeholder = originalPlaceholder;
            }, 3000);
        }

        // ========= CONTROLES DE SESS√ÉO =========
        function handleRestart() {
            // Mostrar confirma√ß√£o
            if (confirm('Tem certeza que deseja reiniciar a conversa? Todas as informa√ß√µes ser√£o perdidas.')) {
                localStorage.removeItem(SESSION_KEY);
                location.reload();
            }
        }

        function handleGoBack() {
            if (state.history.length < 2) return;
            
            const previousState = state.history[state.history.length - 2];
            state = JSON.parse(JSON.stringify(previousState));
            state.history.pop();
            saveState();

            rebuildUIFromState();
            displayStep(state.currentStepId);
        }

        function updateControls() {
            if (backBtn) {
                backBtn.disabled = state.history.length < 2;
            }
        }

        function rebuildUIFromState() {
            if (chatWindow) {
                chatWindow.innerHTML = '';
                state.chatLog.forEach(msg => addMessageToChat(msg.text, msg.sender, true));
            }
        }

        // ========= FUN√á√ïES AUXILIARES =========
        function shareProposta() {
            const proposal = state.chatLog
                .filter(msg => msg.sender === 'ai')
                .pop()?.text || 'Proposta personalizada do Conex√£o B√∫zios';
                
            if (navigator.share) {
                navigator.share({
                    title: 'Minha proposta do Conex√£o B√∫zios',
                    text: proposal,
                    url: window.location.href
                }).catch(err => console.log('Erro ao compartilhar:', err));
            } else {
                // Fallback para c√≥pia
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(proposal).then(() => {
                        showFeedback('success', 'Copiado!', 'Proposta copiada para a √°rea de transfer√™ncia.');
                    }).catch(() => {
                        showFeedback('info', 'Copie manualmente', proposal);
                    });
                } else {
                    showFeedback('info', 'Sua proposta', proposal);
                }
            }
        }

        // ========= BACKEND =========
        async function callBackendForProcessing() {
            const userDataPayload = {
                nome: state.userData.nome || 'Usu√°rio',
                telefone: state.userData.telefone || '',
                perfil: state.userData.perfil || 'turista',
                historico: Object.values(state.userHistory || {})
            };
            
            console.log("Enviando para processamento:", userDataPayload);
            
            try {
                const response = await fetch(GOOGLE_APP_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ action: 'processAndSaveDossier', data: userDataPayload }),
                    mode: 'cors',
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    setState({ currentStep: 10 });
                    displayStep('final_message', { proposal: result.data.proposta_personalizada });
                } else {
                    throw new Error(result.error || 'Erro desconhecido');
                }
            } catch (error) {
                console.error("Falha na comunica√ß√£o com o backend:", error);
                showFeedback('error', 'Ops!', 'Houve um problema ao gerar sua proposta. Vamos tentar novamente?');
                displayStep('error_state');
            }
        }

        // ========= INICIALIZA√á√ÉO =========
        function init() {
            // Inicializar elementos DOM
            initializeDOMElements();
            
            // Verificar se h√° sess√£o salva
            if (restoreState() && state.currentStepId !== 'start') {
                if (introPortal) introPortal.style.display = 'none';
                if (appContainer) {
                    appContainer.classList.remove('hidden');
                    appContainer.classList.add('flex');
                }
                if (animatedSignature) animatedSignature.classList.add('visible');
                rebuildUIFromState();
                displayStep(state.currentStepId);
            } else {
                state = JSON.parse(JSON.stringify(initialState));
                saveState();
                if (chatWindow) chatWindow.innerHTML = '';
                if (appContainer) {
                    appContainer.classList.add('hidden');
                    appContainer.classList.remove('flex');
                }
                if (introPortal) {
                    introPortal.style.display = 'flex';
                    introPortal.style.opacity = '1';
                }
                if (animatedSignature) animatedSignature.classList.remove('visible');
                createParticles();
                cyclePhrases();
                displayStep('start');
            }
            
            // Inicializar √≠cones
            lucide.createIcons();
        }

        // ========= EVENT LISTENERS =========
        document.addEventListener('DOMContentLoaded', init);
        
        // Fechar modal ao clicar fora
        document.addEventListener('click', (e) => {
            if (e.target === feedbackModal) {
                if (feedbackModal) {
                    feedbackModal.classList.add('opacity-0', 'pointer-events-none');
                    feedbackModal.classList.remove('opacity-100', 'pointer-events-auto');
                }
            }
        });
        
        // Acessibilidade - ESC para fechar modal
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && feedbackModal && feedbackModal.classList.contains('opacity-100')) {
                feedbackModal.classList.add('opacity-0', 'pointer-events-none');
                feedbackModal.classList.remove('opacity-100', 'pointer-events-auto');
            }
        });
    </script>
</body>
</html>
